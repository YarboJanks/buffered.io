<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ASP.NET | OJ's perspective]]></title>
  <link href="http://buffered.io/categories/asp-dot-net/atom.xml" rel="self"/>
  <link href="http://buffered.io/"/>
  <updated>2013-12-28T08:12:06+10:00</updated>
  <id>http://buffered.io/</id>
  <author>
    <name><![CDATA[OJ Reeves]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[XSS Flaws via MVC Model Binding and Request.QueryString Inconsistencies]]></title>
    <link href="http://buffered.io/posts/xss-flaws-via-mvc-model-binding-and-request.querystring-inconsistencies/"/>
    <updated>2012-11-29T20:50:00+10:00</updated>
    <id>http://buffered.io/posts/xss-flaws-via-mvc-model-binding-and-request.querystring-inconsistencies</id>
    <content type="html"><![CDATA[<p>Forgive the title of the post, it was hard coming up with something succinct that captured the purpose of the post. This was inspired by a recent experience with a client who had this exact problem with one of their production systems.</p>

<h2>TL;DR</h2>

<p>Never use [Request.QueryString][] to access parameters in your views, even when you&rsquo;re sure your actions have validated them. You may open your application up to [XSS][] attacks. Always, <em>always</em> use data that is passed to your views via the <code>Model</code> or the [ViewData][] dictionary. Under no circumstances should you trust data coming in from the web, that includes query string parameters.</p>

<!--more-->


<h2>Setting the scene</h2>

<p>The application provided a certain function which allowed users to browse information tied to a number of entities. For the sake of this discussion let&rsquo;s say those entities were instances of a <strong>Person</strong>. The number of entities was extremely small, so it was decided that the interface would consist of a drop-down box consisting of all the entities. When that drop-down box was used a <em>change</em> event would fire using JavaScript that would modify the current URL and render a new page. That page would show the same drop-down list, with the appropriate entry selected, along with the information specfic to that entity.</p>

<p>Let&rsquo;s see some code starting with the &ldquo;details&rdquo; of the person:</p>

<p>{% codeblock Person.cs lang:csharp %}
public class Person
{</p>

<pre><code>public string Name { get;set; }
public int Age { get; set; }
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>Nothing too amazing there. Here&rsquo;s the parts of the page which renders the list of people:</p>

<p>{% codeblock Index.aspx (partial) lang:html %}
Please choose a person &lt;%= Html.DropDownList(&ldquo;people&rdquo;, Model) %></p>

<script type="text/javascript">
$(document).ready(function () {
  $("#people").change(function () {
    window.location = '<%= Url.Action("Detail", "Person") %>?index=' + $(this).val();
  });
});
</script>


<p>{% endcodeblock %}</p>

<p>Again, nothing too mind boggling here either. We can see how the <code>change</code> event fires and updates the <code>window.location</code> and moves the user to the <code>Details</code> page. The <code>Model</code> for this page is of type <code>IEnumerable&lt;SelectListItem&gt;</code>.</p>

<p>Next we&rsquo;ll take a look at the controller action which gets invoked when the drop-down is changed:</p>

<p>{% codeblock PersonController.cs (Partial) lang:csharp %}
public ActionResult Detail(int index)
{</p>

<pre><code>return View("Detail", Tuple.Create(People[index], GetPeople()));
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>We&rsquo;re using the <code>index</code> parameter (note the <em>type</em> of this parameter, it&rsquo;s important) to index into the list of people we have stashed somewhere to extract the user that is being viewed. This person, along with the full list of people in <code>SelectListItem</code> form, is being passed to the view.</p>

<p>Let&rsquo;s see what the view does with this information:</p>

<p>{% codeblock Detail.aspx (partial) lang:html %}
Please choose a person &lt;%= Html.DropDownList(&ldquo;people&rdquo;, Model.Item2) %></p>

<script type="text/javascript">
$(document).ready(function () {
  $("#people").val(<%= Request.QueryString["index"] %>);
  $("#people").change(function () {
    window.location = '<%= Url.Action("Detail", "Person") %>?index=' + $(this).val();
  });
});
</script>




<p><p>
&lt;%= Html.Encode(Model.Item1.Name) %> is a whopping &lt;%= Model.Item1.Age %> years old!
</p>
{% endcodeblock %}</p>

<p>This is starting to get a bit more interesting. The rendering of the drop-down is the same as before, except it&rsquo;s pulling data from the [System.Tuple][] that was passed in as the <code>Model</code>. The event handler that&rsquo;s invoked on <code>change</code> is the same, and there&rsquo;s a bit of non-descript content rendering a the bottom. The subtle but important difference is the code that sets the currently selected person in the drop-down.</p>

<p>I plugged this code into a standard MVC application and this is what it looks like:</p>

<p>{% img /uploads/2012/11/xss-index.png &lsquo;Choosing a person&rsquo; %}</p>

<p>After selecting a person from the drop down it looks like this:</p>

<p>{% img /uploads/2012/11/xss-details.png &lsquo;Person details&rsquo; %}</p>

<h2>A bad assumption</h2>

<p>As you already know, ASP.NET MVC has the ability to automatically convert query string parameters into type-safe arguments that are passed into the controller actions. In the above example the <code>index</code> query string parameter is converted to an <code>int</code> and passed into the <code>Details</code> action. If a user attempts to modify this value to something that isn&rsquo;t an integer then MVC will literally poop itself, right?</p>

<p>Let&rsquo;s see.</p>

<p>{% img /uploads/2012/11/xss-type-fail.png &lsquo;Person details&rsquo; %}</p>

<p>OK, so MVC will require that this value be an integer, otherwise the action will fail to be invoked. If that&rsquo;s the case, then the view won&rsquo;t be rendered and our code which directly accesses <code>Request.QueryString</code> will not be invoked and hence there&rsquo;s no risk.</p>

<p>Right?</p>

<p>[Wrong][HPP].</p>

<h2>The attack vector</h2>

<p>[HTTP Parameter Pollution][HPP] is a relatively &ldquo;new&rdquo; problem which revolves around the way that web servers/applications parse and handle multiple instances of the same GET/POST parameter. Phew!</p>

<p>In other words, if a malicious user decides to pass in <em>another</em> instance of the <code>index</code> parameter in the query string, what happens? The way this is handled varies from technology to technology (see [slide 9][HPPPDF] for some examples), but here we&rsquo;re only interested in ASP.NET with IIS and MVC.</p>

<p>Let me just state this again: we&rsquo;re only interested in ASP.NET and IIS <em><strong>and MVC</strong></em>. The reason we need to emphasise this is because MVC rocks the boat a little bit. It&rsquo;s important to remember that [Request.QueryString][] is not specific to MVC, it&rsquo;s something that lives in ASP.NET land. <em>Controller actions</em> on the other hand are not available across the board when using ASP.NET, they live in MVC land. When it comes to binding query string parameters to controller action method parameters, MVC doesn&rsquo;t behave how you would expect, and it&rsquo;s not the same as what happens when dealing with <code>Request.QueryString</code> directly.</p>

<p>So what happens in ASP.NET and IIS <em>without</em> MVC if an attacker passes in two values for the same parameter? Consider the following url: <code>http://foo.com/bar?baz=0&amp;baz=dooby</code></p>

<p>While in C# land (remember, outside of MVC) <code>Request.QueryString["baz"]</code> will contain a string value <code>0,dooby</code>. In our current environment any duplicate instances of query string values are passed through as a single value joined together by commas. This knowledge is scarily uncommon. Many .NET developers that I know are not aware of this behaviour.</p>

<p>This is where MVC comes along and sprays poop over everything.</p>

<p>ASP.NET MVC controller action method parameter binding doesn&rsquo;t handle multiple instance of the same query string parameters in the same way. In fact, it behaves more like JSP on Jetty: <strong>it only uses the first value and ignores the rest</strong>.</p>

<p>Why is this bad? Well this means that code outside of controller actions may result in different behaviour to that which is inside. More importantly, accessing <code>Request.QueryString</code> to get access to a parameter doesn&rsquo;t mean that you&rsquo;ll get the same value as what was handled in the controller action.</p>

<p>Let&rsquo;s take a look at what might happen if we threw multiple instances via the query string at our dodgy MVC application:</p>

<p>{% img /uploads/2012/11/xss-hpp-invalid.png &lsquo;HPP example&rsquo; %}</p>

<p>The above screenshot shows both the query string and the page source when we do this. That&rsquo;s right, MVC used the first value, set to <code>0</code>, without any issues and invoked the view engine. The view&rsquo;s assumption that the <code>index</code> parameter has been sanitised by the controller has now been proven unsafe. Now we can see that we do have access to the source. Let&rsquo;s see what happens if we went a step further and passed in a more sinister value:</p>

<p>{% img /uploads/2012/11/xss-hpp-valid.png &lsquo;HPP XSS exploit&rsquo; %}</p>

<p>Pwned.</p>

<h2>Conclusion</h2>

<p><em>Never</em> trust unsanitised input, that includes stuff that gets passed in through <code>Request.QueryString</code>. Do not assume that the contents are safe just because your controller action handled things without throwing an exception. If you&rsquo;re going to render data that has come in from the user or from the query string, delegate responsibility of validation to the controller action and only trust content which is passed to the view via [ViewData][] or the <code>Model</code>.</p>

<p>  [ViewData]: <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.viewpage.viewdata">http://msdn.microsoft.com/en-us/library/system.web.mvc.viewpage.viewdata</a>(v=vs.108).aspx
  [HPPPDF]: <a href="https://www.owasp.org/images/b/ba/AppsecEU09_CarettoniDiPaola_v0.8.pdf">https://www.owasp.org/images/b/ba/AppsecEU09_CarettoniDiPaola_v0.8.pdf</a>
  [Request.QueryString]: <a href="http://msdn.microsoft.com/en-us/library/ms524784">http://msdn.microsoft.com/en-us/library/ms524784</a>(v=vs.90).aspx
  [XSS]: <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">http://en.wikipedia.org/wiki/Cross-site_scripting</a>
  [System.Tuple]: <a href="http://msdn.microsoft.com/en-us/library/system.tuple.aspx">http://msdn.microsoft.com/en-us/library/system.tuple.aspx</a>
  [HPP]: <a href="http://blog.iseclab.org/2010/12/08/http-parameter-pollution-so-how-many-flawed-applications-exist-out-there-we-go-online-with-a-new-service/">http://blog.iseclab.org/2010/12/08/http-parameter-pollution-so-how-many-flawed-applications-exist-out-there-we-go-online-with-a-new-service/</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASP.NET MVC 2, Random Sign-offs and TempData Loss]]></title>
    <link href="http://buffered.io/posts/asp-net-mvc-2-random-sign-offs-and-tempdata-loss/"/>
    <updated>2010-10-06T08:39:00+10:00</updated>
    <id>http://buffered.io/posts/asp-net-mvc-2-random-sign-offs-and-tempdata-loss</id>
    <content type="html"><![CDATA[<p><a title="MVC" href="http://buffered.io/uploads/2010/10/mvc.png" rel="lightbox[contentadvisor]"><img style="margin-left: 5px; margin-bottom: 5px; float: right;" src="http://buffered.io/uploads/2010/10/mvc.png" alt="MVC" width="150" /></a>In the last few days I&rsquo;ve been working on resolving issues in a production system which runs on <a title="What is ASP.NET MVC" href="http://www.asp.net/mvc/whatisaspmvc">ASP.NET MVC 2</a>. Most of the issues were actually really easy to resolve and the team of developers were able to fix them and deploy to production without too many problems.</p>

<p>Unfortunately, as always, there was one problem in particular that had us scratching our heads and was causing some of us to lose sleep. All over the Internet there were posts of people describing similar symptoms yet none of them revealed a solid answer.</p>

<p>The purpose of this post is to document the issue and the resolution in it&rsquo;s entirety. It&rsquo;s in story form rather than reference form because that&rsquo;s how I felt like writing it :)</p>

<!--more-->


<h2>The Issue</h2>

<p>First of all, the percentage of users that were experiencing this problem was relatively low, less than 1 in every 400. This is low enough to indicate that we were going to have one hell of a time finding the issue.</p>

<p>So what was the issue?</p>

<p>The <strong>entry-point</strong> to the site was the <strong>sign-in</strong> page. This is the first page that the user sees. In short, users would sign in to the site and be presented with the landing page in the authenticated area of the site. As soon as they attempted to click on <em>any</em> link inside the authenticated area they were <strong>immediately sent back to the sign-in page</strong>.</p>

<h2>The Investigation</h2>

<p>After adding some more logging functionality to the application and talking to one of our users, we were able to see some really odd behaviour. The user would sign-in, again they were presented with their landing page. Before the user clicked on anything else, we could see that the system had recorded that the browser had <strong>already invoked the sign-off functionality</strong>.</p>

<p>Not good. Thankfully our logging was able to point the finger at a particular action on the site which was causing the user to be signed off. For business and security reasons, the sign-in page had some code that detected if the user was already signed in and, if so, would immediately sign them off. The main driver was to prevent users from <em>thinking</em> that they had signed off from the application and then walk away without realising that their session was still available.</p>

<p>This didn&rsquo;t make sense. The user was clearly not returning to the sign-in page, but for some reason the system thought they were and hence was signing them off.</p>

<p>Emulating this at the office was proving to be impossible. We weren&rsquo;t able to reproduce it in <em>any</em> of our environments, and according to our help desk, none of the users claimed to be using any tools, plug-ins or add-ins which may be interfering with their sessions.</p>

<p>We searched the <a href="http://google.com/">usual</a> <a href="http://stackoverflow.com/">haunts</a> for answers, but none came up. A post here and there would get our hopes up, but we would eventually have them dashed after realising that the resolution mentioned was something that was already place. Some of the common suggestions are:</p>

<ul>
<li>Make sure that the <a title="Machine Key Explained" href="http://msdn.microsoft.com/en-us/library/ff649308.aspx#paght000007_machinekeyexplained">machine key</a> is the same across all sites in the web farm.</li>
<li>Make sure that the <a title="ASP.NET &amp; IIS Website Load Balancing" href="http://knol.google.com/k/kishore-gorjala/asp-net-iis-website-load-balancing/3jdbfde3g5y2c/3#">IIS site identifier</a> is the same across all sites in the web farm.</li>
<li>Make sure that the cookie path was set to <code>/</code> instead of having a sub-path like <code>/mysite</code>.</li>
<li>Make sure that the user&rsquo;s browser was accepting cookies.</li>
</ul>


<p>While point 4 was indeed a problem for some users, it wasn&rsquo;t the golden bullet we were looking for.</p>

<p>We spun the wheels for a few days trying to come up with potential reasons why this could be the case. One of the developers suggested that it could be an issue with applications that operate as download accelerators. This application might scrape the screen when the user has signed in, and in an effort to pre-cache the next potential click it <a title="HTTP Request Methods" href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">GET</a>s each link that it finds on screen. It turns out that this wasn&rsquo;t, nor couldn&rsquo;t, be the issue: we were not including any links to the sign-on page anywhere in the authenticated area of the site.</p>

<h2>The First Shot</h2>

<p>We decided to take a shot in the dark and remove the functionality from the sign-in page which logs the users off. Instead, we present them with a notice which tells them that they are already signed-in. After deploying to production, our users were able to sign in! We were leaping for joy, though frustrated because we didn&rsquo;t know why this was a problem in the first place.</p>

<p>Our joy was short-lived. The application itself provides a series of wizards that the user can utilise to perform certain tasks. <em>All</em> of the users who had problems signing in were having unexpected errors shown when using the wizards. Something was still amiss.</p>

<p>We were at a loss. So we decided to call in the cavalry: our poor users.</p>

<h2>The Site Visit</h2>

<p>We got in contact with one user, a lady who had been completely unable to interact with the site since its release, and she graciously accepted our request to pay her a visit and allow us to witness the failure in action. This proved to be a <strong>very</strong> good move as you&rsquo;ll soon see.</p>

<p>After the initial meet and greet, I was given access to our client&rsquo;s network. At first, I wanted to plug my own personal laptop in to the network to see if I could reproduce the problem without having to touch the client&rsquo;s machine. It wasn&rsquo;t to be, as  everything worked perfectly for me.</p>

<p>I requested access to the client&rsquo;s machine and fired up her browser of choice (<a title="Internet Explorer" href="http://www.microsoft.com/windows/internet-explorer/default.aspx">yuck</a>). As soon as I hit the site, I was presented with a dialog asking for a password. Here is what it looked like:</p>

<p><a title="The Content Advisor Prompt" href="http://buffered.io/uploads/2010/10/content-advisor-prompt.png" rel="lightbox[contentadvisor]"><img style="margin-right: 5px; margin-bottom: 5px; float: left;" src="http://buffered.io/uploads/2010/10/content-advisor-prompt.png" alt="The Content Advisor Prompt" width="250" /></a>I had never seen this before, so I asked the client what it was. Her response:</p>

<blockquote><p>Oh, that&rsquo;s the content advisor that my husband set up. We have that enabled on all our computers so that only me and my husband can get to certain websites.</blockquote></p></blockquote>

<p><a title="Microsoft Content Advisor" href="http://www.microsoft.com/windows/ie/using/howto/security/contentadv/config.mspx">Content Advisor</a>? Why had I never heard of this before? After literally <em>years</em> of building production websites, I had never once encountered this beast. Yet here it was in front of me on screen, like a smart-arse teenager giving me the bird, and according to the dates on some of the articles on the web it has been around for quite a few years.</p>

<p>I proceeded to sign in to the site and attempt to perform an action using the wizard. As expected, it failed miserably. I then asked the client to disable the Content Advisor to see if it made any difference.</p>

<p>It did. The site performed <em>flawlessly</em>.</p>

<h2>The Resolution</h2>

<p>So the Content Advisor was causing problems. But how? What was it doing behind the scenes that was preventing our users from getting the quality experience that we&rsquo;d worked so hard to deliver?</p>

<p>Now that we had knowledge of the content advisor our queries to the Interwebs resulting in more revealing posts, such as one posted on <a title="IE's Content Advisor, PICS Ratings and the ASP.NET Flakey of the Day" href="http://www.hanselman.com/blog/IEsContentAdvisorPICSRatingsAndTheASPNETFlakeyOfTheDay.aspx">Scott Hanselman&rsquo;s blog</a>. Here are some key bits of information from that post:</p>

<blockquote><p>&hellip; when Content Advisor is OFF, the interaction looks like this:<br/></p>

<p>HTTP GET /somefile.aspx<br/>
RESPONSE 200<br/>
HTTP GET /somethingelse.aspx (we did a javascript.open)<br/>
RESPONSE 302 getthisfile.aspx<br/>
HTTP GET getthisfile.aspx<br/>
RESPONSE 200<br/></p>

<p>But when <strong>Content Advisor is ON</strong>, we see this:<br/></p>

<p>HTTP GET /somefile.aspx<br/>
RESPONSE 200<br/>
HTTP GET /somethingelse.aspx (we did a javascript.open)<br/>
<strong>HTTP GET /<br/>
RESPONSE 200</strong><br/>
RESPONSE 302 getthisfile.aspx<br/>
HTTP GET getthisfile.aspx<br/>
RESPONSE 200<br/></p>

<p>&hellip;<br/></p>

<p>When the Content Advisor is ON, Internet Explorer will request &lsquo;/&rsquo; from a site anytime a new window is opened.</p></blockquote>

<p>As we can see from the above quote, the Content Advisor hits the root of the site on the user&rsquo;s behalf in an effort to scrape <a title="Platform for Internet Content Selection" href="http://en.wikipedia.org/wiki/Platform_for_Internet_Content_Selection">PICS</a> information about the website.</p>

<p>According to the last point in the above quote, this will happen any time a new window is opened. Unfortunately for us, it goes deeper than that: <strong>the Content Advisor makes the browser request <code>/</code> every single time an action is invoked if it can&rsquo;t find sufficient PICS information for the current URL</strong>.</p>

<p>Yes, it&rsquo;s shit, but that&rsquo;s the way it works.</p>

<p>So any users which have the Content Advisor turned on will actually be hitting the site twice for every GET action they perform. This explains why the users were being signed off! Our sign-off code was being executed behind the scenes without the users being aware of it.</p>

<p>But why was it causing unexpected errors when clients were using the wizard? To answer that, we need to know about a little feature of MVC called <a title="TempData @ you've been HAACKED" href="http://haacked.com/tags/TempData/default.aspx">TempData</a>.</p>

<p>For those who don&rsquo;t want to click the above link, TempData is a feature of ASP.NET MVC which allows information to be persisted across post-backs to the server. A classic example is when URI <code>/Foo</code> gets invoked, and the action results in a redirect to <code>/Bar</code>. But <code>/Bar</code> requires some data that got sent to <code>/Foo</code>, so the <code>/Foo</code> action stores that data in the TempData dictionary which allows <code>/Bar</code> to get access to it during processing. It&rsquo;s a nifty feature, and one that we use extensively.</p>

<p>The key piece of information to remember about TempData is that it <em>only persists data across a single post-back</em>. That means that if you post back to the server once, TempData is lost unless the target action <strong>explicitly requests for it to stick around</strong>.</p>

<p>This is the deal-breaker. If <code>/Bar</code> assumes that TempData contains information from <code>/Foo</code> when it fires up then <code>/Bar</code> is going to break if the information is <em>not</em> there. Why would it not be there if a redirect happened? That&rsquo;s right, the f$%#ing Content Advisor!</p>

<p>It turns out that every time the Content Advisor hits the root of the site, TempData is cleared. This is obvious in hindsight because the root URI is an <a title="ASP.NET MVC Controller Overview" href="http://www.asp.net/mvc/tutorials/asp-net-mvc-controller-overview-cs">action</a> just like any other anywhere in the whole site. That action gets invoked through the same means and comes with the same caveats &hellip; including that of TempData getting cleared unless we ask it not to. So the chain of events looked like this:</p>

<ul>
<li>User invokes a wizard via a simple click.</li>
<li>Request is set to the server for<code>/Foo</code></li>
<li><code>/Foo</code> gets executed and stores information, <code>Baz</code>, in TempData so that the next step in the wizard, <code>/Bar</code>, can get access to it.</li>
<li><code>/Foo</code> returns page content to the user.</li>
<li>The browser receives the page content from the <code>/Foo</code> action and the Content Advisor notices a lack of PICS information in the HTTP headers and META tags.</li>
<li>The Content Advisor forces the browser to make a request to <code>/</code> in an attempt to find the missing PICS information.</li>
<li>The root site action is hit and it renders the sign-on page content.</li>
<li>At the end of page content generation, the TempData dictionary notices that no requests have been made to retain any of the information across another call, and hence <strong>all of the TempData information is lost</strong>, including <code>Baz</code>.</li>
<li>The user click&rsquo;s &ldquo;Next&rdquo; in the wizard, which causes the browser to invoke the <code>/Bar</code> action on the server.</li>
<li>The server invokes <code>/Bar</code> and the first thing it does is attempt to pull <code>Baz</code> out of TempData. <code>Baz</code> ends up being null.</li>
<li>Game over, Red Rover.</li>
</ul>


<p>There are quite a few issues that were highlighted as a result, but the key one is this: <em>you can&rsquo;t assume that your users aren&rsquo;t using some form of Content Advisor which is hitting your server with unexpected requests</em>. In our case, the resolution was simple. We just had to add a couple of lines to our root action:</p>

<p>{% codeblock lang:csharp %}
public ActionResult SignOn()
{
  if(Request.IsAuthenticated)
  {</p>

<pre><code>// force the TempData dicionary to keep hold
// of the information it has in case this
// action is being hit by a Content Advisor.
TempData.Keep();
</code></pre>

<p>  }
  // rest of the action code
  // &hellip;
  return View(&hellip;);
}
{% endcodeblock %}</p>

<h2>Conclusion</h2>

<p>The first question you might ask is: why didn&rsquo;t you just add PICS data to your site to prevent the Content Advisors from behaving that way? The short answer is that you can&rsquo;t guarantee that the Content Advisors will adhere to the &ldquo;rules&rdquo;, especially given that there don&rsquo;t appear to be any.</p>

<p><a title="Platform for Internet Content Selection" href="http://en.wikipedia.org/wiki/Platform_for_Internet_Content_Selection">PICS</a> has already been replaced with <a title="Protocol for Web Description Resources" href="http://en.wikipedia.org/wiki/POWDER">POWDER</a>. But POWDER doesn&rsquo;t appear to be used anywhere, and there&rsquo;s very little information around on it. Attempting to support all possible half-baked standards would result in serving up a great deal more content for the sake of a very small subset of users who actually use Content Advisors. It made much more sense to just persist TempData across one more call.</p>

<p>Bear in mind that while the Content Advisor is built-in to the Internet Options area in Windows, it&rsquo;s not specific to Internet Explorer. Both Chrome and Safari are affected by the Content Advisor if it is enabled!</p>

<p>So for anyone out there who is building, or has built, a public-facing website using ASP.NET MVC please bear this in mind. Keep an eye on your TempData usage, make sure that your root action persists your TempData if required, and avoid having that same action sign off your users.</p>

<p>I hope this helps someone :) Comments and feedback greatly appreciated.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How do you Interact with your ViewState?]]></title>
    <link href="http://buffered.io/posts/how-do-you-interact-with-your-viewstate/"/>
    <updated>2008-05-21T20:50:00+10:00</updated>
    <id>http://buffered.io/posts/how-do-you-interact-with-your-viewstate</id>
    <content type="html"><![CDATA[<p>There comes a time in every ASP.NET developer&rsquo;s life when the need arises for information to be persisted into <a href="http://msdn.microsoft.com/en-us/library/ms972976.aspx" title="ViewState">ViewState</a>. For the sake of this post I&rsquo;m not really interested in the reasons why. What I am interested in is <em>how</em>.</p>

<p>How do you interact with your ViewState?</p>

<!--more-->


<p>I&rsquo;ve seen two methods in use in the various codebases that I&rsquo;ve worked on. The first that I&rsquo;ll demonstrate is the most common form I&rsquo;ve seen.</p>

<p>Let&rsquo;s pretend we have a web form which has a property called <strong>MyMagicValue</strong> which needs to be stored across <a href="http://www.xefteri.com/articles/show.cfm?id=18" title="How postback works in ASP.NET">postbacks</a>.</p>

<p>Most developers would do something like this:
{% codeblock lang:csharp %}
protected int MyMagicValue
{</p>

<pre><code>get
{
    return (int)ViewState["MyMagicValue"];
}
set
{
    ViewState["MyMagicValue"] = value;
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>Information is stored directly in the ViewState hash/dictionary by accessing the ViewState property that exists on every web form/control. In this case there&rsquo;s a danger of things going horribly wrong &ldquo;get&rdquo; is invoked before &ldquo;set&rdquo;!</p>

<p>The second isn&rsquo;t so common. In fact, the only times I&rsquo;ve seen it in a codebase is when I&rsquo;ve implemented it myself. This leads me to believe that most of the time developers don&rsquo;t even know that this method exists. Here&rsquo;s the code:
{% codeblock lang:csharp %}
private int _myMagicValue;</p>

<p>protected int MyMagicValue
{</p>

<pre><code>get
{
    return _myMagicValue;
}
set
{
    _myMagicValue = value;
}
</code></pre>

<p>}</p>

<p>protected override object SaveViewState()
{</p>

<pre><code>object[] state = new object[2];
state[0] = _myMagicValue;
state[1] = base.SaveViewState();

return state;
</code></pre>

<p>}</p>

<p>protected override void LoadViewState(object savedState)
{</p>

<pre><code>if (savedState != null)
{
    object[] state = (object[])savedState;

    if (state.Length &gt; 0)
    {
        _myMagicValue = (int)state[0];
        base.LoadViewState(state[1]);
    }
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>Quite a bit different from the first version. But which one is better? Which is considered best practice? Which has the better performance?</p>

<p>I haven&rsquo;t done any extensive research into this topic other than chatting to a <a href="http://secretgeek.net/" title="secretGeek">workmate</a> or two. So I wouldn&rsquo;t say that I have hard data to back up what I&rsquo;m about to say.</p>

<p>It seems to me that the latter implementation is preferrable for the following reasons:</p>

<ol><li>Your page/control contains the usual definitions for container variables, just like most other classes without references to ViewState in every property definition.</li><li>You're not spreading references to ViewState all through your code.</li><li>You're not indexing into the ViewState hash for every since get/set for a given property.</li><li>If you want to add something else to the ViewState you can easily add it in the two overridden functions without affecting other areas of the code.</li><li>You don't have to worry about checking for <em>null</em> in the getters.</li><li>You could easily rip out the implementation and store in another class without a great deal of refactoring or code modification.</li></ol>


<p>The former is preferrable to many coders because:</p>

<ol><li>It's less code to write.</li><li>They don't know that the latter method exists.</li></ol>


<p>So what&rsquo;s the verdict? Which of these is better, or considered &ldquo;best practice&rdquo;?</p>

<p><strong>Edit:</strong> As per my comment below about using <a href="http://msdn.microsoft.com/en-us/library/system.web.ui.pair(VS.80).aspx" title="System.Web.UI.Pair">System.Web.UI.Pair</a>, I thought I would add an example of how this should be used. It&rsquo;s not overly pretty when you get more and more values to store, but I still prefer it to directly manipulating the ViewState object.
{% codeblock lang:csharp %}
protected override object SaveViewState()
{</p>

<pre><code>return new Pair(base.SaveViewState(), _myMagicValue);
</code></pre>

<p>}</p>

<p>protected override void LoadViewState(object savedState)
{</p>

<pre><code>if (savedState != null)
{
    Pair state = savedState as Pair;
    if(state != null)
    {
        base.LoadViewState(state.First);
        _myMagicValue = (int)state.Second;
    }
}
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>This doesn&rsquo;t look so bad with just a single value, but for each value you add to the ViewState you need another Pair instance.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[.NET MVC]]></title>
    <link href="http://buffered.io/posts/net-mvc/"/>
    <updated>2007-03-28T17:15:00+10:00</updated>
    <id>http://buffered.io/posts/net-mvc</id>
    <content type="html"><![CDATA[<p>Isn&rsquo;t it amazing how life can just hit turbo without prior warning, and your time seems to just disappear!  I need to find some way of sticking blogging back into my routine :)</p>

<p>For the last couple of weeks I&rsquo;ve been playing around a fair bit with <a href="http://www.ruby-lang.org/" title="Ruby" target="_blank">Ruby</a> and <a href="http://www.rubyonrails.org/" title="Ruby on Rails" target="_blank">Rails</a>.  I&rsquo;ve been having a great deal of fun at the same time, and I recommend it to any of you who are thinking of taking up some of your own time with learning web development.  It&rsquo;s really good fun, it&rsquo;s interesting, and it&rsquo;s a great platform for building web apps on.  Sure it has its pitfalls (as do all web development options), but it&rsquo;s a worthy contender and it&rsquo;s only going to get better.  More on that in another post ;)</p>

<p>The reason I mentioned it is because of the news that ASP.NET has an <a href="http://codebetter.com/blogs/jeffrey.palermo/archive/posts/Big-News-_2D00_-MVC-framework-for-ASP.NET-in-the-works-_2D00_-level-300.aspx">MVC framework in the works</a>, which looks like it&rsquo;s going to be very similar to the way Rails works.  I think this is a good thing as it&rsquo;ll force people to move away from an (possibly) unnecessary <a href="http://msdn.microsoft.com/msdnmag/issues/06/08/DesignPatterns/default.aspx" title="MVP" target="_blank">MVP</a> approach (for most things) and work with a well-structured <a href="http://en.wikipedia.org/wiki/Model-view-controller" title="MVC" target="_blank">MVC</a> (which a surprising amount of developers don&rsquo;t yet know about!).</p>

<p>No doubt this is another effort by Microsoft to rip off some code from <a href="http://www.castleproject.org/monorail/index.html" title="MonoRail" target="_blank">another established project</a> and claim it as their own, but still if it works and works well, then I&rsquo;m not really complaining.</p>

<p>Anyway, what do you guys think? Is this a good or a bad thing?</p>
]]></content>
  </entry>
  
</feed>
