<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Tips/Tricks | OJ's rants]]></title>
  <link href="http://buffered.io/categories/tips-tricks/atom.xml" rel="self"/>
  <link href="http://buffered.io/"/>
  <updated>2013-01-04T19:47:58+10:00</updated>
  <id>http://buffered.io/</id>
  <author>
    <name><![CDATA[OJ Reeves]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Setting up Trac, Mercurial and SSH on Windows]]></title>
    <link href="http://buffered.io/posts/setting-up-trac-mercurial-and-ssh-on-windows/"/>
    <updated>2009-05-16T17:43:00+10:00</updated>
    <id>http://buffered.io/posts/setting-up-trac-mercurial-and-ssh-on-windows</id>
    <content type="html"><![CDATA[<p><strong>WARNING - This blog post is long :)</strong>
<em>This post has been edited since it was published. Please see the end of the article for any notes/modifications</em></p>

<h3>Some Background Info</h3>


<p>I had the need to do this for work recently. It was nothing short of a right royal pain in the butt. It was such a pain, in fact, that I have decided to document what I had to do to get it working so that other poor unfortunates will feel less pain if they have to do this themselves.</p>

<p>Almost regardless of the company and the software I'm working on, I use <a href="http://www.selenic.com/mercurial/" title="Mercurial">Mercurial</a> for source code control. For the work I am doing at the moment, I was also using hg because the company I am involved with is relatively new and they hadn't yet sorted out a plan for version control or <acronym title="Application Lifecycle Management">ALM</acronym>. It was working quite well and I was pushing all my changes to my <a href="http://www.google.com.au/url?q=http://www.buffalotech.com/products/network-storage/terastation/terastation-iii/&ei=fioOSuLvGpu8swPl56zqAg&sa=X&oi=smap&resnum=1&ct=result&cd=2&usg=AFQjCNHXKMchy5tR-a-jMOFAbtxoWzfedA" title="Terastation">NAS box</a> to make sure I had other copies backed up, etc. I was <em>living the dream</em> :)</p>

<!--more-->


<p>The problem, though, was that this setup was working fine for me as a sole developer, but wasn't solving the problem for the other developers. There are two other people involved in development, and until now most of the work they have been doing has been in a different area to the bits I have been doing. Sharing and merging code was done by email patches. Those developers weren't using version control as far as I'm aware.</p>

<p>So given the volume of changes and the number of merges that were happening, it was well past time to get something proper in place that we could all use. The original plan was to go with an installation of <a href="http://en.wikipedia.org/wiki/Team_Foundation_Server" title="Team Foundation Server">TFS</a> to handle all of these issues for us. Personally, I am not a huge fan of TFS. The experience I've had with it so far hasn't been great. It also has a shocking effect on the speed of my IDE (I seem to have no choice but to use integration with the IDE, which again isn't great).</p>

<p>To cut this part of the story short, we had issues getting TFS to work. We tried installing a few times, tweaking here and there, but we never managed to get it to work. I know I could have called a TFS guru, such as <a href="http://stevennagy.spaces.live.com/" title="Steven Nagy">Snagy</a> to pick his brains and perhaps ask him nicely to help out, but he's a busy man and there's no guarantee that we wouldn't have to start again from scratch. I wasn't really up for that, and neither was my boss.</p>

<p>So I told him that I thought it might just be easier to get a server running with Mercurial for the version control, and <a href="http://trac.edgewall.org/" title="The Trac Project">Trac</a> for issue tracking and project "stuff". Not only would it mean that I could just push my local repository to the server and have the entire history transferred (TFS would have been latest version only) but it would save us a substantial cost in license fees, remove the need for VS integration, and everyone could be up and running with a <acronym title="Distributed Version Control System">DVCS</acronym> in no time.</p>

<p>My boss, being the legend he is, gave me the thumbs up! Awesome.</p>

<p>So the rest of this post is dedicated to what was involved in getting things set up. If you're not interested, then go read <a href="http://buffered.io/?random" title="Random post">something else</a> :)</p>

<h3>The need for a bit of security</h3>


<p>Needless to say, the <acronym title="Intellectual Property">IP</acronym> that we're building is something that my employer is rather protective of! And rightly so. Hence it won't come as a surprise to hear that security of this information is very important. I decided that having Mercurial run over plan old HTTP would be a bad idea. I was keen to have it tunnel via SSH, and have all clients authenticate using their own private keys. Hence, getting an SSH server was going to be part of the setup.</p>

<h3>Web server</h3>


<p>IIS is already installed on the server, and running another web server seemed like overkill. I didn't want to expose <a href="http://trac.edgewall.org/wiki/TracStandalone" title="Trac Standalone">tracd</a> directly over the web as it doesn't support SSL, so I wanted to get it running under IIS instead. This added another little bit of complexity to the install.</p>

<h3>What to download</h3>


<p>There were quite a few bits that I needed to download to get this working, they're listed below. At first it might not be obvious as to why these things are needed, just trust me :)</p>

<p>First, server-side components:</p>

<ol>
<li>Python 2.5.4 - Get this version, not anything earlier or later if you want this guide to work! (<a href="http://www.python.org/ftp/python/2.5.4/python-2.5.4.msi" title="Download Python">download</a>)</li>
<li>Setuptools (<a href="http://pypi.python.org/packages/2.5/s/setuptools/setuptools-0.6c9.win32-py2.5.exe#md5=602d06054ec1165e995ae54ac30884d7" title="Download setuptools">download</a>)</li>
<li>ClearSilver (<a href="http://www.clearsilver.net/downloads/win32/clearsilver-0.10.4-py2.5-win32.egg" title="Download ClearSilver">download</a>)</li>
<li>PySqlite (<a href="http://initd.org/pub/software/pysqlite/releases/2.4/2.4.1/pysqlite-2.4.1.win32-py2.5.exe" title="Download PySqlite">download</a>)</li>
<li>flup (<a href="http://www.saddi.com/software/flup/dist/flup-0.5-py2.5.egg" title="Download flup">download</a>)</li>
<li>Trac installer v0.11.4 (<a href="http://ftp.edgewall.com/pub/trac/Trac-0.11.4.win32.exe" title="Download Trac">download</a>)</li>
<li>Mercurial (<a href="http://mercurial.berkwood.com/binaries/Mercurial-1.2.1.exe" title="Download Mercurial">download</a>)</li>
<li>Subversion (<a href="http://www.collab.net/servlets/OCNDirector?id=CSVN1.6.2WINC" title="Download Subversion">download</a>)</li>
<li>Apache Tomcat AJP Isapi filter (<a href="http://www.apache.org/dist/tomcat/tomcat-connectors/jk/binaries/win32/jk-1.2.28/isapi_redirect-1.2.28.dll" title="Download isapi filter">download</a>)</li>
<li>Junction (<a href="http://technet.microsoft.com/en-us/sysinternals/bb896768.aspx" title="Download Junction">download</a>)</li>
<li>CopSSH (<a href="http://sourceforge.net/project/downloading.php?group_id=69227&filename=Copssh_2.1.0_Installer.zip&a=22655277" title="Download CopSSH">download</a>)</li>
<li>Windows Server 2003 Resource Kit (<a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=9D467A69-57FF-4AE7-96EE-B18C4790CFFD&displaylang=en" title="Download resource kit">download</a>)</li>
</ol>


<p>Next, client-side:</p>

<ol>
<li>Mercurial (<a href="http://mercurial.berkwood.com/binaries/Mercurial-1.2.1.exe" title="Download Mercurial">download</a>)</li>
<li>PuTTy (<a href="http://the.earth.li/~sgtatham/putty/latest/x86/putty-0.60-installer.exe" title="Download PuTTy">download</a>)</li>
</ol>


<p>Quite a lot isn't it :)</p>

<h3>Server: Setting up the Python Environment</h3>


<ol>
  <li>Execute the Python installer. This by default installs Python to C:\python25.</li>
  <li>Modify the environment variables so that the Python install folder is included in the PATH.</li>
  <li>Execute the Setuptools installer.</li>
  <li>Execute the PySqlite installer.</li>
  <li>Install the downloaded python eggs:</li>
  <ol>
    <li>Open a command prompt</li>
    <li>Navigate to the folder where your .egg files are downloaded to.</li>
    <li>in the command line, type: <strong>easy_install [filename.egg]</strong>.</li>
    <li>Do this for ClearSilver and flup.</li>
  </ol>
</ol>


<p>At this point, you should have a working installation of Python 2.5.4 with the required eggs and plug-ins.</p>

<h3>Server: Setting up Mercurial</h3>


<ol>
  <li>Execute the Mercurial installer. By default this installs to %programfiles%\Mercurial. Feel free to change this if you like.</li>
  <li>During the installation, the installer will ask if you want to include the install folder in the system PATH. Make sure you click "yes", otherwise you'll have to do it manually afterwards.</li>
</ol>


<p>The Mercurial client is now installed. Later on when installing Trac and getting it to work with Mercurial, I had issues because the Mercurial doesn't install the Mercurial bindings for Python. No only that, trying to use <em>easy_install</em> to install it didn't work because I didn't have Visual Studio 2003 installed on the server (nor did I want to install it!). It turns out that you can get round the issue by doing this:</p>

<ol>
  <li>Go to the Mercurial installation folder using Windows Explorer.</li>
  <li>Locate the file <strong>Library.zip</strong>.</li>
  <li>Open this file with an application like <a href="http://rarsoft.com/" title="WinRAR">WinRAR</a> or <a href="http://www.7-zip.org/" title="7-zip">7-zip</a> (using the built-in Windows zip functionality doesn't work!).</li>
  <li>Inside that archive there is a folder called <em>mercurial</em>. Extract this folder to a disk.</li>
  <li>Open another Windows Explorer and navigate to your Python installation directory (eg. C:\Python25). Open up the <em>Lib</em> sub0folder (that's <em>lib</em>, not <em>lib<strong>s</strong></em>).</li>
  <li>Copy or move the extracted <em>mercurial</em> folder to the <em>lib</em> folder.</li>
</ol>


<p>Done! You've just "installed" the Mercurial bindings for Python. Later down the track, Trac will not crap out when you try and use it!</p>

<h3>Server: Setting up TracMercurial</h3>


<p>Given that we're using Mercurial for the back-end version control, we're going to need to set up and install the Mercurial plugin for Trac. This is where the need for <acronym title="Subversion">SVN</acronym> comes in. Yes, it's ironic that you need SVN to get something working with Mercurial! Just do it, ok!?</p>

<ol>
  <li>Execute the Subversion installer and let it go through with the default installation.</li>
  <li>Make sure that the path to the SVN binaries is included in the system PATH environment variable.</li>
  <li>Open up a command prompt and change directory to a temporary location.</li>
  <li>run the command: <strong>svn co http://svn.edgewall.com/repos/trac/sandbox/mercurial-plugin-0.11</strong> - this gets the right version of the plug-in from source.</li>
  <li>run the command: <strong>cd mercurial-plugin-0.11</strong></li>
  <li>run the command: <strong>python setup.py bdist_egg</strong> - this creates an installable python egg.</li>
  <li>run the command: <strong>python setup.py install</strong> - this installs the plug-in to the global location.</li>
</ol>


<p>The TracMercurial plug-in is now installed. We'll need to configure it slightly when we've installed Trac. That information is listed in the next section.</p>

<p>Next we need to create a repository which will be used to house our source code. We'll pretend we're creating a project called "Slartibartfast".</p>

<ol>
  <li>Create a new folder on the file system somewhere meaningful, such as <strong>C:\Repos</strong>.</li>
  <li>Open a command window, and change directory to that folder.</li>
  <li>create a folder for your project: <strong>mkdir Slartibartfast</strong>.</li>
  <li>Change to that folder: <strong>cd Slartibartfast</strong>.</li>
  <li>Initialise the repository: <strong>hg init .</strong> (note the '.' at the end).</li>
</ol>


<p>Your repository is now ready for code!</p>

<h3>Server: Setting up Trac</h3>


<p>We'll start with the basic install:</p>

<ol>
  <li>Execute the Trac installer.</li>
  <li>Default installation settings are fine.</li>
  <li>It will be installed to the <em>scripts</em> folder under the Python installation folder.</li>
</ol>


<p>At this point it's a good idea to also add the <em>scripts</em> folder to the system PATH. This gives us the ability to run Python scripts from anywhere.</p>

<p>Next up, let's create a Trac project for our Slartitbartfast project.</p>

<ol>
  <li>Create a folder to house your Trac projects, say <strong>C:\Trac</strong></li>
  <li>Open a command window and change directory to your Trac projects folder.</li>
  <li>Create a folder for your new project: <strong>mkdir Slartibartfast</strong></li>
  <li>Change to that folder: <strong>cd Slartibartfast</strong>.</li>
  <li>Start the Trac administration application to start an interactive setup session: <strong>trac-admin . initenv</strong></li>
</ol>


<p>  You need to fill out some values as it asks for them. Here's a sample interactive session that I did as a test run:</p>

<pre><code>C:\Trac\Slartibartfast&gt;trac-admin . initenv
Creating a new Trac environment at C:\Trac\Slartibartfast

Trac will first ask a few questions about your environment
in order to initialize and prepare the project database.

 Please enter the name of your project.
 This name will be used in page titles and descriptions.

Project Name [My Project]&gt; Slartibartfast

 Please specify the connection string for the database to use.
 By default, a local SQLite database is created in the environment
 directory. It is also possible to use an already existing
 PostgreSQL database (check the Trac documentation for the exact
 connection string syntax).

Database connection string [sqlite:db/trac.db]&gt;

 Please specify the type of version control system,
 By default, it will be svn.

 If you don't want to use Trac with version control integration,
 choose the default here and don't specify a repository directory.
 in the next question.

Repository type [svn]&gt; hg

 Please specify the absolute path to the version control
 repository, or leave it blank to use Trac without a repository.
 You can also set the repository location later.

Path to repository [/path/to/repos]&gt; C:\Repos\Slartibartfast

Creating and Initializing Project
 Installing default wiki pages

**
** craploads of import statements go here **
**

---------------------------------------------------------------------
Warning: couldn't index the repository.

This can happen for a variety of reasons: wrong repository type,
no appropriate third party library for this repository type,
no actual repository at the specified repository path...

You can nevertheless start using your Trac environment, but
you'll need to check again your trac.ini file and the [trac]
repository_type and repository_path settings in order to enable
the Trac repository browser.


---------------------------------------------------------------------
Project environment for 'Slartibartfast' created.

You may now configure the environment by editing the file:

  C:\TracProjects\Slartibartfast\conf\trac.ini

If you'd like to take this new project environment for a test drive,
try running the Trac standalone web server `tracd`:

  tracd --port 8000 C:\TracProjects\Slartibartfast

Then point your browser to http://localhost:8000/Slartibartfast.
There you can also browse the documentation for your installed
version of Trac, including information on further setup (such as
deploying Trac to a real web server).

The latest documentation can also always be found on the project
website:

  http://trac.edgewall.org/

Congratulations!
</code></pre>

<p>You may notice the message: <em>Warning: couldn't index the repository.</em>
Don't be too concerned at this point, as we need to do a bit more to make sure that the Mercurial stuff is working.</p>

<p>Now we should test to make sure we're able to start the Trac daemon and see if the project site has been set up. We do that by executing the statement they suggested in the output:
<strong>tracd --port 8000 C:\TracProjects\Slartibartfast</strong>
Then we browse to <a href="http://localhost:8000">http://localhost:8000</a> to see if it works! If all goes well you should see a project listing. Click on Slartibartfast and you should see something like this:</p>

<p><a href="http://buffered.io/uploads/2009/05/trac_1.png"><img src="http://buffered.io/uploads/2009/05/trac_1.png" alt="Trac Project Page - with error." title="Trac Project Page - with error." width="640" height="347" /></a></p>

<p>Trac is telling us why it's not able to index the repository, it's because we haven't enabled the plug-in yet. Let's do that now.</p>

<p>Open up the <em>Trac.ini</em> file which is located inside the <em>conf</em> folder under the main project folder (eg <em>C:\Trac\Slartibartfast\conf\Trac.ini</em>).</p>

<p>First, add the following section to the ini file:</p>

<pre><code>[hg]
# -- Show revision number in addition to the changeset hash
show_rev = yes

# -- Changeset hash format
node_format = short
# hex:   Show the full SHA1 hash 
# short: Show a shortened hash for the changesets
</code></pre>

<p>Then enable the Mercurial plugin by adding the following:</p>

<pre><code>[components]
tracext.hg.backend.csetpropertyrenderer = enabled
tracext.hg.backend.hgdefaultpropertyrenderer = enabled
tracext.hg.backend.hgextpropertyrenderer = enabled
tracext.hg.backend.mercurialconnector = enabled
</code></pre>

<p><em>Note:</em>Make sure that the <kbd>[hg]</kbd> and <kbd>[components]</kbd> sections don't already exist. If they do, then add the respective lines to the existing sections rather than creating new ones. For a fresh install, these sections shouldn't already exist, so you should be safe to add them.</p>

<p>Kill the tracd instance by press CTRL+C, then restart it (press the up arrow, then enter). Refresh your browser window and this time you should see this:</p>

<p><a href="http://buffered.io/uploads/2009/05/trac_2.png"><img src="http://buffered.io/uploads/2009/05/trac_2.png" alt="Trac Project Page - without error." title="Trac Project Page - without error." width="640" height="372" /></a></p>

<p>Excellent, our project is up and our repository is able to be read. We're done!</p>

<h3>Server: Setting up the Trac Daemon as a Service</h3>


<p>The tracd needs to run as a service. This is to make sure it's always running in a way that IIS can reference it. Given that we're later going to be hooking this up to IIS, we need to make sure it uses the <a href="http://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html" title="AJP Reference">AJP</a> protocol. Here are the required steps:</p>

<ol>
  <li>Install the Windows 2003 resource kit.</li>
  <li>Open a command window, and navigate to where the resource kit binaries are installed. On my system that was at <em>C:\Program Files\Windows Resource Kits\Tools</em></li>
  <li>Create a service called "Trac" by executing the following command: <strong>InstSrv Trac "C:\Program Files\Windows Resource Kits\Tools\SrvAny.exe"</strong> - (note the use of the full path is necessary for this to work).</li>
  <li>Next we need to hack the registry a little to pass the right parameters and have the tracd started.
<ol>
  <li>Open regedit.</li>
  <li>Go to <strong>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Trac</strong></li>
  <li>Create a new sub-key called <strong>Parameters</strong></li>
  <li>Inside this new sub-key, create two new values:
  </li>
<ol>
  <li><strong>Application</strong> of type String. Set the value to the full path of <em>python.exe</em>. Eg <strong>C:\python25\python.exe</strong></li>
  <li><strong>AppParameters</strong> of type String. Set the value to <strong>C:\python25\Scripts\tracd-script.py --port 8009 C:\Trac\Slartibartfast</strong> - (note the change of port number, it's there for a reason we'll cover shortly).</li>
</ol>
</ol>
<li>Open the services tool from the Control Panel, find the <strong>Trac</strong> service and start it up! Navigate to <a href="http://localhost:8009">http://localhost:8009</a> to make sure it still works.</li>
</ol>


<p>If you get the same site as you did before, then all is going well. If not, then you revisit the steps to make sure you haven't missed anything out and that your pointing to the right location of the trac project.</p>

<p>Now that we know this works, we need to change the <strong>AppParameters</strong> value in the registry so that Trac fires up using the appropriate protocol. Edit the value, and append the following to the end of the existing value: <strong>--protocol=ajp</strong> - this forces the use of AJP. AJP's default port is 8009, which is why we chose this value in the first place.</p>

<p>Restart the Trac service. If you attempt to browse to the site now you won't get anything meaningful, but it's ready to be talked to from IIS, which brings us to the next step.</p>

<h3>Server: Setting up Apache Tomcat ISS ISAPI Filter in IIS 6.</h3>


<p>To get IIS to talk to Trac, we need to add an ISAPI filter that's able to translate to the AJP protocol. This is what we'll be doing in this section.</p>

<p>First, we prepare the filter for use:</p>

<ol>
  <li>Create a folder to store the ISAPI file. I called mine <strong>C:\AJPConnector</strong>.</li>
  <li>Copy the Apache Tomcat AJP ISAPI filter (isapi_redirect-1.2.28.dll) into the folder you created in the previous step, and rename it to <strong>isapi_redirect.dll</strong>.</li>
  <li>Create a new text file in the same folder called <strong>isapi_redirect.properties</strong>. Open the file with a text editor and add the following content:

    # Configuration file for the ISAPI Redirector

    # The path to the ISAPI Redirector Extension, relative to the website
    # This must be in a virtual directory with execute privileges
    extension_uri=/AJPConnector/isapi_redirect.dll

    # Full path to the log file for the ISAPI Redirector
    log_file=C:\AJPConnector\isapi_redirect.log

    # Log level (debug, info, warn, error or trace)
    log_level=info

    # Full path to the workers.properties file
    worker_file=C:\AJPConnector\workers.properties

    # Full path to the uriworkermap.properties file
    worker_mount_file=C:\AJPConnector\uriworkermap.properties

</li>
<li>Create another new text file in the same folder called <strong>workers.properties</strong>. Open it, and add this content:

    # Define 1 real worker
    worker.list=trac
    # Set properties for trac (ajp13)
    worker.trac.type=ajp13
    worker.trac.host=localhost
    worker.trac.port=8009
    worker.trac.socket_keepalive=0

</li>
<li>Create <em>another</em> new text file in the same folder called <strong>uriworkermap.properties</strong>. Open it and add the following:

    /Slartibartfast*=trac

You'll notice that the project name is what I've used here. Down the track if you want more projects, you need to add more lines to this file.</li>
</ol>


<p>Next we need to install the ISAPI filter in IIS so that it can get used. Feel free to do this on the default website if you like. I created another website in IIS running on a different port, but you don't have to. Any time I refer to <em>the website</em> I'm referring to the site you have decided to install the filter on.</p>

<p>We need to enable the filter as a web service extension first. To do that, we follow these steps:</p>

<ol>
  <li>Open up the IIS manager.</li>
  <li>Right-click on "Web Service Extensions" and select "Add a new web service extension".</li>
  <li>In the resulting dialog box, click the "Add..." button and specify the file <strong>C:\AJPConnector\isapi_redirect.dll</strong>. Click "OK".</li>
  <li>Specify the name "AJPConnector" and click "OK".</li>
</ol>


<p>Next we need to add the filter to the website.</p>

<ol>
  <li>In IIS manager right-click on the website and view the properties.</li>
  <li>Select the "ISAPI Filters" tab.</li>
  <li>Click "Add".</li>
  <li>Give the filter the name "AJPConnector".</li>
  <li>Specify the full path to the dll: <strong>C:\AJPConnector\isapi_redirect.dll</strong>.</li>
  <li>Click "OK".</li>
  <li>Click on the "Home Directory" tab.</li>
  <li>Make sure the "Execute Permissions" is set to "Scripts and Executables".</li>
  <li>Make a note of the application pool that the web site is running under! You'll need this in a minute.
  <li>Click "OK" to close the dialog.</li>
</ol>


<p>For the ISAPI filter to function, we need to make sure that IIS has access to the folder which the binary is stored in. To do this we need to know which account the website is running under.</p>

<ol>
  <li>In IIS manager open the list of Application Pools.</li>
  <li>Choose the application pool that your website is running under. Rick-click and select properties.</li>
  <li>Click on the "Identity" tab. This will show you the name of the account that your site is running under.</li>
  <li>Browse to <strong>C:\AJPConnector</strong>, right-click and select "Properties", then choose the "Security" tab.</li>
  <li>Click "Add" and type in the name of the account that you found listed in the "Identity" tab in the application pool properties. You can also use the search feature if you want to.</li>
  <li>When the user has been recognised, click "OK".</li>
  <li>Select the user in the list at the top of the dialog, and make sure that they have "Full Control" selected in the list at the bottom.</li>
  <li>Click on the "Advanced" button.</li>
  <li>Select the check box that says "Replace permission entries on all child objects with entries shown here that apply to child objects". Then press "OK". This will apply the permissions to all child objects in the folder.</li>
  <li>Click "OK" to close the dialog box.</li>
</ol>


<p>You may have noticed that in the <strong>isapi_redirect.properties</strong> file we specified an <em>extension_uri</em> property. This property specifies the path to use to get to the <strong>isapi_redirect.dll</strong> file via IIS. Notice how it's also a relative path from the root folder. Hence we need to create a virtual directory which maps to the same path.</p>

<ol>
  <li>In IIS manager right-click on the website and select "New" then "Virtual Directory...".</li>
  <li>Fill out the wizard making sure you use the name "AJPConnector" for the directory name, and point it at <strong>C:\AJPConnector</strong>. The site also needs to be able to execute programs, not just scripts.</li>
</ol>


<p>Restart IIS. The quickest way to do this is to type <strong>iisreset</strong> into a command prompt or into the "Run" dialog.</p>

<p>It's best at this point to make sure that the ISAPI filter has been loaded. To do this, simply open up the IIS manager again and browser to the sites "ISAPI Filters" tab. If all is working, then you should see something like this:</p>

<p><img src="http://buffered.io/uploads/2009/05/iis_isapi.png" alt="Working IIS ISAPI Filter" title="Working IIS ISAPI Filter" /></p>

<p>Notice the green arrow. If it's red and pointing downwards, then something is wrong. You need to make sure you have followed the above steps correctly. Double-check the security of the folders and make sure executables are enabled on your site.</p>

<p>If all is well then we can test it! Make sure your Trac service is running, then open a browser and navigate to your local IIS website. You should see the Trac Project website for Slartibartfast appear in your browswer. Yay!</p>

<p>It's now very easy to change IIS to function over HTTPS instead of HTTP. That's beyond the scope of this article as there are hundreds of blog entries and how-tos out there already.</p>

<h3>Server: Setting up CopSSH</h3>


<p>This is the final step! We need to give people access to the Mercurial repositories over SSH. For that we need to set up a functional SSH server and give them access to the repository path. On the surface these both seem like easy jobs. Unfortunately setting up SSH servers on Windows isn't pleasant and pointing everyone's home folders at a certain repository is not something that comes out of the box in Windows.</p>

<p>What we need to do is use the CopSSH installer to help with the "easy" installation of SSH. Then we need to use a program like Junction to provdie symbolic-link style functionality to the user's folders.</p>

<p>First up, run the CopSSH installer program. Follow all of the prompts and feel free to use the default installation. That was easy wasn't it! It should install an SSH server service for you. I found it quite hard to locate in the Service Management dialog, but eventually found it under the name "Openssh SSHD".</p>

<p>CopSSH comes with utilities which help you manage users. Those utilities are all in the programs menu and are easy to use. For me, those utilities weren't enough, because I knew that I was going to have to make sure that the folder links were set up on creation of user accounts and removed when those accounts were deleted.</p>

<p>It's a good move at this point to download Junction, if you haven't already, and put it in an easy to reach location. Feel free to add it to it's own folder or to system32. It's up to you. I'll assume you've put it in <strong>C:\tools</strong>.</p>

<p>I then created two scripts. The first lets you add users. It looks like this:</p>

<pre><code>REM AddUser.bat
"C:\Program Files\ICW\Bin\copsshadm.exe" --command activateuser --user %1 --shell /bin/bash --passphrase %2
C:\tools\junction.exe "C:\Program Files\ICW\home\%1\Slartibartfast" C:\Repos\Slartibartfast
</code></pre>

<p>The first line of this file executes the user activation feature of CopSSH. It creates a new user from a local security login (so the users need to be accessible in Active Directory or in the local security set up). It creates a home folder for them and also creates a public/private key pair which it stores in their home folder as well. The keys have the passphrase that is passed to the script on the command line and will be used by the users to SSH in and commit changes to the repository. The public key for the user is added to the server as a recognised key which can be used to log in so we don't have to specify it manually.</p>

<p>The second line of the script executes the Junction program and links a folder called "Slartibartfast", located in the user's home folder, to the folder where the repository is stored.</p>

<p>To execute the script simply run: <strong>adduser.bat [username] [passphrase]</strong>.
Please note that during my testing, I wasn't able to use a passphrase that had spaces. This isn't due to a bug in the script. Even if you replace <em>--passphrase %2</em> with <em>--passphrase "%2"</em> it still doesn't work. It also doesn't work in the user interface tools. This appears to be a bug in CopSSH. This isn't a big issue though, just make sure you don't have spaces in your passphrase and you should be fine.</p>

<p>The second script is for removing users, it looks like this:</p>

<pre><code>REM RemUser.bat
C:\tools\junction.exe -d "C:\Program Files\ICW\home\%1\Slartibartfast"
"C:\Program Files\ICW\Bin\copsshadm.exe" --command deactivateuser --user %1
</code></pre>

<p>It's obvious what this does. First it removes the symbolic link in the user's folder, then it uses CopSSH's command line tools to remove them as a valid user from the SSH server.</p>

<p>Before you assume that everything at this point is ready to rock, you may need to make sure that your firewall is updated so that the SSH port, 22, is open.</p>

<p>Congratulations, you are now finished with the server set up. Now let's get the clients working. Before you go to the next step, make sure you add a user!</p>

<h3>Client: Setting up PuTTy</h3>


<p>The first bit is easy, make sure that you've installed the PuTTy program and added the install path to the system's PATH environment variable.</p>

<p>Take a copy of the user's private key. This is generated by CopSSH and should be sitting in the user's home folder on the server. The key is usually called <strong>[username].key</strong>. Put the key on your local machine. We need to convert this key into a format that PuTTy can use.</p>

<ol>
  <li>Fire up the puttygen.exe utility. It comes with the PuTTy program. Simply type "puttygen" into the Run dialog box and it should come up if you've added the install folder to the system PATH.</li>
  <li>Click "Load" and select the private key file you copied from the server.</li>
  <li>Enter the user's passphrase into the dialog that appears and press "OK".</li>
  <li>You should get a message stating ...
  

    Successfully imported foreign key
    (OpenSSH SSH-2 private key).
    To use this key with PuTTY, you need to
    use the "Save private key" command to
    save it in PuTTY's own format.

Just press "OK".</li>
<li>Click "Save private key" and save the key in a safe location on your machine.</li>
</ol>


<p>Your key can now be used by PuTTy.</p>

<p>When using SSH, you are going to have to have to specify the passphrase each time you connect to the server. This can get annoying quickly especially if you do a lot of commits. Instead of typing this in manually every time, I prefer to use the pageant.exe utility that also comes with PuTTy. This takes charge of handling the key passphrase for you.</p>

<ol>
  <li>From the command line or Run dialog, type <strong>pageant</strong>. You see a rather bland dialog appear.</li>
  <li>Click "Add key". Browse to the folder where you have stored your new .ppk (the PuTTy version of your key) and select the key.</li>
  <li>When prompted, specify the passphrase and click "OK".</li>
  <li>You should now see an item appear in the list box. This is your private key. Pageant is now in memory and handling that key.</li>
  <li>Close pageant, but you should still see it running in the system tray.</li>
</ol>


<p>I also find it helpful to add <em>pageant.exe</em> to my start-up folder so that it is always running when I log in to my machine. You may choose to do the same.</p>

<h3>Client: Setting up Mercurial</h3>


<p>If you haven't already, make sure you install Mercurial on the client machine using the default settings. Make sure you tell the installer to add the Mercurial path to the system PATH.</p>

<p>The last step of configuration for the client is to tell Mercurial to use the PuTTy tools when using SSH. Mercurial can be configured by a user-specific configuration file called <em>.hgrc</em>. On Windows it can also be called <em>Mercurial.ini</em>. The file is located in your home folder. If you don't know what your home folder is, simply open a command prompt and type <strong>echo %USERPROFILE%</strong> - this will tell you the path.</p>

<p>If you haven't set up your configuration yet, then chances are the configuration file doesn't exist. So you'll have to create it. Create a file call either <em>.hgrc</em> or <em>Mercurial.ini</em> in your home folder manually, and open it in a text editor. Here is what part of mine looks like:</p>

<pre><code>[ui]
username = OJ Reeves &lt;put your email here in the angle brackets&gt;
editor = vim
ssh = plink -ssh -i "C:/path/to/key/id_rsa.ppk" -C -agent
</code></pre>

<p>The last line is the key and this is what you need to make sure it set properly. We are telling Mercurial to use the <em>plink</em> program. This also comes with PuTTy and is a command-line version of what the PuTTY program itself does behind the scenes. We also add a few parameters:</p>

<ul>
  <li><em>-ssh</em> : Indicates that we're using the SSH protocol.</li>
  <li><em>-i "file.ppk"</em> : Specifies the location of the private key file we want to use to log in to the remote server. Change this to point to your local putty-compatible ppk private key. Make sure you user forward-slashes for the path separators as well!</li>
  <li><em>-C</em> : This switch enables compression.</li>
  <li><em>-agent</em> : This tells <em>plink</em> to talk to the <em>pageant</em> utility to get the passphrase for the key instead of asking you for it interactively.</li>
</ul>


<p>The client is now ready to rock!</p>

<h3>Finale</h3>


<p>It took a while, but we got there in the end. Let's give our new-found Mercurial SSH server a spin. This should be easy as opening a command prompt at the appropriate location on disk and typing:</p>

<p><strong>hg clone ssh://url.to.your.server.com/Slartibartfast</strong></p>

<p>If everything has been configured properly, you should see Mercurial create a local folder called <strong>Slartibartfast</strong> which contains the repository. Of course, there won't be much in it because you've only created it recently! But you should be able to start using Mercurial to commit changes and push the committed changesets to the server just by running <strong>hg push</strong>.</p>

<h3>The End</h3>


<p>It took a while to figure most of this stuff out despite the documentation that exists on the web. It also took a bit of time to write this up! I hope that someone out there finds it useful.</p>

<p>The funny thing about all this, is that despite the pain, I found it easier to set up than TFS!</p>

<p>Feedback is always wanted and welcome. I hope it helps :)</p>

<hr />


<p><strong>Edit 11/06/2009 :</strong> I've been using this set up for a little while and I'm now aware of an issue that I'm not currently able to get around (moreso because I can't be bothered trying to!). The issue is that you have <em>any</em> files added to the Trac system which have file names containing characters which change when URL encoded (such as spaces, which become %20 for example) the you won't be able to view them through the web interface. That goes for files attached to wiki pages, and sources files viewed in the source browser. If you have a file called "My Doc.doc" behind the scenes this setup results calls being made with the file name "My%20Doc.doc", which doesn't exist! Just be warned. If you're going to use this setup, don't add files to your source or to the wiki that contain spaces or odd characters. :)</p>

<hr />


<p><strong>Edit 26/06/2009 :</strong>
Have a look at <a href="http://buffered.io/posts/setting-up-trac-mercurial-and-ssh-on-windows/#comment-20599851" title="Jeremy's comment">Jeremy's comment</a> for a resolution to this escaping problem. Thanks for that mate!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OpenDNS is Wicked]]></title>
    <link href="http://buffered.io/posts/opendns-is-wicked/"/>
    <updated>2008-08-18T22:03:00+10:00</updated>
    <id>http://buffered.io/posts/opendns-is-wicked</id>
    <content type="html"><![CDATA[<p><a title="Use OpenDNS to make your Internet faster, safer, and smarter." href="http://www.opendns.com/share/"><img src="http://images.opendns.com/buttons/use_opendns_155x52.gif" width="155" height="52" style="border:0; float:right; margin-left:5px;margin-bottom;5px" alt="Use OpenDNS" /></a>Over the last couple of weeks the DNS timeouts and lags I've been experiencing at home have made the web experience a little dire. My <a href="http://internode.on.net/" title="Internode">ISP</a> is actually pretty darned good, but for some reason they seem to have glitches with their DNS servers every now and then.</p>

<!--more-->


<p>The last time it happened I wasn't able to get <em>any</em> sites to respond. I ended up popping some manual DNS server entries into my router which I had archived in a "welcome" email that I had received when I first signed up for my Internet account. These worked well for a while, but eventually ended up going offline and so I had to look for another option.</p>

<p>Enter <a href="http://opendns.org/" title="OpenDNS">OpenDNS</a>. A free DNS service with a stack of features that anyone can use. I'll go over a few of them.</p>

<p>First up is <strong>Content filtering</strong>. What a fab idea! Offsite content filtering that stops dodgey and unwanted stuff before it even hits your modem. OpenDNS supports content filtering in a couple of ways which makes it really easy to generally filter out particular sites and content.</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_content_filtering_levels.png"><img src="http://buffered.io/uploads/2008/08/opendns_content_filtering_levels.png" alt="Content Filtering" title="Content Filtering" width="150" style="float:left; margin-right:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a>The content filtering mechanism is quite extensive. You have the option of choosing a predefined "filtering level", each of which defines a set of site categories which will be filtered out for viewers on your network. The options go from <em>Minimal</em>, which simply blocks known <a href="http://en.wikipedia.org/wiki/Phishing" title="Phishing">phishing</a> sites, through to <em>High</em> which covers everything from porn and illegal activities to video sharing sites.</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_content_filtering_custom.png"><img src="http://buffered.io/uploads/2008/08/opendns_content_filtering_custom.png" alt="Custom Content Filtering" title="Custom Content Filtering" width="150" style="float:right; margin-left:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a>There is also a <em>Custom</em> level which allows you to choose the categories that you want filtered. This is the long-hand version of the predefined levels mentioned above, which is great as it let's you pick and choose if you want finger-grained control.</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_site_block.png"><img src="http://buffered.io/uploads/2008/08/opendns_site_block.png" alt="Site Blocking" title="Site Blocking" width="150" style="float:left; margin-right:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a>Lastly, as far as filtering goes, you have the option of allowing or blocking sites as a hard rule. This is handy if you know that a particular site is getting caught in your filter but you know for sure that it's safe. This happens surprisingly often, so having a whitelist is very handy. Being able to block a stack of ad sites before they even hit your browser is also a winner, hence the blacklist feature is great too.</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_client.png"><img src="http://buffered.io/uploads/2008/08/opendns_client.png" alt="OpenDNS Client" title="OpenDNS Client" width="150" style="float:right; margin-left:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a>Thankfully OpenDNS supports <strong>IP address auto-update</strong>. Over time, you'll no doubt get different IP addresses from your ISP as your DHCP leases expire or when you reconnect your modem to your service. Given that OpenDNS needs to have some way of determining who you are, IP address really is the only way. So to help keep OpenDNS up-to-date with your current IP (and hence, keep applying your filtering rules), there is a client application that you can have running in your system tray which contacts the service periodically and makes sure that it has the latest IP. While this is a great idea it's a bit crap that you have to run a client application. It's a shame that they didn't decide to support the use of another dynamic addressing system such as <a href="http://dyndns.org/" title="DynDns">DynDns.org</a> (lots of modems have built-in support for updating services like DynDns automatically).</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_customisation.png"><img src="http://buffered.io/uploads/2008/08/opendns_customisation.png" alt="Customisation" title="Customisation" width="150" style="float:left; margin-right:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a>For those who like to make their services feel cosey, OpenDNS supports <strong>customisation</strong> of various bits of functionality. For example, you're able to change the logo picture (this is more of an interest to site admins). You can also modify messages that are displayed when sites are blocked for various reasons. For those of you on home networks, specifying more meaningful messages for those, shall we say, "less technical" family members will no doubt be beneficial in reducing the number of support calls.</p>

<p><a href="http://buffered.io/uploads/2008/08/opendns_shortcuts.png"><img src="http://buffered.io/uploads/2008/08/opendns_shortcuts.png" alt="Shortcuts" title="Shortcuts" width="150" style="float:right; margin-left:5px; margin-bottom:5px;" rel="lightbox[opendns]" /></a><strong>Network shortcuts</strong> are another nifty feature. A network shortcut is essentially a bookmark which works across the entire network. All you have to do is specify a name for your shortcut, and the site that it redirects to, and you're done. Once the shortcut has been saved, all you have to do to get to the site is type in the name of the shortcut. When the DNS request is made, OpenDNS looks for any shortcuts by that name that exist in your list, and if found, it will redirect the user to the appropriate site. Groovey!</p>

<p>At first you don't believe it, but OpenDNS is <strong>surprisingly quick</strong>. I wouldn't say that I have conducted a huge set of performance tests and benchmarks, but I would say that it by far outperforms my ISP's DNS servers as far as responsivity is concerned. Not just that, but <strong>it works</strong>. I am yet to see a DNS lookup fail requiring me to retry.</p>

<p>The final redeeming feature of OpenDNS is that it's constantly updated and secure. <a href="http://www.doxpara.com/?p=1185">Flaws in the DNS system</a>, for example, have already been patched. This reduces the chances of you dealing with an insecure DNS server (such as the one sitting at your ISP) and ending up at a site that might be a little unsavoury.</p>

<p>To sum up, I really think OpenDNS is a great service. It's fast, feature-rich and very handy. For anyone with a family/kids or a need/desire to filter out some of the f**ked up content that lives on the web (such as this site ;)), this service is for you. Give it a spin!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[.NET-fu: Signing an Unsigned Assembly (without Delay Signing)]]></title>
    <link href="http://buffered.io/posts/net-fu-signing-an-unsigned-assembly-without-delay-signing/"/>
    <updated>2008-07-09T12:13:00+10:00</updated>
    <id>http://buffered.io/posts/net-fu-signing-an-unsigned-assembly-without-delay-signing</id>
    <content type="html"><![CDATA[<p>This article is also available in <a href="http://www.otherbit.com/modules/blog/BlogContent.aspx?ID=174" title=".NET-FU : come trasformare in SIGNED un assembly UNSIGNED (senza ricorrere al DELAY SIGNING)">Italian</a>.</p>

<hr />

<p>The code-base that I am currently working with consists of a large set of binaries that are all <a href="http://msdn.microsoft.com/en-us/library/xc31ft41.aspx" title="Sign an Assembly with a Strong Name">signed</a>. The savvy .NET devs out there will know that any assembly that's used/referenced by a signed assembly must <em>also</em> be signed.</p>

<p>This is an issue when dealing with third-party libraries that are not signed. Sometimes you'll be lucky enough to be dealing with vendor that is happy to provide a set of signed assemblies, other times you won't. If your scenario fits the latter (as a recent one did for my colleagues and I), you need to sign the assemblies yourself. Here's how.</p>

<!--more-->


<p><em>Note:</em> <a href="http://msdn.microsoft.com/en-us/library/t07a3dye(VS.80).aspx" title="Delay Signing an Assembly">delay signing</a> is not covered in this article.</p>

<h2>Scenario 1 - Foo and Bar</h2>

<ul>
<li><code>Foo</code> is the component that you're building which has to be signed.</li>
<li><code>Bar</code> is the third-party component that you're forced to use that <em>isn't</em>.</li>
</ul>


<p><img src="http://buffered.io/uploads/2008/07/foobar.png" alt="Relationship between Foo and Bar" /></p>

<p>Grab <a href="/uploads/2008/07/bar.zip" title="Project/Binary for Bar">Bar.dll and project</a> along with <a href="/uploads/2008/07/foobar.zip" title="Project/Binary for Foo">Foo.dll and project</a> to see a source sample.</p>

<p>You'll notice <em>Foo</em> has a .snk which is used to sign <em>Foo.dll.</em> When you attempt to compile <em>Foo</em> you get the following error message:</p>

<blockquote><p>Assembly generation failed -- Referenced assembly 'Bar' does not have a strong name.</p></blockquote>

<p>We need to sign <em>Bar</em> in order for <em>Foo</em> to compile.</p>

<p><img src="http://buffered.io/uploads/2008/07/step1.jpg" style="float: right; margin-left: 5px; margin-bottom: 2px;" alt="Disassemble Bar" /></p>

<h3>Step 1 - Disassemble Bar</h3>

<p>We need to open a command prompt which has the .NET framework binaries in the PATH environment variable. The easiest way to do this is to open a Visual Studio command prompt (which is usually under the "Visual Studio Tools" subfolder of "Visual Studio 20XX" in your programs menu). Change directory so that you're in the folder which contains <em>Bar.dll</em>.</p>

<p>Use <a href="http://msdn.microsoft.com/en-us/library/f7dy01k1(VS.80).aspx" title="MSIL Disassembly">ildasm</a> to disassemble the file using the <code>/all</code> and <code>/out</code>, like so:</p>

<pre><code>C:\Foo\bin&gt; ildasm /all /out=Bar.il Bar.dll
</code></pre>

<p>The result of the command is a new file, <em>Bar.il</em>, which contains a dissassembled listing of <em>Bar.dll</em>.</p>

<p><img src="http://buffered.io/uploads/2008/07/step2.jpg" style="float: right; margin-left: 5px; margin-bottom: 2px;" alt="Rebuild and Sign Bar" /></p>

<h3>Step 2 - Rebuild and Sign Bar</h3>

<p>We can now use <a href="http://msdn.microsoft.com/en-us/library/496e4ekx.aspx" title="MSIL Assembler">ilasm</a> to reassemble <em>Bar.il</em> back into <em>Bar.dll</em>, but at the same time specify a strong-name key to use to sign the resulting assembly. We pass in the value <em>Foo.snk</em> to the <code>/key</code> switch on the command line, like so:</p>

<div style="clear:both;"></div>


<pre><code>C:\Foo\bin&gt; ilasm /dll /key=Foo.snk Bar.il

Microsoft (R) .NET Framework IL Assembler.  Version 2.0.50727.1434
Copyright (c) Microsoft Corporation.  All rights reserved.
Assembling 'Bar.il'  to DLL --&gt; 'Bar.dll'
Source file is ANSI

Assembled method Bar.Bar::get_SecretMessage
Assembled method Bar.Bar::.ctor
Creating PE file

Emitting classes:
Class 1:        Bar.Bar

Emitting fields and methods:
Global
Class 1 Methods: 2;
Resolving local member refs: 1 -&gt; 1 defs, 0 refs, 0 unresolved

Emitting events and properties:
Global
Class 1 Props: 1;
Resolving local member refs: 0 -&gt; 0 defs, 0 refs, 0 unresolved
Writing PE file
Signing file with strong name
Operation completed successfully
</code></pre>

<p><em>Bar.dll</em> is now signed! All we have to do is reopen <em>Foo</em>'s project, remove the reference to <em>Bar.dll</em>, re-add the reference to the new signed assembly and rebuild. Sorted!</p>

<h2>Scenario 2 - Foo, Bar and Baz</h2>

<ul>
<li><code>Foo</code> is the component that you're building which has to be signed.</li>
<li><code>Bar</code> is the third-party component that you're forced to use that <em>isn't</em>.</li>
<li><code>Baz</code> is another third-party component that is required in order for you to use <em>Bar</em>.</li>
</ul>


<p><img src="http://buffered.io/uploads/2008/07/foobarbaz.png" alt="Relationship between Foo, Bar and Baz"/></p>

<p>Grab <a href="/uploads/2008/07/baz.zip" title="Project/Binary for Baz"><em>Baz.dll</em> and project</a>, <a href="/uploads/2008/07/barbaz.zip" title="Project/Binary for Bar"><em>Bar.dll</em> and project</a> along with <a href="/uploads/2008/07/foobarbaz.zip" title="Project/Binary for Foo"><em>Foo.dll</em> and project</a> for a sample source.</p>

<p>When you attempt to build <em>Foo</em> you get the same error as you do in the previous scenario. Bear in mind that this time, <strong>both</strong> <em>Bar.dll</em> and <em>Baz.dll</em> need to be signed. So first of all, follow the steps in <strong>Scenario 1</strong> for both <em>Bar.dll</em> and <em>Baz.dll</em>.</p>

<p>Done? OK. When you attempt to build <em>Foo.dll</em> after pointing the project at the new <em>Bar.dll</em> no compiler errors will be shown. Don't get too excited :)</p>

<p>When you attempt to <strong>use</strong> <em>Foo.dll</em> your world will come crashing down. The reason is because <em>Bar.dll</em> was originally built with a reference to an <u>unsigned version</u> of <em>Baz.dll</em>. Now that <em>Baz.dll</em> is signed we need to force <em>Bar.dll</em> to reference the <strong>signed</strong> version of <em>Baz.dll</em>.</p>

<p><img src="http://buffered.io/uploads/2008/07/step3.jpg" style="float: right; margin-left: 5px; margin-bottom: 2px;" alt="Hack the Disassembled IL" /></p>

<h3>Step 1 - Hack the Disassembled IL</h3>

<p>Just like we did in the previous steps we need to disassemble the binary that we need to fix. This time, make sure you disassemble the new binary that you created in the previous step (this binary has been signed, and will contain the signature block for the strong name). Once <em>Bar.il</em> has been created using ildasm, open it up in a <a href="http://www.vim.org/" title="VIM - @secretGeek loves it... no really, he does!">text editor</a>.</p>

<p>Search for the reference to <em>Baz</em> -- this should be located a fair way down the file, somewhere near the top of the actual code listing, just after the comments. Here's what it looks like on my machine:</p>

<pre><code>.assembly extern /*23000002*/ Baz
{
  .ver 1:0:0:0
}
</code></pre>

<p>This external assembly reference is missing the all-important public key token reference. Before we can add it, we need to know what the public key token is for <em>Bar.dll</em>. To determine this, we can use the <a href="http://msdn.microsoft.com/en-us/library/k5b5tt23(VS.80).aspx" title="Strong Name Tool">sn.exe</a> utility, like so:</p>

<pre><code>C:\Foo\bin&gt; sn -Tp Baz.dll

Microsoft (R) .NET Framework Strong Name Utility  Version 3.5.21022.8
Copyright (c) Microsoft Corporation.  All rights reserved.

Public key is
0024000004800000940000000602000000240000525341310004000001000100a59cd85e10658d
9229d54de16c69d0b53b31f60bb4404b86eb3b8804203aca9d65412a249dfb8e7b9869d09ce80b
0d9bdccd4943c0004c4e76b95fdcdbc6043765f51a1ee331fdd55ad25400d496808b792723fc76
dee74d3db67403572cddd530cadfa7fbdd974cef7700be93c00c81121d978a3398b07a9dc1077f
b331ca9c

Public key token is 2ed7bbec811020ec
</code></pre>

<p>Now we return to <em>Bar.il</em> and modify the assembly reference so that the public key token is specified. This is what it should look like after modification:</p>

<pre><code>.assembly extern /*23000002*/ Baz
{
  .publickeytoken = (2E D7 BB EC 81 10 20 EC )
  .ver 1:0:0:0
}
</code></pre>

<p>Save your changes.</p>

<p><img src="http://buffered.io/uploads/2008/07/step4.jpg" style="float: right; margin-left: 5px; margin-bottom: 2px;" alt="Reassemble Bar" /></p>

<h3>Step 2 - Reassemble Bar</h3>

<p>This step is just a repeat of previous steps. We are again using ilasm to reassemble <em>Bar.dll</em>, but this time from the new "hacked" <em>Bar.il</em> file. We must use the exact same command line as we did previously, and we still need to specify the <em>Foo.snk</em> for signing the assembly. To save you having to scroll up, here it is again:</p>

<pre><code>C:\Foo\bin&gt; ilasm /dll /key=Foo.snk Bar.il

Microsoft (R) .NET Framework IL Assembler.  Version 2.0.50727.1434
Copyright (c) Microsoft Corporation.  All rights reserved.
Assembling 'Bar.il'  to DLL --&gt; 'Bar.dll'
Source file is ANSI

Assembled method Bar.Bar::get_SecretMessage
Assembled method Bar.Bar::.ctor
Creating PE file

Emitting classes:
Class 1:        Bar.Bar

Emitting fields and methods:
Global
Class 1 Fields: 1;      Methods: 2;
Resolving local member refs: 3 -&gt; 3 defs, 0 refs, 0 unresolved

Emitting events and properties:
Global
Class 1 Props: 1;
Resolving local member refs: 0 -&gt; 0 defs, 0 refs, 0 unresolved
Writing PE file
Signing file with strong name
Operation completed successfully
</code></pre>

<p>Open up <em>Foo</em>'s project, remove and re-add the reference to <em>Bar.dll</em>, making sure you point to the new version that you just created. <em>Foo.dll</em> will not only build, but this time it will run!</p>

<h2>Disclaimer</h2>

<p>"Hacking" third-party binaries in this manner <strong><em>may</em> breach the license agreement</strong> of those binaries. Please make sure that you are not breaking the license agreement before adopting this technique.</p>

<p>I hope this helps!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Screencast - Setting up Unity Builds]]></title>
    <link href="http://buffered.io/posts/screencast-setting-up-unity-builds/"/>
    <updated>2008-06-19T23:20:00+10:00</updated>
    <id>http://buffered.io/posts/screencast-setting-up-unity-builds</id>
    <content type="html"><![CDATA[<p>It has taken me a bit longer than expected, but I've finally got the screencast up!</p>

<p>That's right folks, my angelic voice is now online for you all to experience. 8 minutes of Unity Build glory!</p>

<!--more-->


<p>Get it here:</p>

<div style="text-align: center;"><a href="http://oj.blackapache.net.s3.amazonaws.com/UnityBuilds.html" target="_blank" title="Setting up Unity Builds"><img src="http://buffered.io/uploads/2008/06/unitybuild-screengrab.png" alt="View the Screencast" title="View the Screencast" width="300" height="264" /></a>
<em><a href="http://oj.blackapache.net.s3.amazonaws.com/UnityBuilds.html" target="_blank" title="Setting up Unity Builds">Setting up Unity Builds</a></em></div>


<p>I made the screencast using the demo version of <a href="http://www.techsmith.com/camtasia.asp" title="Camtasia">Camtasia</a> (which I give a big thumbs up to!). It weighs in at around 19MB in total, but it's well worth watching if you haven't seen a Unity Build in action before. Remember to check out <a href="http://buffered.io/posts/the-magic-of-unity-builds/" title="The Magic of Unity Builds">The Magic of Unity Builds</a> if you want some more technical information on how these builds work.</p>

<p>The project and associated source code that I used for this screencast is available for download <a href="http://buffered.io/uploads/2008/06/win32wrap.zip" title="Old code, but it's great for the demo">right here</a>.</p>

<p>As a final note, please forgive me for sounding tired!</p>

<p>I look forward to hearing your feedback. Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Preview Feeds in Google Reader]]></title>
    <link href="http://buffered.io/posts/preview-feeds-in-google-reader/"/>
    <updated>2008-05-25T09:51:00+10:00</updated>
    <id>http://buffered.io/posts/preview-feeds-in-google-reader</id>
    <content type="html"><![CDATA[<p>Here's another reason why I find <a href="http://reader.google.com/" title="Google Reader">Google Reader</a> a excellent choice for reading your RSS feeds.</p>

<p>Most of us have a collection of feeds that contain similar subject matter. As a geek, <em>most</em> of my feeds are geek-related. As a geek who likes to stay up to speed, I also like to know what other blogs and feeds are good to read.</p>

<p>This is where Google Reader's <strong>Top Recommendations</strong> come in. Google do a great job of throwing other feeds in your face that you might like to read based on the kind of stuff that you've already subscribed to.</p>

<!--more-->


<p><a href="http://buffered.io/uploads/2008/05/reader_recommendations.png" rel="lightbox[rec_reader]" title="Recommended feeds"><img src="http://buffered.io/uploads/2008/05/reader_recommendations.png" alt="A shortlist of recommended feeds" title="Recommended feeds" width="300" height="205" class="aligncenter size-medium wp-image-361" /></a></p>

<p>As you can see, it lists a few blogs that are of a similar nature to those that you read and gives you the option to view them. When you click on the <em>View all &gt;&gt;</em> button, you're presented with a rather extensive list:</p>

<p><a href="http://buffered.io/uploads/2008/05/reader_rec_list.png" title="Detail list of recommended feeds" rel="lightbox[rec_reader]"><img src="http://buffered.io/uploads/2008/05/reader_rec_list.png" alt="Detail list of recommended feeds" title="Detail list of recommended feeds" width="300" height="205" class="aligncenter size-medium wp-image-362" /></a></p>

<p>This next bit is something I really like. When I see a feed that I might be interested in (after weighing up how active the blog is and how many subscribers there are), I can click on the feed to preview it without having to subscribe to it first! Check it out:</p>

<p><a href="http://buffered.io/uploads/2008/05/reader_rec_preview.png" rel="lightbox[rec_reader]" title="Feed preview"><img src="http://buffered.io/uploads/2008/05/reader_rec_preview.png" alt="Feed preview" title="Feed preview" width="300" height="205" class="aligncenter size-medium wp-image-360" /></a></p>

<p>You can browse through the feed and interact with it as if it was part of your subscription list already. If you see some articles that take your fancy and the content appeals to you, you can easily subscribe by clicking on the profoundly obvious <em>Subscribe</em> button. If I don't like it, I can go back to the list, and I can even click on the "No thanks" link next to the feed so that it doesn't appear in my recommended list again.</p>

<p>Too easy. This is exactly the kind of "ease of use" feature that I want from my RSS reader. I'm sure a couple of other readers would provide similar features, but the simplicity of this really blows my skirt up.</p>

<p>+1 Google Reader (again).</p>
]]></content>
  </entry>
  
</feed>
