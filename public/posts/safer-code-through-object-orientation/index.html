
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Safer Code through Object-Orientation - OJ's rants</title>
  <meta name="author" content="OJ Reeves">

  <link rel="openid.server" href="http://server.myid.net/server" />
  <link rel="openid.delegate" href="http://thecolonial.myid.net/" />
  <link rel="openid2.local_id" href="http://thecolonial.myid.net/" />
  <link rel="openid2.provider" href="http://server.myid.net/server" />
  <meta http-equiv="X-XRDS-Location" content="http://thecolonial.myid.net/xrds" />

  
  <meta name="description" content="In my current position I spend a lot of time battling against a fairly poorly-written C++ code base. The code, while technically written in C++, is &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="http://feeds.feedburner.com/OjsRants" rel="alternate" title="OJ's rants RSS 2.0" type="application/rss+xml">
  <link rel="canonical" href="http://buffered.io/posts/safer-code-through-object-orientation">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  <script src="/javascripts/modernizr-2.0.js" type="text/javascript"></script>
  <script src="/javascripts/ender.js" type="text/javascript"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>

  <script type="text/javascript">
    Modernizr.load([
      { load: '//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js' },
      { load: '/javascripts/jquery.lightbox.js', complete: function() {
        $("a[rel^='lightbox']").lightbox();
      } }
    ]);
  </script>

  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8648787-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">OJ's rants</a></h1>
  
    <h2>It's not about you, it's about the software</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/OjsRants" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:buffered.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/posts/archives">Archives</a></li>
  <li><a href="/+">About</a></li>
  <li><a href="/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Safer Code Through Object-Orientation</h1>
    
    
      <p class="meta">
        








  



<time datetime="2007-08-09T18:55:00+10:00" pubdate data-updated="true">09 Aug 2007</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In my current position I spend a lot of time battling against a fairly poorly-written C++ code base. The code, while <em>technically</em> written in C++, is actually more of a C-like &#8220;splat&#8221; with a few classes thrown in. Since I began working on this project I&#8217;ve seen many cases where proper <a href="http://en.wikipedia.org/wiki/Object-oriented_programming" title="Object-oriented programming">object-orientation</a> would have made a drastic improvement to the quality of the code.</p>

<p>And it&#8217;s these cases which are the inspiration for this blog post.</p>

<!--more-->


<p>Objects are not only good for encapsulation and making more readable/maintainable code. They can also be used to improve <em>code safety</em>. Rather than try and explain through words what I mean by &#8216;code safety&#8217;, let&#8217;s work through a couple of examples.</p>

<h3>Example 1: Data Integrity in a Multithreaded Application</h3>


<p>Let&#8217;s say that we&#8217;re working on a <a href="http://en.wikipedia.org/wiki/Thread_(computer_science)" title="Threading">multithreaded</a> application. We have a set of data that is constantly read and written across the different threads. We obviously don&#8217;t want to have different threads writing to the dataset at the same time, as this may cause all kinds of issues with the data&#8217;s integrity. We want to put a mechanism in place to ensure that the data&#8217;s integrity is never put at risk. We can do this simply by &#8216;locking&#8217; the sections of code that perform the data writes via a synchronisation technique such as a <a href="http://en.wikipedia.org/wiki/Critical_section" title="Critical section">critical section</a>, a <a href="http://en.wikipedia.org/wiki/Semaphore_(programming)" title="Semaphore">semaphore</a> or a <a href="http://en.wikipedia.org/wiki/Mutex" title="Mutex">mutex</a>. For the sake of this example, we&#8217;ll use a critical section. We&#8217;ll wrap it up in an object for easy use. Let&#8217;s pretend that we have a C++ critical section class that looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CriticalSection</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">CriticalSection</span><span class="p">();</span>
</span><span class='line'>  <span class="o">~</span><span class="n">CriticalSection</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">Lock</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use the critical section object, all we need to do is this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">CriticalSection</span> <span class="n">importantDataLocker</span><span class="p">;</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span> <span class="n">importantDataLocker</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// do stuff to important data</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">importantDataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy enough isn&#8217;t it! We&#8217;ll use this code in our data writer object, so that we can make sure that all of our threads are playing nicely while writing the data. During the course of our data writing, we might want to do some other processing that is not related to writing data. Even though this task isn&#8217;t related to writing the data out, we still retain the lock so that we can finish off the job after without having to unlock and relock. So we may have some code that looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">bool</span> <span class="n">DataWriter</span><span class="o">::</span><span class="n">WriteFunkyData</span><span class="p">(</span> <span class="n">FunkyData</span><span class="o">*</span> <span class="n">data</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">WriteABitOfData</span><span class="p">(</span> <span class="n">data</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">DoSomeProcessing</span><span class="p">(</span> <span class="n">data</span> <span class="p">);</span>
</span><span class='line'>    <span class="n">WriteSomeMoreData</span><span class="p">(</span> <span class="n">data</span> <span class="p">);</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not really rocket science is it? The above code makes sure that all the code between <em>Lock()</em> and <em>Unlock()</em> is only run when no other threads are requesting a lock (or own a lock) on the critical section.</p>

<p>Unfortunately we have a problem. In a non-perfect world (like the one we live in) there&#8217;s always a chance that somewhere between the call to <em>Lock()</em> and the call to <em>Unlock()</em> an error might occur. An exception may be thrown. The code might just <em>return;</em>. If that&#8217;s the case, the critical section will <strong>not be unlocked</strong> because the <em>Unlock()</em> function won&#8217;t be called before the function finishes.</p>

<p>The result? A critical section that&#8217;s permanently locked, and all future <em>Lock()</em> requests will either hang or fail. This is not ideal. If we were using system-wide mutexes we&#8217;d do some serious damage! Cleary this isn&#8217;t acceptable.</p>

<p>Most <a href="http://en.wikipedia.org/wiki/Procedural_programming" title="Procedural programming">procedural</a> programmers will adjust the code in the following manner:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">bool</span> <span class="n">DataWriter</span><span class="o">::</span><span class="n">WriteFunkyData</span><span class="p">(</span> <span class="n">FunkyData</span><span class="o">*</span> <span class="n">data</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">WriteABitOfData</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">DoSomeProcessing</span><span class="p">(</span> <span class="n">data</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">WriteSomeMoreData</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">m_dataLocker</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some of you might be laughing at the above code. And rightly so! But don&#8217;t think that it&#8217;s uncommon because it&#8217;s <strong>not</strong>. As you can imagine, the code gets bigger, nastier and tougher to maintain. As the function increases in size, code duplication increases and the chance of making mistakes increases. What if a new maintenance coder decides to early-out without unlocking? You&#8217;re still stuck with the same problem.</p>

<p>Further use of object-orientation is what&#8217;s required to solve this problem. Let&#8217;s use and abuse a couple of the core features of objects: <a href="http://en.wikipedia.org/wiki/Constructor_%28computer_science%29" title="Constructor">construction</a> and <a href="http://en.wikipedia.org/wiki/Destructor_%28computer_science%29" title="Destructor">destruction</a>:<ul><li>When an object is instantiated, it&#8217;s <em>constructor</em> is called.</li><li>When an object is destroyed, it&#8217;s <em>destructor</em> is called</li></ul>For those of you who don&#8217;t know, objects are destroyed in two ways:<ol><li>When they go out of scope.</li><li>When they are <a href="http://en.wikipedia.org/wiki/Operator_delete" title="Operator delete">deleted</a>.</li></ol>
Each function in C++ has it&#8217;s own scope. As soon as the function is finished, the scope is no longer valid and any local variables are cleaned up. This happens when &#8230;<ul><li>&#8230; program execution reaches the end of the function.</li><li>&#8230; a <em>return</em> statement is reached.</li><li>&#8230; a exception is thrown that is not caught.</li></ul>
If there was an object that was able to lock the critical section when it&#8217;s constructed and unlock the same critical section when it&#8217;s destroyed, we could use it to make sure that the critical section is unlocked <strong>regardless</strong> of the way in which the function is exited. That was a bit of a mouthful, so to demonstrate the point have a look at the following code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CriticalSectionLocker</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">CriticalSectionLocker</span><span class="p">(</span> <span class="n">CriticalSection</span><span class="o">&amp;</span> <span class="n">cs</span> <span class="p">)</span>
</span><span class='line'>  <span class="o">:</span> <span class="n">m_criticalSection</span><span class="p">(</span> <span class="n">cs</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m_isLocked</span> <span class="o">=</span> <span class="n">m_criticalSection</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="o">~</span><span class="n">CriticalSectionLocker</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="n">m_isLocked</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">m_criticalSection</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">IsLocked</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">m_isLocked</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">m_isLocked</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CriticalSection</span><span class="o">&amp;</span> <span class="n">m_criticalSection</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we use this object instead of the verbose and repetitive method shown above, our code would look like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">bool</span> <span class="n">DataWriter</span><span class="o">::</span><span class="n">WriteFunkyData</span><span class="p">(</span> <span class="n">FunkyData</span><span class="o">*</span> <span class="n">data</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">CriticalSectionLocker</span> <span class="n">csl</span><span class="p">(</span> <span class="n">m_dataLocker</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">csl</span><span class="p">.</span><span class="n">IsLocked</span><span class="p">()</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">WriteABitOfData</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DoSomeProcessing</span><span class="p">(</span> <span class="n">data</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">WriteSomeMoreData</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code is substantially easier to maintain. As soon as <em>csl</em> goes out of scope, the critical section will be unlocked automatically via the destructor. This will happen on early-outs <em>and</em> when exceptions are thrown. Job done!</p>

<h3>Example 2: Flag/Value Toggling</h3>


<p>Developers have been known to write code which relies on object state to function differently. While this might not be considered &#8216;best practice&#8217;, it&#8217;s fairly common out in the wild. There are times where a developer may want to temporarily toggle a flag, or change the value of a variable, and change it back before the rest of the code is run. Here&#8217;s an example (it&#8217;s not real-life, but it should give you the idea):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">void</span> <span class="n">Person</span><span class="o">::</span><span class="n">GotToParty</span><span class="p">(</span> <span class="n">NightClub</span><span class="o">*</span> <span class="n">nc</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">nc</span><span class="o">-&gt;</span><span class="n">AllowsEntry</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">// temporarily pretend we&#39;re older</span>
</span><span class='line'>    <span class="c1">// so we can go clubbing!</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">backupAge</span> <span class="o">=</span> <span class="n">m_Age</span><span class="p">;</span>
</span><span class='line'>    <span class="n">m_Age</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="n">nc</span><span class="o">-&gt;</span><span class="n">AllowsEntry</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">-&gt;</span><span class="n">Party</span><span class="p">(</span> <span class="n">nc</span><span class="p">,</span> <span class="n">HARD_BUT_SUBTLE</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// best restore our age now</span>
</span><span class='line'>    <span class="n">m_Age</span> <span class="o">=</span> <span class="n">backupAge</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Party</span><span class="p">(</span> <span class="n">nc</span><span class="p">,</span> <span class="n">HARD</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Don&#8217;t laugh, we&#8217;ve all been there! :)</p>

<p>It should be obvious that the code above suffers from the same shortcomings as the previous example. It&#8217;s not resiliant against early-outs or exceptions. A similar type of construct/destruct mechanism can be used to reset the original value of a variable in a much safer way. An example class might look like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ValueToggler</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">ValueToggler</span><span class="p">(</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">variableToToggle</span><span class="p">,</span> <span class="n">T</span> <span class="n">tempValue</span> <span class="p">)</span>
</span><span class='line'>  <span class="o">:</span> <span class="n">m_toggleVar</span><span class="p">(</span> <span class="n">variableToToggle</span> <span class="p">),</span>
</span><span class='line'>    <span class="n">m_originalValue</span><span class="p">(</span> <span class="n">variableToToggle</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m_toggleVar</span> <span class="o">=</span> <span class="n">tempValue</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">~</span><span class="n">ValueToggler</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">m_togglerVar</span> <span class="o">=</span> <span class="n">m_originalValue</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="n">m_toggleVar</span><span class="p">;</span>
</span><span class='line'>  <span class="n">T</span> <span class="n">m_originalValue</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The object above is templated so that it can be used with a variety of types (eg. int, double, float). Using an object such as this, the example program code would change to the following:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">void</span> <span class="n">Person</span><span class="o">::</span><span class="n">GotToParty</span><span class="p">(</span> <span class="n">NightClub</span><span class="o">*</span> <span class="n">nc</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">nc</span><span class="o">-&gt;</span><span class="n">AllowsEntry</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">ValueToggler</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vt</span><span class="p">(</span> <span class="n">m_Age</span><span class="p">,</span> <span class="mi">25</span> <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="n">nc</span><span class="o">-&gt;</span><span class="n">AllowsEntry</span><span class="p">(</span> <span class="k">this</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">-&gt;</span><span class="n">Party</span><span class="p">(</span> <span class="n">nc</span><span class="p">,</span> <span class="n">HARD_BUT_SUBTLE</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Party</span><span class="p">(</span> <span class="n">nc</span><span class="p">,</span> <span class="n">HARD</span> <span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, the code is smaller and a lot more bulletproof. The value of <em>m_Age</em> will be restored no matter what happens inside the function.</p>

<h3>Conclusion and Final Thoughts</h3>


<p>The above samples should show you how easy it is to use objects to help you write more defensive code. Though some people (usually the procedural programmers ;) ) would say that this kind of code is a hack, it&#8217;s my view that they&#8217;re wrong. The code is clear, easy to maintain, and very safe.</p>

<p><em>Disclaimer:</em> The code above hasn&#8217;t been compiled, so it may contain errors. The point of the post is to show you the idea behind using objects for safety. Ideal implementations are beyond the scope of the article.</p>

<p>Thoughts and feedback are always welcome.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">OJ Reeves</span></span>

      








  



<time datetime="2007-08-09T18:55:00+10:00" pubdate data-updated="true">09 Aug 2007</time>
      

<span class="categories">
  
    <a class='category' href='/categories/c-/'>C#</a>, <a class='category' href='/categories/software-development/'>Software Development</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://buffered.io/posts/safer-code-through-object-orientation/" data-via="TheColonial" data-counturl="http://buffered.io/posts/safer-code-through-object-orientation/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/posts/mislead-from-the-start/" title="Previous Post: Misled from the Start">&laquo; Misled from the Start</a>
      
      
        <a class="basic-alignment right" href="/posts/ill-view-what-i-like/" title="next Post: I'll View What I Like!">I'll View What I Like! &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>OJ on the Web</h1>
  <ul id="about_me">
    <li class="post">
      <a href="/+" title="About OJ">About me</a>
    </li>
    <li class="post">
      <a href="/key.html" title="PGP Key">PGP Key</a>
    </li>
    <li class="post">
      <a href="http://functional.io/" title="Functional IO">Functional IO</a>
    </li>
    <li class="post">
      <a href="http://twitter.com/TheColonial" title="OJ @ Twitter">Twitter</a>
    </li>
    <li class="post">
      <a href="http://github.com/OJ/" title="OJ @ Github">Github</a>
    </li>
    <li class="post">
      <a href="http://bitbucket.org/OJ/" title="OJ @ Bitbucket">Bitbucket</a>
    </li>
    <li class="post">
      <a href="http://stackoverflow.com/users/611/oj" title="OJ @ SO">StackOverflow</a>
    </li>
    <li class="post">
      <a href="https://coderwall.com/oj">Coderwall<br/><img alt="Endorse OJ on Coderwall" src="http://api.coderwall.com/oj/endorsecount.png" /></a>
    </li>
  </ul>
  <iframe src="http://githubbadge.appspot.com/badge/OJ?s=1" style="border: 0;height: 142px;width: 200px;overflow: hidden;" frameBorder=0></iframe>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/posts/levels-7-and-7_alt-io-at-sts/">Levels 7 and 7_alt - IO at STS</a>
      </li>
    
      <li class="post">
        <a href="/posts/irssi-and-sasl-on-osx/">Irssi and SASL on OSX</a>
      </li>
    
      <li class="post">
        <a href="/posts/xss-flaws-via-mvc-model-binding-and-request.querystring-inconsistencies/">XSS Flaws via MVC Model Binding and Request.QueryString Inconsistencies</a>
      </li>
    
      <li class="post">
        <a href="/posts/stepping-down/">Stepping Down</a>
      </li>
    
      <li class="post">
        <a href="/posts/meaning/">Meaning</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("TheColonial", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/TheColonial" class="twitter-follow-button" data-show-count="false">Follow @TheColonial</a>
  
</section>

<section>
  <h1>Series</h1>
  <ul id="series">
    <li class='series'><a href='/series/project-euler/'>Project Euler (11)</a></li>
<li class='series'><a href='/series/web-development-with-erlang/'>Web Development with Erlang (5)</a></li>

  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/categories/asm/'>ASM (3)</a></li>
<li class='category'><a href='/categories/asp-net/'>ASP.NET (4)</a></li>
<li class='category'><a href='/categories/agile/'>Agile (1)</a></li>
<li class='category'><a href='/categories/algorithms/'>Algorithms (6)</a></li>
<li class='category'><a href='/categories/apple/'>Apple (3)</a></li>
<li class='category'><a href='/categories/backbonejs/'>BackboneJS (1)</a></li>
<li class='category'><a href='/categories/being-in-the-industry/'>Being in the Industry (29)</a></li>
<li class='category'><a href='/categories/blogging/'>Blogging (15)</a></li>
<li class='category'><a href='/categories/bootstrap/'>Bootstrap (1)</a></li>
<li class='category'><a href='/categories/c-/'>C# (15)</a></li>
<li class='category'><a href='/categories/clr/'>CLR (3)</a></li>
<li class='category'><a href='/categories/challenges/'>Challenges (7)</a></li>
<li class='category'><a href='/categories/databases/'>Databases (6)</a></li>
<li class='category'><a href='/categories/digital-rights/'>Digital Rights (7)</a></li>
<li class='category'><a href='/categories/erlang/'>Erlang (8)</a></li>
<li class='category'><a href='/categories/erlydtl/'>ErlyDTL (2)</a></li>
<li class='category'><a href='/categories/f-/'>F# (4)</a></li>
<li class='category'><a href='/categories/fail/'>Fail (2)</a></li>
<li class='category'><a href='/categories/food/'>Food (1)</a></li>
<li class='category'><a href='/categories/freeware/'>Freeware (9)</a></li>
<li class='category'><a href='/categories/functional-programming/'>Functional Programming (29)</a></li>
<li class='category'><a href='/categories/funny/'>Funny (9)</a></li>
<li class='category'><a href='/categories/games/'>Games (5)</a></li>
<li class='category'><a href='/categories/google/'>Google (10)</a></li>
<li class='category'><a href='/categories/guest-posts/'>Guest posts (1)</a></li>
<li class='category'><a href='/categories/howto/'>HOWTO (18)</a></li>
<li class='category'><a href='/categories/hardware/'>Hardware (9)</a></li>
<li class='category'><a href='/categories/haskell/'>Haskell (20)</a></li>
<li class='category'><a href='/categories/life/'>Life (2)</a></li>
<li class='category'><a href='/categories/linux/'>Linux (10)</a></li>
<li class='category'><a href='/categories/mac-os/'>Mac OS (3)</a></li>
<li class='category'><a href='/categories/merb/'>Merb (1)</a></li>
<li class='category'><a href='/categories/mercurial/'>Mercurial (3)</a></li>
<li class='category'><a href='/categories/microsoft/'>Microsoft (18)</a></li>
<li class='category'><a href='/categories/miscellaneous/'>Miscellaneous (56)</a></li>
<li class='category'><a href='/categories/mono/'>Mono (2)</a></li>
<li class='category'><a href='/categories/networks/'>Networks (2)</a></li>
<li class='category'><a href='/categories/nosql/'>NoSQL (3)</a></li>
<li class='category'><a href='/categories/oauth/'>OAuth (1)</a></li>
<li class='category'><a href='/categories/open-source/'>Open Source (2)</a></li>
<li class='category'><a href='/categories/privacy/'>Privacy (3)</a></li>
<li class='category'><a href='/categories/productivity/'>Productivity (1)</a></li>
<li class='category'><a href='/categories/project-euler/'>Project Euler (11)</a></li>
<li class='category'><a href='/categories/protip/'>Protip (1)</a></li>
<li class='category'><a href='/categories/rce/'>RCE (4)</a></li>
<li class='category'><a href='/categories/riak/'>Riak (7)</a></li>
<li class='category'><a href='/categories/ruby-on-rails/'>Ruby on Rails (1)</a></li>
<li class='category'><a href='/categories/screencasts/'>Screencasts (1)</a></li>
<li class='category'><a href='/categories/security/'>Security (13)</a></li>
<li class='category'><a href='/categories/series/'>Series (1)</a></li>
<li class='category'><a href='/categories/shortcuts/'>Shortcuts (4)</a></li>
<li class='category'><a href='/categories/smashthestack-io/'>SmashTheStack-IO (1)</a></li>
<li class='category'><a href='/categories/software/'>Software (31)</a></li>
<li class='category'><a href='/categories/software-development/'>Software Development (66)</a></li>
<li class='category'><a href='/categories/sorting/'>Sorting (5)</a></li>
<li class='category'><a href='/categories/technology/'>Technology (40)</a></li>
<li class='category'><a href='/categories/testing/'>Testing (1)</a></li>
<li class='category'><a href='/categories/tips-tricks/'>Tips/Tricks (12)</a></li>
<li class='category'><a href='/categories/twitter/'>Twitter (2)</a></li>
<li class='category'><a href='/categories/wpf/'>WPF (1)</a></li>
<li class='category'><a href='/categories/wtf/'>WTF (20)</a></li>
<li class='category'><a href='/categories/webmachine/'>Webmachine (7)</a></li>
<li class='category'><a href='/categories/windows/'>Windows (12)</a></li>
<li class='category'><a href='/categories/xss/'>XSS (1)</a></li>

  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
Copyright &copy; 2013 -
<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Blog content for OJ's rants</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://buffered.io/+" property="cc:attributionName" rel="cc:attributionURL">OJ Reeves</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a> -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ojsrants';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://buffered.io/posts/safer-code-through-object-orientation/';
        var disqus_url = 'http://buffered.io/posts/safer-code-through-object-orientation/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
